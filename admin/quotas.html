<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Адмінка квот — Ваш Адмін</title>
  <link rel="stylesheet" href="../styles.css" />
  <style>
    :root { --seat: 22px; --gap: 4px; }
    @media (min-width: 900px){ :root { --seat: 26px; --gap: 6px; } }

    body { background:#f4f5f7; }

    header.header {
      background:#ffffff;
      border-bottom:1px solid #e5e7eb;
      padding:8px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    .header .logo { font-weight:700; text-decoration:none; color:#111827; }
    .header .nav-link { margin-left:12px; text-decoration:none; color:#374151; }
    .header .nav-link:hover { color:#111827; }

    .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:12px;margin-top:12px}
    .muted{color:#6b7280}
    .row-grid{display:grid; gap:10px}
    .row-grid.two{grid-template-columns:1fr 1fr}
    @media (max-width:800px){ .row-grid.two{grid-template-columns:1fr} }

    .toolbar{display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin:12px 0}

    .hall{display:grid; gap:var(--gap); justify-content:flex-start;
          grid-template-columns: repeat(var(--cols, 10), var(--seat));
          transform-origin: top left; }
    .seat{width:var(--seat);height:var(--seat);border-radius:6px;background:#e5e7eb;
          display:flex;align-items:center;justify-content:center;cursor:pointer;
          font-weight:700;font-size:12px;user-select:none}
    .spacer{width:var(--seat);height:var(--seat);opacity:0;pointer-events:none}
    .rowlabel{grid-column:1/-1;text-align:center;color:#666;margin-top:4px;font-size:12px}

    .seat-base{background:#f3f4f6}
    .seat-quota{background:#facc15}    /* квота (жёлтые) */
    .seat-selected{outline:2px solid #10b981; box-shadow: 0 0 0 2px #10b981 inset}

    textarea{width:100%;min-height:160px;border:1px solid #e5e7eb;border-radius:10px;
             padding:10px;font-family:ui-monospace, SFMono-Regular, Menlo, monospace}
    input[type=text]{height:40px;border:1px solid #e5e7eb;border-radius:10px;padding:0 10px;width:100%}
    select{height:40px;border:1px solid #e5e7eb;border-radius:10px;padding:0 10px}

    .scene{margin:6px auto 12px; text-align:center; font-weight:700; color:#666}
    .chip{display:inline-flex;align-items:center;gap:6px;border:1px solid #e5e7eb;
          border-radius:999px;padding:4px 10px;font-size:13px}
    code.inline{background:#f3f4f6;border:1px solid #e5e7eb;border-radius:6px;padding:2px 6px}
    .error{color:#b91c1c;margin-top:8px}
  </style>
</head>
<body>
<header class="header">
  <a href="../index.html" class="logo">Ваш Адмін</a>
  <nav class="nav">
    <a href="../afisha.html" class="nav-link">Афіша</a>
    <a href="../theatres.html" class="nav-link">Театри</a>
    <a href="../about.html" class="nav-link">Про нас</a>
  </nav>
</header>

<main class="container">
  <h1>Адмінка квот (генератор для QUOTAS)</h1>

  <div class="card row-grid two">
    <div>
      <label class="muted">
        Slug вистави (як в <code class="inline">afisha.json</code>, напр.
        <code class="inline">shevchenko/za-dvoma-zaytsiamy</code>)
      </label>
      <input id="slug" type="text" placeholder="shevchenko/za-dvoma-zaytsiamy">
    </div>
    <div>
      <label class="muted">Майданчик (зал)</label>
      <select id="theatre">
        <option value="shevchenko">Театр ім. Шевченка (велика сцена)</option>
        <option value="academy" disabled>Академія руху (пізніше)</option>
      </select>
      <p class="muted" style="margin:6px 0 0;font-size:13px">
        Поки що працюємо лише з великою сценою Шевченка.
      </p>
    </div>
    <div class="toolbar" style="grid-column:1/-1">
      <button id="loadHall" class="btn">Завантажити схему залу</button>
      <button id="clearSel" class="btn secondary">Очистити виділення</button>
      <div class="chip">
        Вибрано місць: <strong id="selCount">0</strong>
      </div>
    </div>
  </div>

  <div id="err" class="error" style="display:none"></div>

  <div class="card">
    <div class="scene">СЦЕНА</div>
    <div id="hall" class="hall"></div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 8px">Фрагмент для вставки у <code class="inline">QUOTAS</code> (файл <code class="inline">spectacles/hall.html</code>)</h3>
    <p class="muted" style="margin:6px 0 10px">
      Скопіюйте цей блок і вставте в об’єкт <code class="inline">const QUOTAS = { ... }</code>.
    </p>
    <textarea id="out" readonly></textarea>
    <div class="toolbar">
      <button id="copyOut" class="btn">Скопіювати</button>
    </div>
    <p class="muted" style="margin-top:6px;font-size:13px">
      Цей інструмент <strong>нічого сам не змінює</strong> на сайті — зміни
      з’являться лише після того, як ти вручну вставиш фрагмент у <code class="inline">hall.html</code>.
    </p>
  </div>
</main>

<footer class="site-footer">
  <div class="container footer-grid">
    <div>© 2025 Ваш Адмін</div>
  </div>
  <div class="footer-bottom">Продаж квитків за ціною каси театру</div>
</footer>

<script>
(function(){
  const slugEl      = document.getElementById('slug');
  const theatreEl   = document.getElementById('theatre');
  const loadBtn     = document.getElementById('loadHall');
  const clearBtn    = document.getElementById('clearSel');
  const hallEl      = document.getElementById('hall');
  const outEl       = document.getElementById('out');
  const selCountEl  = document.getElementById('selCount');
  const errEl       = document.getElementById('err');
  const copyBtn     = document.getElementById('copyOut');

  // hall config
  let hallConfig = null;
  // selected seats: key "row-seat" (наприклад "3-6")
  let selected = new Set();
  // ширина сітки
  let cols = 0;

  const HALL_URLS = {
    shevchenko: '../data/hall/shevchenko/velyka.json',
    academy:    '../data/hall/academy/academy.json'  // про запас
  };

  function showErr(msg){
    errEl.textContent = msg;
    errEl.style.display = 'block';
  }
  function hideErr(){
    errEl.textContent = '';
    errEl.style.display = 'none';
  }

  function computeSeatPrice(rowCfg, seatNumber){
    if (!rowCfg || !Array.isArray(rowCfg.zones)) return 0;
    const z = rowCfg.zones.find(
      z => seatNumber >= z.from && seatNumber <= z.to
    );
    return z ? Number(z.price || 0) : 0;
  }

  function rebuildOutput(){
    const slug = (slugEl.value || '').trim();
    if (!slug || !hallConfig) {
      outEl.value = '';
      selCountEl.textContent = selected.size.toString();
      return;
    }

    // групуємо по рядах
    const byRow = new Map();
    selected.forEach(key => {
      const [r, s] = key.split('-').map(Number);
      if (!byRow.has(r)) byRow.set(r, []);
      byRow.get(r).push(s);
    });

    // робимо діапазони from–to з однаковою ціною
    const ranges = [];
    byRow.forEach((seats, rowNum) => {
      seats.sort((a,b)=>a-b);
      const rowCfg = hallConfig.rows.find(r => r.row === rowNum);
      let i = 0;
      while (i < seats.length){
        let start = seats[i];
        let end   = seats[i];
        let price = computeSeatPrice(rowCfg, start);
        i++;
        while (i < seats.length){
          const next = seats[i];
          const nextPrice = computeSeatPrice(rowCfg, next);
          if (next === end + 1 && nextPrice === price){
            end = next;
            i++;
          } else {
            break;
          }
        }
        ranges.push({ row: rowNum, from: start, to: end, price });
      }
    });

    // сортуємо по ряду/початку
    ranges.sort((a,b)=> a.row === b.row ? a.from - b.from : a.row - b.row);

    const lines = ranges.map(r =>
      `  { row: ${r.row}, from: ${r.from}, to: ${r.to}, price: ${r.price} }`
    );

    const snippet =
      `"${slug}": [\n` +
      lines.join(',\n') +
      `\n],`;

    outEl.value = snippet;
    selCountEl.textContent = selected.size.toString();
  }

  function spacer(){
    const d = document.createElement('div');
    d.className = 'spacer';
    return d;
  }

  function renderHall(){
    hallEl.innerHTML = '';
    if (!hallConfig || !Array.isArray(hallConfig.rows)){
      showErr('Не вдалося завантажити схему залу.');
      return;
    }
    hideErr();

    const rows = hallConfig.rows.slice().sort((a,b)=>a.row - b.row);
    cols = Math.max(...rows.map(r => r.seats + (Array.isArray(r.aisles) ? r.aisles.length : 0)));
    hallEl.style.setProperty('--cols', cols);

    rows.forEach(rowCfg => {
      const rowNum = rowCfg.row;
      const seatsCount = rowCfg.seats;
      const aisles = Array.isArray(rowCfg.aisles) ? rowCfg.aisles.slice().sort((a,b)=>a-b) : [];
      let nextA = 0;

      for (let s = 1; s <= seatsCount; s++){
        while (nextA < aisles.length && (s === aisles[nextA] + 1)){
          hallEl.appendChild(spacer());
          nextA++;
        }

        const key = `${rowNum}-${s}`;
        const price = computeSeatPrice(rowCfg, s);

        const el = document.createElement('div');
        el.className = 'seat seat-base';
        el.textContent = s.toString();
        el.title = `Ряд ${rowNum}, місце ${s}${price ? ' — ' + price + ' грн' : ''}`;

        if (selected.has(key)){
          el.classList.add('seat-quota');
        }

        el.addEventListener('click', () => {
          if (selected.has(key)){
            selected.delete(key);
            el.classList.remove('seat-quota');
          } else {
            selected.add(key);
            el.classList.add('seat-quota');
          }
          rebuildOutput();
        });

        hallEl.appendChild(el);
      }
      while (nextA < aisles.length){
        hallEl.appendChild(spacer());
        nextA++;
      }

      const rl = document.createElement('div');
      rl.className = 'rowlabel';
      const basePrice = computeSeatPrice(rowCfg, 1);
      rl.textContent = basePrice
        ? `Ряд ${rowNum} • базова ціна ${basePrice} грн`
        : `Ряд ${rowNum}`;
      hallEl.appendChild(rl);
    });

    fitWidth();
    setTimeout(fitWidth, 150);
    window.addEventListener('resize', fitWidth);
  }

  function fitWidth(){
    if (!cols) return;
    const container = hallEl.parentElement;
    const padding = 24;
    const seat = Math.floor((container.clientWidth - padding) / cols);
    if (seat >= 16){
      document.documentElement.style.setProperty('--seat', Math.min(56, seat) + 'px');
    }
  }

  async function loadHall(){
    hideErr();
    selected.clear();
    rebuildOutput();

    const theatreKey = theatreEl.value || 'shevchenko';
    const url = HALL_URLS[theatreKey];
    if (!url){
      showErr('Невідомий майданчик.');
      return;
    }

    try{
      const resp = await fetch(url, { cache: 'no-store' });
      if (!resp.ok) throw new Error('HTTP ' + resp.status);
      hallConfig = await resp.json();
      renderHall();
      rebuildOutput();
    }catch(e){
      console.error(e);
      showErr('Помилка завантаження залу: ' + e.message);
    }
  }

  // события
  loadBtn.addEventListener('click', loadHall);
  clearBtn.addEventListener('click', () => {
    selected.clear();
    renderHall();
    rebuildOutput();
  });

  copyBtn.addEventListener('click', () => {
    outEl.select();
    document.execCommand('copy');
  });

  // если пришли с ?show=...
  const qp = new URLSearchParams(location.search);
  const initialSlug = qp.get('show');
  if (initialSlug){
    slugEl.value = initialSlug;
  }
})();
</script>
</body>
</html>
