<script>
/* ====== КОНФИГУРАЦИЯ ЗАЛОВ ====== */

const urlp = new URLSearchParams(location.search);
const show = (urlp.get('show') || '').trim();

// ВАЖНО: сюда вставьте рабочий endpoint, который возвращает LiqPay-параметры
// (JSON с fields: {action, amount, currency, description, public_key, data, signature, sandbox} и т.п.)
// Пока пусто — код мягко покажет предупреждение и не упадёт.
const LIQPAY_INIT_URL = ''; // <-- ВСТАВИТЕ СЮДА ваш реальный URL (Cloudflare/AppsScript/Backend)

// ---- Шевченко (родная 18×20) ----
const HALL_SHEVCHENKO = {
  rows: 18,
  seatsPerRow: 20,
  priceForRow(row) {
    if (row <= 1)  return 170;
    if (row <= 2)  return 200;
    if (row <= 3)  return 200;
    if (row <= 4)  return 180;
    if (row <= 5)  return 180;
    if (row <= 6)  return 180;
    if (row <= 7)  return 170;
    if (row <= 8)  return 170;
    if (row <= 9)  return 160;
    if (row <=10)  return 160;
    if (row <=11)  return 140;
    if (row <=12)  return 140;
    if (row <=13)  return 120;
    if (row <=14)  return 120;
    if (row <=15)  return 100;
    if (row <=16)  return 100;
    if (row <=17)  return 70;
    return 70; // 18
  },
  // проход после 10-го места
  passAfterSeat: 10,
  // увеличенный вертикальный проход перед 18-м рядом (между 17 и 18)
  bigGapAfterRow: 17,
  // центрирование ряда не требуется
  firstRowOffset: 0
};

// ---- Академия руху ----
// 18 рядов, в 1-м ряду 11 мест (по вашей схеме), центрируем,
// проходы между рядами больше, и доп. проход между 17 и 18.
const HALL_ACADEMY = {
  rows: 18,
  seatsPerRow: 23,         // базовая ширина сетки
  passAfterSeat: 10,       // основной проход
  bigGapAfterRow: 17,      // большой вертикальный проход между 17 и 18
  firstRowOffset: 6,       // сдвиг 1-го ряда (чтобы 11 мест легли по центру)
  // цены на весь зал (как просили: «скорее всего будем весь зал продавать»).
  // Если нужно градации — дайте срез, быстро разобьём по зонам.
  priceForRow(row) {
    // пример: чуть дороже центр, иначе одинаково
    if (row >= 8 && row <= 13) return 180;
    if (row <= 7)              return 160;
    if (row <= 17)             return 150;
    return 120; // 18
  },
  // в каких рядах мест меньше/иначе:
  // 1 ряд – 11 мест, колонки 7..17 (с учётом seatsPerRow=23 и firstRowOffset)
  customRowSeats(row) {
    if (row === 1) return { count: 11 }; // отцентрируем через firstRowOffset
    return null;
  }
};

// Определяем конфиг по спектаклю
function pickHallConfig(showSlug) {
  if (showSlug.startsWith('shevchenko/')) return HALL_SHEVCHENKO;
  if (showSlug.startsWith('academy/')    || showSlug.startsWith('akademia/')) return HALL_ACADEMY;
  // дефолт — шевченко
  return HALL_SHEVCHENKO;
}

/* ====== РЕНДЕР ====== */

const hallRoot = document.getElementById('hall-root') || (() => {
  const d = document.createElement('div');
  d.id = 'hall-root';
  document.body.appendChild(d);
  return d;
})();

const formName  = document.getElementById('cust-name');
const formPhone = document.getElementById('cust-phone');
const formEmail = document.getElementById('cust-email');
const goPayBtn  = document.getElementById('pay-btn');

const totalBox  = document.getElementById('total-box');

const CFG = pickHallConfig(show);
const selected = new Set();

function seatKey(row, seat) { return `${row}:${seat}`; }

function renderHall() {
  hallRoot.innerHTML = '';
  hallRoot.className = 'hall-grid';
  hallRoot.style.setProperty('--row-gap', '14px');
  hallRoot.style.setProperty('--row-gap-lg', '28px');

  for (let r = 1; r <= CFG.rows; r++) {
    const rowWrap = document.createElement('div');
    rowWrap.className = 'row';

    // большой вертикальный проход перед следующей строкой
    if (CFG.bigGapAfterRow && r === CFG.bigGapAfterRow) {
      rowWrap.classList.add('row-big-gap');
    }

    // количество мест в ряду (для Академии 1-й ряд = 11)
    let seatsThisRow = CFG.seatsPerRow;
    const custom = CFG.customRowSeats ? CFG.customRowSeats(r) : null;
    if (custom && custom.count) seatsThisRow = custom.count;

    // смещение начала (для центрирования 1-го ряда Академии)
    let offset = 0;
    if (CFG.firstRowOffset && r === 1) offset = CFG.firstRowOffset;

    // «пустые» ячейки слева для центрирования
    for (let k = 0; k < offset; k++) {
      const stub = document.createElement('span');
      stub.className = 'stub';
      rowWrap.appendChild(stub);
    }

    for (let s = 1; s <= seatsThisRow; s++) {
      // проход после N-го места
      if (CFG.passAfterSeat && s === CFG.passAfterSeat + 1) {
        const aisle = document.createElement('span');
        aisle.className = 'aisle';
        rowWrap.appendChild(aisle);
      }

      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'seat';
      btn.textContent = s;
      btn.dataset.price = CFG.priceForRow(r);
      btn.dataset.row = r;
      btn.dataset.seat = s;
      btn.addEventListener('click', onToggleSeat);
      rowWrap.appendChild(btn);
    }

    // добиваем до общей ширины (только для Академии, чтобы сетка была ровной)
    const totalCols = Math.max(CFG.seatsPerRow, (offset + seatsThisRow + (CFG.passAfterSeat ? 1 : 0)));
    const fill = CFG.seatsPerRow - (offset + seatsThisRow + (CFG.passAfterSeat ? 1 : 0));
    if (fill > 0) {
      for (let f = 0; f < fill; f++) {
        const stub = document.createElement('span');
        stub.className = 'stub';
        rowWrap.appendChild(stub);
      }
    }

    hallRoot.appendChild(rowWrap);
  }

  updateTotal();
}

function onToggleSeat(e) {
  const btn = e.currentTarget;
  const r = +btn.dataset.row;
  const s = +btn.dataset.seat;
  const k = seatKey(r, s);
  if (selected.has(k)) {
    selected.delete(k);
    btn.classList.remove('picked');
  } else {
    selected.add(k);
    btn.classList.add('picked');
  }
  updateTotal();
}

function updateTotal() {
  let sum = 0;
  selected.forEach(k => {
    const [r, s] = k.split(':').map(Number);
    sum += CFG.priceForRow(r);
  });
  totalBox.textContent = `Вибрано місць: ${selected.size} • Сума: ${sum} грн`;
}

/* ====== ОПЛАТА (мягкая) ====== */

async function startPay() {
  if (!selected.size) {
    alert('Спочатку виберіть місця.');
    return;
  }
  const name  = (formName?.value || '').trim();
  const phone = (formPhone?.value || '').trim();
  const email = (formEmail?.value || '').trim();
  if (!phone) {
    alert('Вкажіть телефон, будь ласка.');
    return;
  }

  const seats = Array.from(selected).sort();
  const amount = (() => {
    let sum = 0;
    seats.forEach(k => {
      const row = +k.split(':')[0];
      sum += CFG.priceForRow(row);
    });
    return sum;
  })();

  // Если не настроен backend — не падаем, а говорим что нужно вставить URL
  if (!LIQPAY_INIT_URL) {
    alert('Оплата тимчасово не підключена.\nВставте URL ініціалізації LiqPay у константу LIQPAY_INIT_URL у hall.html.');
    return;
  }

  goPayBtn.disabled = true;

  try {
    const payload = {
      show,
      seats,
      name, phone, email,
      amount,
      currency: 'UAH'
    };

    const resp = await fetch(LIQPAY_INIT_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
      mode: 'cors'
    });

    if (!resp.ok) throw new Error('LiqPay init failed: ' + resp.status);
    const data = await resp.json();

    // 2 вариантов: либо открываем готовый invoiceUrl, либо рендерим форму iFrame.
    if (data.invoiceUrl) {
      window.location.href = data.invoiceUrl;
      return;
    }

    if (data.action && data.data && data.signature) {
      // создаём форму и сабмитим (классический LiqPay checkout)
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = 'https://www.liqpay.ua/api/3/checkout';
      form.target = '_self';

      const add = (n,v) => {
        const i = document.createElement('input');
        i.type = 'hidden';
        i.name = n;
        i.value = v;
        form.appendChild(i);
      };
      add('data',      data.data);
      add('signature', data.signature);

      document.body.appendChild(form);
      form.submit();
      return;
    }

    alert('Відповідь LiqPay не впізнана. Перевірте backend.');

  } catch (err) {
    console.error(err);
    alert('Не вдалося ініціалізувати оплату. Перевірте URL LiqPay та CORS.');
  } finally {
    goPayBtn.disabled = false;
  }
}

document.getElementById('pay-btn')?.addEventListener('click', startPay);

// Стартовый рендер
renderHall();
</script>
