<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <title>Вибір місць</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="../styles.css">
</head>
<body>
<header class="site-header">
  <div class="container header-inner">
    <a href="../index.html" class="logo">Ваш Адмін</a>
    <nav class="nav">
      <a href="../index.html">Афіша</a>
      <a href="../theatres.html">Театри</a>
      <a href="../contacts.html">Контакти</a>
    </nav>
  </div>
</header>

<main class="container main">
  <h1>Вибір місць</h1>

  <!-- легенда -->
  <div style="margin-bottom: 12px;">
    <label><input type="radio" checked disabled> вільно</label>
    <label style="margin-left:12px;"><input type="radio" checked disabled> вибрано</label>
    <label style="margin-left:12px;"><input type="radio" disabled> недоступно</label>
  </div>

  <!-- блок зало -->
  <div class="hall-wrapper">
    <div id="hall-stage" class="hall-stage">Сцена</div>
    <div id="hall-rows" class="hall-rows"></div>
  </div>

  <!-- підсумок вибору -->
  <p id="selection-summary">Вибрано місць: 0 • Сума: 0 грн</p>

  <!-- форма покупця -->
  <section class="card">
    <h2>Дані покупця</h2>

    <div class="form-row">
      <input id="buyer-name" class="form-control" placeholder="Ім’я та прізвище">
    </div>
    <div class="form-row">
      <input id="buyer-phone" class="form-control" placeholder="+380…">
    </div>
    <div class="form-row">
      <input id="buyer-email" class="form-control" placeholder="you@example.com">
    </div>

    <button id="pay-btn" class="button-primary">Перейти до оплати</button>

    <div id="error-box" class="error-box" style="display:none; margin-top:14px;"></div>
  </section>

  <!-- футер просто, щоб не ломать верстку -->
  <footer class="site-footer">
    <div class="container footer-grid">
      <div>
        <h3>Контакти</h3>
        <p>ФОП Рябов Олександр Германович</p>
        <p>Email: alexandrryabov@ukr.net</p>
      </div>
    </div>
    <div class="footer-bottom">© 2025 Ваш Адмін — театральні квитки</div>
  </footer>
</main>

<!-- Supabase SDK -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<script>
/*************************************************
 * 1. НАЛАШТУВАННЯ ПРОЄКТУ
 *************************************************/

// ⚠️ СЮДИ ВСТАВ СВОЇ ЗНАЧЕННЯ З SUPABASE
const SUPABASE_URL = 'https://yqhzekifwxotizsmaeaf.supabase.co';          // Project URL
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlxaHpla2lmd3hvdGl6c21hZWFmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEyMzQyNjgsImV4cCI6MjA3NjgxMDI2OH0.lUoppCppKZisZdyOrreCov_-xEOCvGuwxd28XZY4O_k';                       // anon public key
const LIQPAY_FN_URL = 'https://yqhzekifwxotizsmaeaf.supabase.co/functions/v1/liqpay-create-index-ts';

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// який спектакль / театр відкритий
const params = new URLSearchParams(window.location.search);
const showSlug = params.get('show') || 'shevchenko/za-dvoma-zaytsiamy';

// допоміжний прапорець: академія чи шевченко
const isAcademy = showSlug.startsWith('academy');

/*************************************************
 * 2. СХЕМИ ЗАЛІВ (академія / шевченко)
 *************************************************/

// Академія руху — велика сцена
const ACADEMY_HALL = {
  name: 'Велика сцена (Академія руху)',
  rows: [
    { row: 1,  seats: 11, offset: 0, aisles: [], zones: [{ from: 1, to: 11, price: 220 }] },

    { row: 2, seats: 23, aisles: [6,17], zones: [
      { from: 1,  to: 6,  price: 160 },
      { from: 7,  to: 17, price: 200 },
      { from: 18, to: 23, price: 160 }
    ]},
    { row: 3, seats: 23, aisles: [6,17], zones: [
      { from: 1,  to: 6,  price: 160 },
      { from: 7,  to: 17, price: 200 },
      { from: 18, to: 23, price: 160 }
    ]},
    { row: 4, seats: 23, aisles: [6,17], zones: [
      { from: 1,  to: 6,  price: 160 },
      { from: 7,  to: 17, price: 200 },
      { from: 18, to: 23, price: 160 }
    ]},
    { row: 5, seats: 23, aisles: [6,17], zones: [
      { from: 1,  to: 6,  price: 160 },
      { from: 7,  to: 17, price: 200 },
      { from: 18, to: 23, price: 160 }
    ]},
    { row: 6, seats: 23, aisles: [6,17], zones: [
      { from: 1,  to: 6,  price: 160 },
      { from: 7,  to: 17, price: 200 },
      { from: 18, to: 23, price: 160 }
    ], gapAfter: true },

    { row: 7, seats: 23, aisles: [6,17], zones: [
      { from: 1,  to: 6,  price: 150 },
      { from: 7,  to: 17, price: 190 },
      { from: 18, to: 23, price: 150 }
    ]},

    { row: 8, seats: 23, aisles: [6,17], zones: [
      { from: 1,  to: 6,  price: 140 },
      { from: 7,  to: 9,  price: 160 },
      { from: 10, to: 14, price: 180 },
      { from: 15, to: 17, price: 160 },
      { from: 18, to: 23, price: 140 }
    ]},
    { row: 9, seats: 23, aisles: [6,17], zones: [
      { from: 1,  to: 6,  price: 140 },
      { from: 7,  to: 9,  price: 160 },
      { from: 10, to: 14, price: 180 },
      { from: 15, to: 17, price: 160 },
      { from: 18, to: 23, price: 140 }
    ]},
    { row: 10, seats: 23, aisles: [6,17], zones: [
      { from: 1,  to: 6,  price: 140 },
      { from: 7,  to: 9,  price: 160 },
      { from: 10, to: 14, price: 180 },
      { from: 15, to: 17, price: 160 },
      { from: 18, to: 23, price: 140 }
    ]},
    { row: 11, seats: 23, aisles: [6,17], zones: [
      { from: 1,  to: 6,  price: 140 },
      { from: 7,  to: 9,  price: 160 },
      { from: 10, to: 14, price: 180 },
      { from: 15, to: 17, price: 160 },
      { from: 18, to: 23, price: 140 }
    ]},
    { row: 12, seats: 23, aisles: [6,17], zones: [
      { from: 1,  to: 6,  price: 140 },
      { from: 7,  to: 9,  price: 160 },
      { from: 10, to: 14, price: 180 },
      { from: 15, to: 17, price: 160 },
      { from: 18, to: 23, price: 140 }
    ]},
    { row: 13, seats: 23, aisles: [6,17], zones: [
      { from: 1,  to: 6,  price: 140 },
      { from: 7,  to: 9,  price: 160 },
      { from: 10, to: 14, price: 180 },
      { from: 15, to: 17, price: 160 },
      { from: 18, to: 23, price: 140 }
    ]},

    { row: 14, seats: 23, aisles: [6,17], zones: [{ from: 1, to: 23, price: 130 }] },
    { row: 15, seats: 23, aisles: [6,17], zones: [{ from: 1, to: 23, price: 130 }] },
    { row: 16, seats: 23, aisles: [6,17], zones: [{ from: 1, to: 23, price: 130 }], gapAfter: true },

    { row: 17, seats: 23, aisles: [6,17], zones: [{ from: 1, to: 23, price: 120 }], gapAfter: true },
    { row: 18, seats: 20, aisles: [10], zones: [{ from: 1, to: 20, price: 110 }] }
  ]
};

// Шевченка — велика сцена
const SHEVCHENKO_HALL = {
  name: 'Велика сцена (Театр ім. Шевченка)',
  rows: [
    { row: 1,  seats: 20, aisles: [10], zones: [{ from: 1, to: 20, price: 170 }] },
    { row: 2,  seats: 20, aisles: [10], zones: [{ from: 1, to: 20, price: 200 }] },
    { row: 3,  seats: 20, aisles: [10], zones: [{ from: 1, to: 20, price: 200 }] },
    { row: 4,  seats: 20, aisles: [10], zones: [{ from: 1, to: 20, price: 180 }] },
    { row: 5,  seats: 20, aisles: [10], zones: [{ from: 1, to: 20, price: 180 }] },
    { row: 6,  seats: 20, aisles: [10], zones: [{ from: 1, to: 20, price: 180 }] },
    { row: 7,  seats: 20, aisles: [10], zones: [{ from: 1, to: 20, price: 170 }] },
    { row: 8,  seats: 20, aisles: [10], zones: [{ from: 1, to: 20, price: 170 }] },
    { row: 9,  seats: 20, aisles: [10], zones: [{ from: 1, to: 20, price: 160 }] },
    { row: 10, seats: 20, aisles: [10], zones: [{ from: 1, to: 20, price: 160 }] },
    { row: 11, seats: 20, aisles: [10], zones: [{ from: 1, to: 20, price: 140 }] },
    { row: 12, seats: 20, aisles: [10], zones: [{ from: 1, to: 20, price: 140 }] },
    { row: 13, seats: 20, aisles: [10], zones: [{ from: 1, to: 20, price: 120 }] },
    { row: 14, seats: 20, aisles: [10], zones: [{ from: 1, to: 20, price: 120 }] },
    { row: 15, seats: 20, aisles: [10], zones: [{ from: 1, to: 20, price: 100 }] },
    { row: 16, seats: 20, aisles: [10], zones: [{ from: 1, to: 20, price: 100 }] },
    { row: 17, seats: 20, aisles: [10], zones: [{ from: 1, to: 20, price: 70 }] },
    { row: 18, seats: 20, aisles: [10], zones: [{ from: 1, to: 20, price: 70 }] }
  ]
};

const HALL = isAcademy ? ACADEMY_HALL : SHEVCHENKO_HALL;

/*************************************************
 * 3. ОТРИСОВКА ЗАЛУ
 *************************************************/

const hallRowsEl = document.getElementById('hall-rows');
const hallStageEl = document.getElementById('hall-stage');
hallStageEl.textContent = HALL.name;

const selected = new Set();
const taken = new Set();

function seatCode(row, seat) {
  // формат такой же, как был в тестах: P<ряд>-M<місце>
  return `P${row}-M${seat}`;
}

function getSeatPrice(rowConfig, seatNum) {
  if (!rowConfig.zones) return 0;
  for (const z of rowConfig.zones) {
    if (seatNum >= z.from && seatNum <= z.to) return z.price;
  }
  return 0;
}

function updateSummary() {
  let total = 0;
  const codes = Array.from(selected);

  for (const code of codes) {
    const mRow = code.match(/^P(\d+)-M(\d+)$/);
    if (!mRow) continue;
    const rowNum = Number(mRow[1]);
    const seatNum = Number(mRow[2]);
    const rowCfg = HALL.rows.find(r => r.row === rowNum);
    if (!rowCfg) continue;
    total += getSeatPrice(rowCfg, seatNum);
  }

  const summary = document.getElementById('selection-summary');
  summary.textContent = `Вибрано місць: ${codes.length} • Сума: ${total} грн`;
  return { count: codes.length, total };
}

function renderHall() {
  hallRowsEl.innerHTML = '';

  for (const rowCfg of HALL.rows) {
    const rowWrapper = document.createElement('div');
    rowWrapper.className = 'hall-row';
    if (rowCfg.gapAfter) rowWrapper.classList.add('row-break-lg');

    const label = document.createElement('div');
    label.className = 'hall-row-label';
    label.textContent = `Ряд ${rowCfg.row}`;
    rowWrapper.appendChild(label);

    const rowSeats = document.createElement('div');
    rowSeats.className = 'hall-row-seats';

    const aisles = new Set(rowCfg.aisles || []);

    for (let seat = 1; seat <= rowCfg.seats; seat++) {
      const code = seatCode(rowCfg.row, seat);
      const price = getSeatPrice(rowCfg, seat);

      const btn = document.createElement('button');
      btn.type = 'button';
      btn.textContent = seat;
      btn.className = 'hall-seat';
      btn.dataset.code = code;
      btn.dataset.price = price;

      if (taken.has(code)) {
        btn.classList.add('taken');
        btn.disabled = true;
      }

      btn.addEventListener('click', () => {
        if (btn.classList.contains('taken')) return;

        if (selected.has(code)) {
          selected.delete(code);
          btn.classList.remove('selected');
        } else {
          selected.add(code);
          btn.classList.add('selected');
        }
        updateSummary();
      });

      rowSeats.appendChild(btn);

      if (aisles.has(seat) && seat !== rowCfg.seats) {
        const gap = document.createElement('div');
        gap.className = 'hall-aisle';
        rowSeats.appendChild(gap);
      }
    }

    rowWrapper.appendChild(rowSeats);
    hallRowsEl.appendChild(rowWrapper);

    if (rowCfg.gapAfter) {
      const gapRow = document.createElement('div');
      gapRow.className = 'hall-row-gap';
      hallRowsEl.appendChild(gapRow);
    }
  }

  updateSummary();
}

/*************************************************
 * 4. ЗАГРУЗКА ЗАНЯТЫХ МЕСТ ІЗ SUPABASE (bookings)
 *************************************************/

async function loadTakenSeats() {
  try {
    const { data, error } = await supabase
      .from('bookings') // ВАЖНО: саме "bookings", без public_
      .select('seat_json, status_text')
      .eq('show_slug', showSlug);

    if (error) {
      console.error('loadTakenSeats error', error);
      return;
    }

    (data || []).forEach(row => {
      const arr = row.seat_json || [];
      arr.forEach(code => taken.add(code));
    });
  } catch (e) {
    console.error('loadTakenSeats exception', e);
  }
}

/*************************************************
 * 5. ЗБЕРЕЖЕННЯ ЗАМОВЛЕННЯ В orders
 *************************************************/

async function saveOrderToSupabase(order) {
  const { data, error } = await supabase
    .from('orders') // ВАЖНО: "orders", без public_
    .insert(order)
    .select()
    .single();

  if (error) {
    console.error('saveOrderToSupabase error', error);
    throw error;
  }
  return data;
}

/*************************************************
 * 6. ВИКЛИК EDGE-ФУНКЦІЇ LIQPAY
 *************************************************/

async function createLiqPayCheckout(payload) {
  const res = await fetch(LIQPAY_FN_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });

  if (!res.ok) {
    const text = await res.text().catch(() => '');
    throw new Error('LiqPay function error ' + res.status + ': ' + text);
  }

  return res.json();
}

function showError(msg) {
  const box = document.getElementById('error-box');
  box.textContent = msg;
  box.style.display = 'block';
}

/*************************************************
 * 7. ОБРОБКА КНОПКИ "ПЕРЕЙТИ ДО ОПЛАТИ"
 *************************************************/

document.getElementById('pay-btn').addEventListener('click', async () => {
  const { count, total } = updateSummary();
  const name = document.getElementById('buyer-name').value.trim();
  const phone = document.getElementById('buyer-phone').value.trim();
  const email = document.getElementById('buyer-email').value.trim();

  document.getElementById('error-box').style.display = 'none';

  if (!count) {
    showError('Будь ласка, оберіть хоча б одне місце.');
    return;
  }
  if (!name || !phone || !email) {
    showError('Заповніть, будь ласка, всі поля покупця.');
    return;
  }

  const orderPrefix = isAcademy ? 'AKAD' : 'SHEV';
  const orderId = `${orderPrefix}-${Date.now()}`;

  const seatsArr = Array.from(selected);

  try {
    // 1) пишемо замовлення в orders
    await saveOrderToSupabase({
      order_id: orderId,
      show_slug: showSlug,
      seats_json: seatsArr,
      total_amount: total,
      customer_name: name,
      customer_phone: phone,
      customer_email: email,
      status_text: 'pending'
    });

    // 2) викликаємо edge-функцію LiqPay
    const liqRes = await createLiqPayCheckout({
      order_id: orderId,
      amount: total,
      show_slug: showSlug,
      seats: seatsArr,
      customer_name: name,
      customer_phone: phone,
      customer_email: email
    });

    if (!liqRes || !liqRes.data || !liqRes.signature) {
      console.error('Unexpected LiqPay response', liqRes);
      showError('Помилка під час створення рахунку. Спробуйте ще раз.');
      return;
    }

    // 3) створюємо й відправляємо форму на LiqPay
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = 'https://www.liqpay.ua/api/3/checkout';

    const inputData = document.createElement('input');
    inputData.type = 'hidden';
    inputData.name = 'data';
    inputData.value = liqRes.data;

    const inputSign = document.createElement('input');
    inputSign.type = 'hidden';
    inputSign.name = 'signature';
    inputSign.value = liqRes.signature;

    form.appendChild(inputData);
    form.appendChild(inputSign);
    document.body.appendChild(form);
    form.submit();
  } catch (e) {
    console.error(e);
    showError('Помилка під час створення рахунку. Спробуйте ще раз або зверніться до адміністратора.');
  }
});

/*************************************************
 * 8. СТАРТ: грузим зайняті місця і малюємо зал
 *************************************************/

(async () => {
  await loadTakenSeats();
  renderHall();
})();
</script>
</body>
</html>
