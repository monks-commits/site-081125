<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Вибір місць — Ваш Адмін</title>
  <link rel="icon" href="data:,">
  <link rel="stylesheet" href="../styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <!-- шапка -->
  <div id="site-header"></div>

  <main class="main" style="max-width:1100px;margin:0 auto;padding:16px">
    <h1>Вибір місць</h1>

    <div id="hall-error" class="alert alert-error" style="display:none;margin:12px 0"></div>

    <div style="display:flex;gap:16px;flex-wrap:wrap;align-items:flex-start">
      <!-- ЛЕВАЯ КОЛОНКА: ЗАЛ -->
      <section style="flex:1;min-width:320px">
        <div class="hall-topbar" style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;margin:8px 0 12px">
          <div>
            <div id="show-title" style="font-weight:700"></div>
            <div id="show-meta" class="muted" style="font-size:14px"></div>
          </div>
          <a class="btn btn-ghost" href="../afisha.html">← Назад до афіші</a>
        </div>

        <!-- ЛЕГЕНДА -->
        <div class="legend" style="display:flex;gap:12px;flex-wrap:wrap;margin:8px 0 12px">
          <div class="legend-item"><span class="legend-dot dot-available"></span> Вільні</div>
          <div class="legend-item"><span class="legend-dot dot-selected"></span> Обрані</div>
          <div class="legend-item"><span class="legend-dot dot-taken"></span> Зайняті</div>
          <div class="legend-item"><span class="legend-dot dot-inactive"></span> Недоступні</div>
        </div>

        <!-- КОНТЕЙНЕР С ЗАЛОМ -->
        <div class="hall-wrap" style="display:flex;gap:16px;align-items:flex-start">
          <!-- ЛЕВАЯ/ПРАВАЯ декоративные ложи (для Шевченко) -->
          <div class="hall-boxes-left"></div>

          <div style="flex:1;min-width:280px">
            <div id="hall-stage" class="hall-stage">СЦЕНА</div>
            <div id="hall" class="hall"></div>
          </div>

          <div class="hall-boxes-right"></div>
        </div>
      </section>

      <!-- ПРАВАЯ КОЛОНКА: ВЫБРАННЫЕ МЕСТА -->
      <aside style="width:340px;min-width:280px">
        <div class="card" style="padding:12px 14px">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
            <div style="font-weight:700">Ваше замовлення</div>
            <button id="clear-btn" class="btn btn-ghost" type="button">Очистити</button>
          </div>

          <div id="selected-list" class="selected-list" style="margin-top:10px"></div>

          <div style="display:flex;justify-content:space-between;align-items:center;margin:12px 0 6px">
            <div class="muted">Разом:</div>
            <div id="total" style="font-weight:800;font-size:18px">0 грн</div>
          </div>

          <hr style="margin:12px 0">

          <form id="buyer-form" class="form" autocomplete="on">
            <div class="form-row">
              <label>Ім’я</label>
              <input id="buyer-name" type="text" required placeholder="Ваше ім’я">
            </div>
            <div class="form-row">
              <label>Телефон</label>
              <input id="buyer-phone" type="tel" required placeholder="+380...">
            </div>
            <div class="form-row">
              <label>Email</label>
              <input id="buyer-email" type="email" required placeholder="name@email.com">
            </div>

            <button id="checkout-btn" class="btn btn-primary" type="submit" style="width:100%;margin-top:10px">
              Перейти до оплати
            </button>

            <div class="muted" style="font-size:12px;margin-top:10px;line-height:1.4">
              Натискаючи «Перейти до оплати», ви підтверджуєте замовлення.
              Квитки (квотні) надсилаємо вручну після оплати.
            </div>
          </form>
        </div>
      </aside>
    </div>
  </main>

  <!-- футер -->
  <div id="site-footer"></div>

  <script>
    // ---------------------------
    // НАСТРОЙКИ SUPABASE (public anon)
    // ---------------------------
    // ВАЖНО: тут должны быть те же переменные, что и в остальных страницах сайта.
    // Если у тебя они подхватываются из settings.json/partials — оставь как есть.
    const SUPABASE_URL = window.SUPABASE_URL || localStorage.getItem('SUPABASE_URL') || "";
    const SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY || localStorage.getItem('SUPABASE_ANON_KEY') || "";

    const supabaseClient = (SUPABASE_URL && SUPABASE_ANON_KEY)
      ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
      : null;

    // ---------------------------
    // ПАРАМЕТРЫ URL
    // ---------------------------
    const urlParams = new URLSearchParams(location.search);
    const showSlug = urlParams.get("show") || "";       // обязательный параметр
    const theatre = urlParams.get("theatre") || "";     // необязательно

    // Куда грузить схему зала
    // Обычно у тебя схемы лежат в /data/halls/<theatre>/<slug>.json или подобное.
    // Здесь оставляем твою исходную логику: если есть showSlug — строим URL по нему.
    // Подстрой под свою структуру, если у тебя иначе.
    let hallDataUrl = "";
    const isShevchenko = (showSlug.startsWith("shevchenko") || theatre === "shevchenko");
    const isAcademy = (showSlug.startsWith("academy") || theatre === "academy");

    if (isShevchenko) {
      // пример: ../data/halls/shevchenko/velyka.json
      hallDataUrl = "../data/halls/shevchenko/velyka.json";
    } else if (isAcademy) {
      hallDataUrl = "../data/halls/academy/velyka.json";
    } else {
      // fallback — если по slug у тебя другая логика, оставь как надо
      hallDataUrl = "../data/halls/academy/velyka.json";
    }

    // ---------------------------
    // DOM
    // ---------------------------
    const hallEl = document.getElementById("hall");
    const totalEl = document.getElementById("total");
    const selectedListEl = document.getElementById("selected-list");
    const clearBtn = document.getElementById("clear-btn");
    const hallErrorEl = document.getElementById("hall-error");

    const buyerForm = document.getElementById("buyer-form");
    const buyerNameEl = document.getElementById("buyer-name");
    const buyerPhoneEl = document.getElementById("buyer-phone");
    const buyerEmailEl = document.getElementById("buyer-email");

    // ---------------------------
    // STATE
    // ---------------------------
    let hallConfig = null;
    let takenSeatIds = new Set(); // занятые (бронь + продано)
    let selected = [];            // массив seatId вида "P14-M7"
    let prices = {};              // seatId -> цена

    function showInlineError(el, msg) {
      if (!el) return;
      el.style.display = "block";
      el.textContent = msg;
    }
    function hideInlineError(el) {
      if (!el) return;
      el.style.display = "none";
      el.textContent = "";
    }

    function formatMoney(n) {
      try { return new Intl.NumberFormat("uk-UA").format(n) + " грн"; }
      catch { return String(n) + " грн"; }
    }

    function seatLabelFromId(seatId) {
      // seatId уже в формате P14-M7 — это и есть наш seat_label
      return seatId;
    }

    function buildSeatId(row, seatNum) {
      return `P${row}-M${seatNum}`;
    }

    // ---------------------------
    // 1) ЗАГРУЗКА ЗАЛА + ЗАНЯТЫЕ МЕСТА (v2)
    // ---------------------------
    async function loadHallAndBookings() {
      try {
        hideInlineError(hallErrorEl);

        // 1) грузим конфиг зала
        const hallResp = await fetch(hallDataUrl, { cache: "no-store" });
        if (!hallResp.ok) throw new Error("Hall not found: " + hallDataUrl);
        hallConfig = await hallResp.json();

        // если showSlug не передан — просто рендерим зал без занятых мест
        if (!showSlug) {
          takenSeatIds = new Set();
          renderHall();
          return;
        }

        if (!supabaseClient) {
          throw new Error("Supabase client is not initialized (URL/KEY missing).");
        }

        // 2) временные брони (только v2)
        let bookingSeatIds = new Set();
        const nowMs = Date.now();

        const { data: bookings, error: bookingsError } = await supabaseClient
          .from("bookings_v2")
          .select("seat_id, expires_at")
          .eq("show_slug", showSlug);

        if (bookingsError) {
          console.warn("bookingsError", bookingsError);
        } else if (bookings && bookings.length) {
          bookings.forEach((b) => {
            if (!b.seat_id) return;
            const expMs = b.expires_at ? Date.parse(b.expires_at) : 0;
            // если expires_at пустой — считаем активной
            if (!b.expires_at || (expMs && expMs > nowMs)) {
              bookingSeatIds.add(b.seat_id);
            }
          });
        }

        // 3) проданные билеты (только v2)
        let soldSeatIds = new Set();

        const { data: tickets, error: ticketsError } = await supabaseClient
          .from("tickets_v2")
          .select("seat_label")
          .eq("show_slug", showSlug);

        if (ticketsError) {
          console.warn("ticketsError", ticketsError);
        } else if (tickets && tickets.length) {
          tickets.forEach((t) => {
            if (!t.seat_label) return;
            soldSeatIds.add(t.seat_label); // формат як у схемі: "P14-M7"
          });
        }

        // 4) объединяем
        takenSeatIds = new Set([...bookingSeatIds, ...soldSeatIds]);

        renderHall();
      } catch (e) {
        console.error(e);
        showInlineError(hallErrorEl, "Помилка завантаження залу: " + e.message);
      }
    }

    // ---------------------------
    // РЕНДЕР ЗАЛА (упрощённый, как у тебя было)
    // ---------------------------
    function renderHall() {
      if (!hallConfig || !hallEl) return;
      hallEl.innerHTML = "";

      // hallConfig.rows ожидается массив { row: N, seats: M, offset?: number, aisles?:[], zones?:[] }
      const rows = hallConfig.rows || [];
      rows.forEach((r) => {
        const rowNum = r.row;
        const seatsCount = r.seats;
        const rowWrap = document.createElement("div");
        rowWrap.className = "hall-row";

        // подпись ряда
        const rowLabel = document.createElement("div");
        rowLabel.className = "hall-row-label";
        rowLabel.textContent = rowNum;
        rowWrap.appendChild(rowLabel);

        // контейнер мест
        const seatsWrap = document.createElement("div");
        seatsWrap.className = "hall-row-seats";

        const offset = Number(r.offset || 0);
        for (let i = 0; i < offset; i++) {
          const sp = document.createElement("span");
          sp.className = "seat spacer";
          seatsWrap.appendChild(sp);
        }

        for (let s = 1; s <= seatsCount; s++) {
          const seatId = buildSeatId(rowNum, s);

          const seatBtn = document.createElement("button");
          seatBtn.type = "button";
          seatBtn.className = "seat";

          const isTaken = takenSeatIds.has(seatId) || takenSeatIds.has(seatLabelFromId(seatId));
          const isSelected = selected.includes(seatId);

          if (isTaken) seatBtn.classList.add("taken");
          if (isSelected) seatBtn.classList.add("selected");

          seatBtn.textContent = s;

          seatBtn.disabled = isTaken;

          seatBtn.addEventListener("click", () => {
            if (seatBtn.disabled) return;
            toggleSeat(seatId);
          });

          seatsWrap.appendChild(seatBtn);
        }

        rowWrap.appendChild(seatsWrap);
        hallEl.appendChild(rowWrap);
      });

      updateSelectedUI();
      renderBoxes(); // декоративные ложи (если нужно)
    }

    // ---------------------------
    // ДЕКОРАТИВНІ ЛОЖІ (как было у тебя)
    // ---------------------------
    function renderBoxes() {
      // Для Академії лож А/Б немає — ховаємо боки й нічого не малюємо
      if (!isShevchenko) {
        const leftWrap  = document.querySelector('.hall-boxes-left');
        const rightWrap = document.querySelector('.hall-boxes-right');
        if (leftWrap)  leftWrap.style.display  = 'none';
        if (rightWrap) rightWrap.style.display = 'none';
        return;
      }
      // Если у тебя была реализация лож — оставь свою.
      // Здесь просто показываем контейнеры, если это Шевченко
      const leftWrap  = document.querySelector('.hall-boxes-left');
      const rightWrap = document.querySelector('.hall-boxes-right');
      if (leftWrap)  leftWrap.style.display  = '';
      if (rightWrap) rightWrap.style.display = '';
    }

    // ---------------------------
    // ВЫБОР МЕСТ
    // ---------------------------
    function toggleSeat(seatId) {
      const idx = selected.indexOf(seatId);
      if (idx >= 0) selected.splice(idx, 1);
      else selected.push(seatId);

      renderHall();
    }

    function updateSelectedUI() {
      if (!selectedListEl || !totalEl) return;

      selectedListEl.innerHTML = "";
      let total = 0;

      if (!selected.length) {
        selectedListEl.innerHTML = '<div class="muted">Місця не обрані</div>';
        totalEl.textContent = formatMoney(0);
        return;
      }

      selected
        .slice()
        .sort((a, b) => a.localeCompare(b, "uk"))
        .forEach((seatId) => {
          const price = prices[seatId] || 0;
          total += price;

          const item = document.createElement("div");
          item.className = "selected-item";
          item.style.display = "flex";
          item.style.justifyContent = "space-between";
          item.style.gap = "12px";
          item.style.margin = "6px 0";

          const left = document.createElement("div");
          left.textContent = seatId;

          const right = document.createElement("div");
          right.style.fontWeight = "700";
          right.textContent = price ? formatMoney(price) : "—";

          item.appendChild(left);
          item.appendChild(right);
          selectedListEl.appendChild(item);
        });

      totalEl.textContent = formatMoney(total);
    }

    // ---------------------------
    // ОЧИСТКА
    // ---------------------------
    clearBtn?.addEventListener("click", () => {
      selected = [];
      updateSelectedUI();
      renderHall();
    });

    // ---------------------------
    // ФОРМА -> БРОНЬ (v2) -> checkout.html
    // ---------------------------
    buyerForm?.addEventListener("submit", async (e) => {
      e.preventDefault();

      if (!selected.length) {
        alert("Оберіть хоча б одне місце.");
        return;
      }
      if (!showSlug) {
        alert("Не визначено спектакль (show).");
        return;
      }
      if (!supabaseClient) {
        alert("Supabase не налаштовано (URL/KEY).");
        return;
      }

      const buyerName  = (buyerNameEl?.value || "").trim();
      const buyerPhone = (buyerPhoneEl?.value || "").trim();
      const buyerEmail = (buyerEmailEl?.value || "").trim();

      if (!buyerName || !buyerPhone || !buyerEmail) {
        alert("Заповніть, будь ласка, ім’я, телефон та email.");
        return;
      }

      // сумма
      const amount = selected.reduce((sum, seatId) => sum + (prices[seatId] || 0), 0);

      // order_id
      const orderId = (showSlug ? showSlug.toUpperCase().slice(0, 6) : "ORDER") + "-" + Date.now();

      // пишем временную бронь ТОЛЬКО в bookings_v2
      try {
        const now = new Date();
        const expiresAt = new Date(now.getTime() + 15 * 60 * 1000).toISOString(); // 15 минут

        const bookingsPayload = selected.map((seatId) => ({
          show_slug:   showSlug,
          order_id:    orderId,
          seat_id:     seatId,            // формат P14-M7
          buyer_name:  buyerName,
          buyer_phone: buyerPhone,
          created_at:  now.toISOString(),
          expires_at:  expiresAt
        }));

        const { error: bookingsError } = await supabaseClient
          .from('bookings_v2')
          .insert(bookingsPayload);

        if (bookingsError) {
          console.warn('bookingsError (не критично для оплати)', bookingsError);
          // Не рвём процесс, просто пишем в консоль
        }

        // ПЕРЕХОД НА checkout.html
        const params = new URLSearchParams({
          show:     showSlug,
          seats:    selected.join(','),
          amount:   String(amount),
          order_id: orderId,
          name:     buyerName,
          phone:    buyerPhone,
          email:    buyerEmail,
        });

        location.href = "../checkout.html?" + params.toString();
      } catch (err) {
        console.error(err);
        alert("Помилка бронювання: " + (err?.message || String(err)));
      }
    });

    // ---------------------------
    // INIT
    // ---------------------------
    (async function init() {
      // подгрузка header/footer если у тебя есть
      try {
        const h = await fetch("../header.html"); if (h.ok) document.getElementById("site-header").innerHTML = await h.text();
      } catch {}
      try {
        const f = await fetch("../footer.html"); if (f.ok) document.getElementById("site-footer").innerHTML = await f.text();
      } catch {}

      await loadHallAndBookings();
    })();
  </script>
</body>
</html>
