<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Вибір місць — Ваш Адмін</title>
  <link rel="icon" href="data:,">
  <link rel="stylesheet" href="../styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    /* === ДОБАВЛЕННЫЕ СТИЛИ ДЛЯ КВОТ === */

    .hall-seat {
      background: #d1d5db; /* default grey */
      border: 1px solid #9ca3af;
      color: #000;
    }

    .hall-seat.quota {
      background: #fff3b0;   /* жёлтый — твои квоты */
      border-color: #b58500;
    }

    .hall-seat.taken {
      background: #e11d48 !important;  /* красный — бронь */
      border-color: #b91c1c !important;
      color: #fff !important;
    }

    .hall-seat.sold {
      background: #6b7280 !important; /* тёмно-серый — купленные */
      border-color: #4b5563 !important;
      color: #fff !important;
    }

    .hall-seat.selected {
      background: #e11d48 !important;  /* выбранное — тоже красное */
      border-color: #b91c1c !important;
      color: #fff !important;
    }

    .row-price-label {
      font-size: 13px;
      color: #6b7280;
      margin: 2px 0 6px 34px;
    }

    .legend {
      font-size: 14px;
      color: #374151;
      background: #f3f4f6;
      padding: 10px;
      border-radius: 8px;
      margin-top: 12px;
    }
  </style>

</head>
<body>
  <!-- шапка -->
  <div id="site-header"></div>

  <main class="main" style="max-width:1100px;margin:0 auto;padding:16px">
    <h1>Вибір місць</h1>
    <p id="show-label" style="color:#64748b;margin-bottom:12px;">Вистава: —</p>

    <!-- схема залу -->
    <section class="section" style="background:#fff;border-radius:14px;padding:18px;margin-bottom:18px;">
      <div class="hall-wrapper">
        <div class="hall-stage">СЦЕНА</div>
        <div id="hall-rows"></div>
      </div>
      <p id="hall-error" style="color:#b91c1c;display:none;margin-top:10px;"></p>

      <div id="legend-box" class="legend">
        <b>Пояснення:</b><br>
        <span style="background:#fff3b0;padding:0 4px;border:1px solid #b58500;">&nbsp;&nbsp;</span> — місця за квотою<br>
        <span style="background:#e11d48;padding:0 4px;border:1px solid #b91c1c;">&nbsp;&nbsp;</span> — бронь або вибране місце<br>
        <span style="background:#6b7280;padding:0 4px;border:1px solid #4b5563;">&nbsp;&nbsp;</span> — куплені<br>
        <span style="background:#d1d5db;padding:0 4px;border:1px solid #9ca3af;">&nbsp;&nbsp;</span> — недоступні
      </div>
    </section>

    <!-- форма покупця -->
    <section class="section" style="background:#fff;border-radius:14px;padding:18px;">
      <h2 style="margin-top:0;">Дані покупця</h2>

      <div class="form-row" style="display:flex;gap:12px;flex-wrap:wrap;">
        <div style="flex:1 1 260px;">
          <label for="buyer-name">Ім’я та прізвище</label>
          <input id="buyer-name" type="text" autocomplete="name" placeholder="Ваше ім’я та прізвище">
        </div>
        <div style="flex:1 1 200px;">
          <label for="buyer-phone">Телефон</label>
          <input id="buyer-phone" type="tel" inputmode="tel" autocomplete="tel" placeholder="+380...">
        </div>
      </div>

      <div style="margin-top:10px;">
        <label for="buyer-email">Електронна пошта (куди надійде квиток)</label>
        <input id="buyer-email" type="email" inputmode="email" autocomplete="email" placeholder="you@example.com">
      </div>

      <p style="margin-top:16px;">
        Вибрано місць: <b><span id="seat-count">0</span></b> •
        Сума до сплати: <b><span id="total-amount">0</span> грн</b>
      </p>

      <button id="pay-button" class="primary-btn" disabled>Перейти до оплати</button>

      <p id="pay-error" style="color:#b91c1c;margin-top:10px;display:none;"></p>
      <p class="muted" style="margin-top:8px;font-size:13px;color:#6b7280;">
        Після оплати ви повернетеся на сайт, а квитки надійдуть на вказану пошту.
      </p>
    </section>
  </main>

  <div id="site-footer"></div>
  <script src="/scripts/include.js"></script>

  <script>
    /* ===========================================================
       ТВОИ ОРИГИНАЛЬНЫЕ НАСТРОЙКИ SUPABASE + LIQPAY (НЕ ТРОГАЛ)
    ============================================================*/
    const SUPABASE_URL = 'https://yqhzekifwxotizsmaeaf.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...';
    const LIQPAY_FN_URL =
      'https://yqhzekifwxotizsmaeaf.supabase.co/functions/v1/liqpay-create-index-ts';

    const supabaseClient = window.supabase.createClient(
      SUPABASE_URL,
      SUPABASE_ANON_KEY
    );

    /* ===========================================================
        НОВЫЕ КВОТЫ A/B/C
    ============================================================*/
    const QUOTAS = {

      "shevchenko/za-dvoma-zaytsiamy": [
        {row:3,  from:6,  to:15, price:200},
        {row:4,  from:6,  to:15, price:180},
        {row:7,  from:6,  to:15, price:170},
        {row:9,  from:6,  to:15, price:160},
        {row:12, from:6,  to:15, price:140},
        {row:13, from:6,  to:15, price:120},
        {row:15, from:6,  to:15, price:100},
        {row:17, from:4,  to:8,  price:70},
        {row:17, from:12, to:16, price:70}
      ],

      "shevchenko/zerna-shchastia": [
        {row:2,  from:11, to:15, price:100},
        {row:3,  from:11, to:15, price:100},
        {row:4,  from:6,  to:15, price:90},
        {row:9,  from:6,  to:15, price:80},
        {row:15, from:6,  to:15, price:70}
      ],

      "shevchenko/sorochynskyi-yarmarok": [
        {row:3,  from:6,  to:15, price:200},
        {row:4,  from:6,  to:15, price:180},
        {row:7,  from:6,  to:15, price:170},
        {row:9,  from:6,  to:15, price:160},
        {row:12, from:6,  to:15, price:140},
        {row:13, from:6,  to:15, price:120},
        {row:15, from:6,  to:15, price:100},
        {row:18, from:6,  to:15, price:70}
      ]
    };

    /* ===========================================================
       Определяем спектакль
    ============================================================ */
    const urlParams = new URLSearchParams(window.location.search);
    const showSlug = urlParams.get('show') || '';
    const showLabelEl = document.getElementById('show-label');

    if (showSlug) showLabelEl.textContent = 'Вистава: ' + showSlug.replace('/', ' — ');
    else showLabelEl.textContent = 'Вистава не визначена (show=...)';

    function getTheatreKey(slug) {
      if (!slug) return 'shevchenko';
      if (slug.startsWith('shevchenko')) return 'shevchenko';
      if (slug.startsWith('academy')) return 'academy';
      return 'shevchenko';
    }
    const theatreKey = getTheatreKey(showSlug);

    const HALL_URLS = {
      shevchenko: '/data/hall/shevchenko/velyka.json',
      academy: '/data/hall/academy/academy.json',
    };

    const hallDataUrl   = HALL_URLS[theatreKey];
    const hallRowsEl    = document.getElementById('hall-rows');
    const hallErrorEl   = document.getElementById('hall-error');
    const seatCountEl   = document.getElementById('seat-count');
    const totalAmountEl = document.getElementById('total-amount');
    const payButton     = document.getElementById('pay-button');
    const payErrorEl    = document.getElementById('pay-error');

    let hallConfig  = null;
    let takenSeatIds = new Set();
    const selectedSeats = new Set();

    /* ===========================================================
       Проверка: место в квоте?
    ============================================================ */
    function quotaPriceFor(seatRow, seatNum) {
      const q = QUOTAS[showSlug];
      if (!q) return null;

      for (let item of q) {
        if (item.row === seatRow && seatNum >= item.from && seatNum <= item.to) {
          return item.price;
        }
      }
      return null;
    }

    /* ===========================================================
       Обновление суммы
    ============================================================ */
    function updateSummary() {
      let sum = 0;
      for (let seatId of selectedSeats) {
        const [r,s] = seatId.split('-'); // P17-M8
        const row = parseInt(r.slice(1));
        const num = parseInt(s.slice(1));
        const price = quotaPriceFor(row, num);
        if (price) sum += price;
      }
      seatCountEl.textContent = selectedSeats.size;
      totalAmountEl.textContent = sum;
      payButton.disabled = selectedSeats.size === 0;
    }

    /* ===========================================================
       Рендер зала (С УЧЁТОМ КВОТ)
    ============================================================ */
    function renderHall() {
      if (!hallConfig) return;

      hallRowsEl.innerHTML = '';
      selectedSeats.clear();
      updateSummary();

      const q = QUOTAS[showSlug] || [];

      hallConfig.rows.forEach(rowCfg => {
        const rowNum = rowCfg.row;
        const seatsCount = rowCfg.seats;
        const aisles = rowCfg.aisles || [];

        const rowDiv = document.createElement('div');
        rowDiv.className = 'hall-row';

        const labelDiv = document.createElement('div');
        labelDiv.className = 'hall-row-label';
        labelDiv.textContent = rowNum;
        rowDiv.appendChild(labelDiv);

        const seatsWrap = document.createElement('div');
        seatsWrap.className = 'hall-row-seats';

        for (let s = 1; s <= seatsCount; s++) {

          if (aisles.includes(s)) {
            const aisleDiv = document.createElement('div');
            aisleDiv.className = 'hall-aisle';
            seatsWrap.appendChild(aisleDiv);
          }

          const seatId = `P${rowNum}-M${s}`;
          const price = quotaPriceFor(rowNum, s);

          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'hall-seat';
          btn.textContent = s;

          /* красное — бронь */
          if (takenSeatIds.has(seatId)) {
            btn.classList.add('taken');
            btn.disabled = true;
          }
          /* квота */
          else if (price !== null) {
            btn.classList.add('quota');
            btn.title = `Ряд ${rowNum}, місце ${s} — ${price} грн`;

            btn.addEventListener('click', () => {
              if (btn.classList.contains('selected')) {
                btn.classList.remove('selected');
                selectedSeats.delete(seatId);
              } else {
                btn.classList.add('selected');
                selectedSeats.add(seatId);
              }
              updateSummary();
            });
          }
          /* остальной зал — серый, недоступен */
          else {
            btn.disabled = true;
          }

          seatsWrap.appendChild(btn);
        }

        rowDiv.appendChild(seatsWrap);
        hallRowsEl.appendChild(rowDiv);

        /* подпись под рядом — если квота есть в этом ряду */
        const rowQuota = q.filter(qi => qi.row === rowNum);
        if (rowQuota.length) {
          const prices = [...new Set(rowQuota.map(x => x.price))].join(', ');
          const label = document.createElement('div');
          label.className = 'row-price-label';
          label.textContent = `Ряд ${rowNum} — ${prices} грн`;
          hallRowsEl.appendChild(label);
        }
      });
    }

    /* ===========================================================
       Загрузка схемы и брони
    ============================================================ */
    async function loadHallAndBookings() {
      try {
        const r = await fetch(hallDataUrl, {cache:'no-store'});
        hallConfig = await r.json();

        const now = new Date().toISOString();

        const { data } = await supabaseClient
          .from('bookings')
          .select('seat_id, expires_at, show_slug')
          .eq('show_slug', showSlug);

        if (data) {
          takenSeatIds = new Set(
            data.filter(b => !b.expires_at || b.expires_at > now)
                .map(b => b.seat_id)
          );
        }

        renderHall();
      }
      catch (e) {
        showInlineError(hallErrorEl, 'Помилка завантаження залу.');
      }
    }

    /* ===========================================================
        ОПЛАТА — ТВОЙ ОРИГИНАЛ (НЕ ТРОГАЛ НИ ОДНОЙ СТРОКИ)
    ============================================================*/
    async function handlePayButtonClick() {
      hideInlineError(payErrorEl);

      try {
        const selected = Array.from(selectedSeats);
        if (!selected.length) {
          showInlineError(payErrorEl, 'Будь ласка, оберіть хоча б одне місце.');
          return;
        }

        const buyerName  = document.getElementById('buyer-name').value.trim();
        const buyerPhone = document.getElementById('buyer-phone').value.trim();
        const buyerEmail = document.getElementById('buyer-email').value.trim();

        if (!buyerName || !buyerPhone || !buyerEmail) {
          showInlineError(payErrorEl, 'Заповніть усі поля.');
          return;
        }

        const amount = Number(totalAmountEl.textContent || '0');
        if (!amount) {
          showInlineError(payErrorEl, 'Не вдалося визначити суму.');
          return;
        }

        const currency = 'UAH';
        const prefix   = showSlug.startsWith('shevchenko') ? 'SHEV' : 'AKAD';
        const orderId  = prefix + '-' + Date.now();

        const { data: ord } = await supabaseClient
          .from('orders')
          .insert({
            order_id:    orderId,
            show_slug:   showSlug,
            seats:       selected,
            amount:      amount,
            currency:    currency,
            buyer_name:  buyerName,
            buyer_phone: buyerPhone,
            buyer_email: buyerEmail,
            status:      'pending'
          })
          .select()
          .single();

        const HOLD_MINUTES = 15;
        const now = new Date();
        const expiresAt = new Date(now.getTime() + HOLD_MINUTES*60000).toISOString();

        await supabaseClient.from('bookings').insert(
          selected.map(seatId => ({
            show_slug: showSlug,
            seat_id: seatId,
            buyer_name: buyerName,
            buyer_phone: buyerPhone,
            created_at: now.toISOString(),
            expires_at: expiresAt
          }))
        );

        const resultUrl = window.location.origin + '/site-081125/spectacles/success.html';
        const serverUrl = window.location.origin + '/site-081125/spectacles/liqpay-callback.html';

        payButton.disabled = true;

        const resp = await fetch(LIQPAY_FN_URL, {
          method:'POST',
          headers:{'Content-Type':'application/json', apikey:SUPABASE_ANON_KEY},
          body:JSON.stringify({
            order_id: orderId,
            show_slug: showSlug,
            seats: selected,
            amount,
            currency,
            description: 'Квитки: ' + showSlug,
            buyer_name: buyerName,
            buyer_phone: buyerPhone,
            buyer_email: buyerEmail,
            result_url: resultUrl,
            server_url: serverUrl
          })
        });

        if (!resp.ok) {
          showInlineError(payErrorEl, 'Помилка створення рахунку.');
          payButton.disabled = false;
          return;
        }

        const data = await resp.json();
        if (!data.checkout_url) {
          showInlineError(payErrorEl, 'Немає посилання на оплату.');
          payButton.disabled = false;
          return;
        }

        window.location.href = data.checkout_url;
      }
      catch(e) {
        showInlineError(payErrorEl, 'Помилка: '+e.message);
        payButton.disabled = false;
      }
    }

    payButton.addEventListener('click', e => {
      e.preventDefault();
      handlePayButtonClick();
    });

    /* ===========================================================
       Старт
    ============================================================ */
    loadHallAndBookings();

  </script>
</body>
</html>
