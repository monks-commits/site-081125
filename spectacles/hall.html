<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Вибір місць — Ваш Адмін</title>
  <link rel="icon" href="data:,">
  <link rel="stylesheet" href="../styles.css">
  <style>
    .hall-wrap{max-width:1100px;margin:0 auto;padding:16px}
    .legend{display:flex;gap:16px;margin:8px 0 16px}
    .legend > span{display:inline-flex;align-items:center;gap:6px}
    .seats{display:grid;gap:10px}
    .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .row-label{min-width:48px;opacity:.7}
    .seat{min-width:36px;min-height:32px;border:1px solid #cdd;color:#223;
          border-radius:8px;display:inline-flex;align-items:center;justify-content:center;
          cursor:pointer;user-select:none}
    .seat.taken{background:#eee;color:#888;border-color:#ddd;cursor:not-allowed}
    .seat.sel{outline:2px solid #2563eb;box-shadow:0 0 0 2px #2563eb33 inset}
    .aisle{min-width:28px}
    .row-gap{height:12px}
    .meta{margin:8px 0 16px;color:#444}
    .form{margin-top:16px;display:grid;gap:10px}
    .form input{width:100%}
    .btn{display:inline-block;padding:10px 16px;border-radius:10px;background:#2563eb;
         color:#fff;border:none;cursor:pointer}
    .btn:disabled{opacity:.55;cursor:not-allowed}
  </style>
</head>
<body>
  <div id="site-header"></div>

  <main class="hall-wrap">
    <img src="/site-081125/images/logo-vash-admin.jpg" alt="Ваш Адмін" style="height:44px;margin:6px 0 10px" onerror="this.remove()">
    <h1 style="margin:6px 0 10px">Вибір місць</h1>
    <p id="show-meta" class="meta"></p>

    <div class="legend">
      <span><span class="seat" style="pointer-events:none">1</span> вільно</span>
      <span><span class="seat sel" style="pointer-events:none">1</span> вибрано</span>
      <span><span class="seat taken" style="pointer-events:none">1</span> зайнято</span>
    </div>

    <div id="hall-root" class="seats" aria-live="polite"></div>

    <section class="form">
      <label>Ім’я та прізвище <input id="fio" placeholder="Ваше ім’я та прізвище"></label>
      <label>Телефон <input id="phone" placeholder="+380..." inputmode="tel"></label>
      <label>Електронна пошта (куди надійде PDF-квиток) <input id="email" placeholder="you@example.com" inputmode="email"></label>
      <p id="summary">Вибрано місць: 0 • Сума: 0 грн</p>
      <button id="pay" class="btn" disabled>Перейти до оплати</button>
    </section>
  </main>

  <div id="site-footer"></div>
  <script src="/site-081125/scripts/include.js"></script>
  <script>
  (async function(){
    const root = document.getElementById('hall-root');
    const meta = document.getElementById('show-meta');
    const btnPay = document.getElementById('pay');
    const sumEl = document.getElementById('summary');

    const urlp = new URLSearchParams(location.search);
    const showKey = urlp.get('show'); // напр. "shevchenko/za-dvoma-zaytsiamy" або "academy/chorni-doshky"

    // --- дефолтні конфіги (на випадок, якщо JSON зали не завантажиться) ---
    const DEFAULTS = {
      shevchenko: {
        rows: 18, seats: 20, passAfterSeat: 10,
        priceForRow: r => {
          if (r<=1) return 170;
          if (r<=3) return 200;
          if (r<=6) return 180;
          if (r<=8) return 170;
          if (r<=10) return 160;
          if (r<=12) return 140;
          if (r<=14) return 120;
          if (r<=16) return 100;
          return 70;
        }
      },
      academy: {
        // спрощений фолбэк: 18×23, проходи після 6 і 17, ряд 1 коротший – компенсуємо "порожніми"
        rows: 18, seats: 23, passAfterSeat: null,
        leftAisleAfter: 6, rightAisleBefore: 17,
        priceForRow: r => 160 // можна змінити на потрібну «ціна на весь зал»
      }
    };

    const sel = new Set(); // "row-seat" -> ціна
    function key(r,s){ return r + '-' + s; }
    function total(){ let t=0; sel.forEach(v=>t+=v); return t; }

    function updateSummary(){
      sumEl.textContent = `Вибрано місць: ${sel.size} • Сума: ${total()} грн`;
      btnPay.disabled = sel.size === 0;
    }

    function drawGridFromConfig(cfg){
      root.innerHTML = '';
      root.style.gridTemplateColumns = '1fr';
      for (let r=1; r<=cfg.rows; r++){
        const row = document.createElement('div');
        row.className = 'row';
        const label = document.createElement('div');
        label.className = 'row-label';
        label.textContent = `Ряд ${r}`;
        row.appendChild(label);

        const seatsThisRow = cfg.seats;
        const price = cfg.priceForRow(r);

        // особливий перший ряд для academy (коротший)
        let effectiveSeats = seatsThisRow;
        let headGap = 0, tailGap = 0;
        if (cfg === DEFAULTS.academy && r === 1){
          effectiveSeats = 11; headGap = 6; tailGap = 6; // приблизна центровка
        }

        // лівий "відступ" (для центрування ряду 1 в академії)
        for(let i=0; i<headGap; i++){
          const gap = document.createElement('div');
          gap.className = 'aisle';
          row.appendChild(gap);
        }

        for (let s=1; s<=effectiveSeats; s++){
          // проход по середині для Шевченка
          if (cfg.passAfterSeat && s===cfg.passAfterSeat+1){
            const a = document.createElement('div'); a.className='aisle'; row.appendChild(a);
          }
          // широкі проходи для академії
          if (cfg.leftAisleAfter && s===cfg.leftAisleAfter+1){
            const a = document.createElement('div'); a.className='aisle'; row.appendChild(a);
          }
          if (cfg.rightAisleBefore && s===cfg.rightAisleBefore){
            const a = document.createElement('div'); a.className='aisle'; row.appendChild(a);
          }

          const seat = document.createElement('div');
          seat.className = 'seat';
          seat.textContent = s;
          seat.title = `Ряд ${r}, місце ${s} — ${price} грн`;
          seat.addEventListener('click', ()=>{
            const k = key(r,s);
            if (seat.classList.contains('taken')) return;
            if (seat.classList.toggle('sel')) sel.add(price); else {
              // видаляємо одну відповідну ціну
              let removed=false, next=new Set();
              sel.forEach(v=>{ if(!removed && v===price){ removed=true; } else next.add(v); });
              sel.clear(); next.forEach(v=>sel.add(v));
            }
            updateSummary();
          });
          row.appendChild(seat);
        }

        // правий "відступ" (для центровки)
        for(let i=0; i<tailGap; i++){
          const gap = document.createElement('div');
          gap.className = 'aisle';
          row.appendChild(gap);
        }

        // прохід між 17 і 18 рядом (академія)
        if (cfg === DEFAULTS.academy && r===17){
          const spacer = document.createElement('div');
          spacer.className = 'row-gap';
          root.appendChild(spacer);
        }

        root.appendChild(row);
      }
    }

    // --- 1) тягнемо шоу ---
    let show = null, theatre = null;
    try{
      const showUrl = `/site-081125/data/shows/${showKey}.json`;
      const rs = await fetch(showUrl, {cache:'no-store'});
      if (!rs.ok) throw new Error('show json 404');
      show = await rs.json();
    }catch(e){
      // останній шанс: розпарсити театр з ключа
      const part = (showKey||'').split('/')[0];
      theatre = (part==='shevchenko'||part==='academy'||part==='akademia') ? part : 'shevchenko';
    }
    if (!theatre) theatre = (show?.theatre || 'shevchenko');
    if (theatre==='akademia') theatre='academy'; // уніфікуємо

    // Метадані
    const metaBits = [];
    if (show?.title) metaBits.push(show.title);
    metaBits.push(theatre==='shevchenko'?'Велика сцена • Театр ім. Шевченка':'Велика сцена • Академія руху');
    if (show?.date){
      const d = new Date(show.date);
      if(!isNaN(d)) metaBits.push(new Intl.DateTimeFormat('uk-UA',{dateStyle:'medium',timeStyle:'short'}).format(d));
    }
    meta.textContent = metaBits.join(' • ');

    // --- 2) намагаємось завантажити JSON зали; якщо не вдалось — фолбэк ---
    let hallCfg = null;  // із JSON: масив рядів/сегментів
    let priceFn = null;  // функція ціни для ряда (коли фолбэк)
    try{
      let hallPath = null;
      if (theatre==='shevchenko') hallPath = '/site-081125/data/hall/shevchenko/velyka.json';
      else hallPath = '/site-081125/data/hall/academy/academy.json';

      const hr = await fetch(hallPath,{cache:'no-store'});
      if (!hr.ok) throw new Error('hall 404');
      const hallJson = await hr.json();
      // Якщо у JSON структура seats-зон — можна намалювати її; для простоти перетворимо у фолбэк-сітку:
      hallCfg = null; // малюємо спрощеною сіткою нижче
    }catch(e){
      hallCfg = null; // явний фолбэк
    }

    if (!hallCfg){
      // Малюємо за дефолтами
      const cfg = (theatre==='shevchenko') ? DEFAULTS.shevchenko : DEFAULTS.academy;
      drawGridFromConfig(cfg);
    }else{
      // (резерв: тут можна намалювати складну схему з JSON)
    }

    updateSummary();

    // --- 3) Оплата (LiqPay) ---
    btnPay.addEventListener('click', async ()=>{
      if (sel.size===0) return;
      const orderId = 'ORD-' + Math.random().toString(36).slice(2,10).toUpperCase();
      const seatsList = []; // для майбутнього: можна зберегти конкретні місця
      const amount = total();

      const payload = {
        order_id: orderId,
        amount,
        currency: "UAH",
        show_slug: showKey || '',
        seats: seatsList,
        buyer: {
          name: document.getElementById('fio').value || '',
          phone: document.getElementById('phone').value || '',
          email: document.getElementById('email').value || ''
        },
        success_url: "https://monks-commits.github.io/site-081125/success.html",
        fail_url:    "https://monks-commits.github.io/site-081125/fail.html",
        sandbox: 1
      };

      try{
        const URL = "https://yqhzekifwoxiztsmaeaf.supabase.co/functions/v1/liqpay-init";
        const rs = await fetch(URL, {
          method: 'POST',
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify(payload)
        });
        if (!rs.ok){
          alert('Не вдалося ініціалізувати оплату. Спробуйте ще раз.');
          return;
        }
        const data = await rs.json();
        // Очікуємо, що ф-ція повертає { redirect_url } або html-форму
        if (data?.redirect_url){
          location.href = data.redirect_url;
        }else if (data?.form_html){
          const div = document.createElement('div');
          div.innerHTML = data.form_html;
          document.body.appendChild(div);
          const f = div.querySelector('form'); if (f) f.submit();
        }else{
          alert('Відповідь платежу неочікувана.');
        }
      }catch(err){
        console.error(err);
        alert('Помилка платежу.');
      }
    });
  })();
  </script>
</body>
</html>
