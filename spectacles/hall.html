<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Вибір місць — Ваш Адмін</title>
<link rel="icon" href="data:,">
<link rel="stylesheet" href="../styles.css">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
/* Общие стили */
.hall-wrapper{overflow-x:auto;padding:10px;border:1px solid #e5e7eb;border-radius:12px;}
#hall-inner{transform-origin:top left;display:inline-block;}
.hall-stage{text-align:center;padding:6px 0;margin-bottom:12px;border-radius:8px;background:#e5e7eb;font-weight:600;}
.hall-row{display:flex;flex-direction:column;margin-bottom:4px;}
.hall-row-line{display:flex;align-items:center;}
.hall-row-label{width:28px;text-align:right;margin-right:6px;font-size:14px;color:#475569;}
.hall-row-seats{display:flex;gap:4px;}
.hall-aisle{width:4px;}
/* Базовые состояния */
.hall-seat{width:26px;height:26px;border-radius:4px;border:1px solid #999;cursor:not-allowed;background:#d1d5db;font-size:12px;}
.hall-seat.active{background:#facc15;cursor:pointer;border-color:#bfa400;}
.hall-seat.active.selected{outline:2px solid #2563eb;}
.hall-seat.taken{background:#b91c1c;color:#fff;}
.hall-seat.sold{background:#6b7280;color:#fff;}
/* подпись под рядом */
.row-price{font-size:12px;color:#444;margin-left:34px;margin-top:2px;}
@media(max-width:600px){
  .hall-seat{width:22px;height:22px;font-size:11px;}
  .hall-row-label{width:24px;font-size:12px;}
}
</style>
</head>

<body>
<div id="site-header"></div>

<main class="main" style="max-width:1100px;margin:0 auto;padding:16px">
<h1>Вибір місць</h1>
<p id="show-label" style="color:#64748b;margin-bottom:12px;">Вистава: —</p>

<section class="section" style="background:#fff;border-radius:14px;padding:18px;margin-bottom:18px;">
<div style="display:flex;justify-content:flex-end;gap:6px;margin-bottom:8px;">
<button id="zoom-out" style="width:32px;height:32px;border-radius:16px;border:1px solid #d0d5dd;">−</button>
<button id="zoom-in" style="width:32px;height:32px;border-radius:16px;border:1px solid #d0d5dd;">+</button>
</div>

<div class="hall-wrapper">
  <div id="hall-inner">
    <div class="hall-stage">СЦЕНА</div>
    <div id="hall-rows"></div>
    <div id="quota-legend" style="margin-top:16px;font-size:13px;color:#374151;"></div>
  </div>
</div>

<p id="hall-error" style="color:#b91c1c;display:none;margin-top:10px;"></p>
</section>

<section class="section" style="background:#fff;border-radius:14px;padding:18px;">
<h2 style="margin-top:0;">Дані покупця</h2>

<div style="display:flex;gap:12px;flex-wrap:wrap;">
  <div style="flex:1 1 260px;">
    <label style="font-size:14px;">Ім’я та прізвище</label>
    <input id="buyer-name" type="text" placeholder="Ваше ім’я та прізвище"
    style="width:100%;height:44px;border-radius:10px;border:1px solid #d0d5dd;padding:0 12px;">
  </div>
  <div style="flex:1 1 200px;">
    <label style="font-size:14px;">Телефон</label>
    <input id="buyer-phone" type="tel" placeholder="+380..."
    style="width:100%;height:44px;border-radius:10px;border:1px solid #d0d5dd;padding:0 12px;">
  </div>
</div>

<label style="font-size:14px;margin-top:10px;display:block;">Електронна пошта</label>
<input id="buyer-email" type="email" placeholder="you@example.com"
style="width:100%;height:44px;border-radius:10px;border:1px solid #d0d5dd;padding:0 12px;">

<p style="margin-top:16px;">Вибрано місць: <b><span id="seat-count">0</span></b> • Сума: <b><span id="total-amount">0</span> грн</b></p>

<button id="pay-button" class="primary-btn" disabled>Перейти до оплати</button>
<p id="pay-error" style="color:#b91c1c;margin-top:10px;display:none;"></p>
</section>
</main>

<div id="site-footer"></div>
<script src="/scripts/include.js"></script>

<script>
/* =================== НАСТРОЙКИ =================== */
const SUPABASE_URL='https://yqhzekifwxotizsmaeaf.supabase.co';
const SUPABASE_ANON='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlxaHpla2lmd3hvdGl6c21hZWFmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEyMzQyNjgsImV4cCI6MjA3NjgxMDI2OH0.lUoppCppKZisZdyOrreCov_-xEOCvGuwxd28XZY4O_k';
const supabase=window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON);

/* ========= КВОТЫ ========= */
const QUOTAS={
"shevchenko/za-dvoma-zaytsiamy":[
 {row:3,from:6,to:15,price:200},
 {row:4,from:6,to:15,price:180},
 {row:7,from:6,to:15,price:170},
 {row:9,from:6,to:15,price:160},
 {row:12,from:6,to:15,price:140},
 {row:13,from:6,to:15,price:120},
 {row:15,from:6,to:15,price:100},
 {row:17,from:4,to:8,price:70},
 {row:17,from:12,to:16,price:70}
],
"shevchenko/zerna-shchastia":[
 {row:2,from:11,to:15,price:100},
 {row:3,from:11,to:15,price:100},
 {row:4,from:6,to:15,price:90},
 {row:9,from:6,to:15,price:80},
 {row:15,from:6,to:15,price:70}
],
"shevchenko/sorochynskyi-yarmarok":[
 {row:3,from:6,to:15,price:200},
 {row:4,from:6,to:15,price:180},
 {row:7,from:6,to:15,price:170},
 {row:9,from:6,to:15,price:160},
 {row:12,from:6,to:15,price:140},
 {row:13,from:6,to:15,price:120},
 {row:15,from:6,to:15,price:100},
 {row:18,from:6,to:15,price:70}
]
};

/* ======================================== */
const params=new URLSearchParams(location.search);
const showSlug=params.get('show')||'';
document.getElementById('show-label').textContent='Вистава: '+showSlug;

function getHallFile(){
 if(showSlug.startsWith('shevchenko'))return'/data/hall/shevchenko/velyka.json';
 if(showSlug.startsWith('academy'))return'/data/hall/academy/academy.json';
 return'/data/hall/shevchenko/velyka.json';
}

let hallConfig=null,taken=new Set(),selected=new Set();

function isQuota(row,seat){
 const q=QUOTAS[showSlug]||[];
 return q.find(z=>z.row===row && seat>=z.from && seat<=z.to);
}

function renderHall(){
 const root=document.getElementById('hall-rows');
 root.innerHTML='';

 const quotaLegend=[];
 const quotaByRow={};

 (QUOTAS[showSlug]||[]).forEach(q=>{
   if(!quotaByRow[q.row])quotaByRow[q.row]=q.price;
 });

 hallConfig.rows.forEach(rowCfg=>{
   const rowWrap=document.createElement('div');
   rowWrap.className='hall-row';

   const line=document.createElement('div');
   line.className='hall-row-line';

   const lbl=document.createElement('div');
   lbl.className='hall-row-label';
   lbl.textContent=rowCfg.row;
   line.appendChild(lbl);

   const seats=document.createElement('div');
   seats.className='hall-row-seats';

   for(let s=1;s<=rowCfg.seats;s++){
     if(rowCfg.aisles.includes(s)){
       const a=document.createElement('div');
       a.className='hall-aisle';
       seats.appendChild(a);
     }

     const id=`P${rowCfg.row}-M${s}`;
     const btn=document.createElement('button');
     btn.className='hall-seat';
     btn.textContent=s;
     btn.dataset.id=id;

     const q=isQuota(rowCfg.row,s);

     if(taken.has(id)){
       btn.classList.add('taken');
     }
     else if(q){
       btn.classList.add('active');
       btn.title=`Ряд ${rowCfg.row}, місце ${s} — ${q.price} грн`;
       btn.onclick=()=>{
         if(btn.classList.contains('selected')){
           btn.classList.remove('selected');selected.delete(id);
         } else {
           btn.classList.add('selected');selected.add(id);
         }
         updateSummary();
       };
     }

     seats.appendChild(btn);
   }

   line.appendChild(seats);
   rowWrap.appendChild(line);

   if(quotaByRow[rowCfg.row]){
     const rp=document.createElement('div');
     rp.className='row-price';
     rp.textContent=`Ряд ${rowCfg.row} — ${quotaByRow[rowCfg.row]} грн`;
     rowWrap.appendChild(rp);

     quotaLegend.push(`Ряд ${rowCfg.row} — ${quotaByRow[rowCfg.row]} грн`);
   }

   root.appendChild(rowWrap);
 });

 document.getElementById('quota-legend').innerHTML='<b>Квота:</b> '+quotaLegend.join('; ');
}

function updateSummary(){
 document.getElementById('seat-count').textContent=selected.size;
 let sum=0;
 selected.forEach(id=>{
   const [r,m]=id.split('-');
   const row=+r.slice(1), seat=+m.slice(1);
   const q=isQuota(row,seat);
   if(q)sum+=q.price;
 });
 document.getElementById('total-amount').textContent=sum;
 document.getElementById('pay-button').disabled=(selected.size===0);
}

async function loadHall(){
 const hall=await fetch(getHallFile(),{cache:'no-store'}).then(r=>r.json());
 hallConfig=hall;

 const now=new Date().toISOString();
 const {data}=await supabase.from('bookings')
   .select('seat_id,expires_at')
   .eq('show_slug',showSlug);

 taken=new Set((data||[]).filter(b=>!b.expires_at||b.expires_at>now).map(b=>b.seat_id));

 renderHall();
}

document.getElementById('zoom-in').onclick=()=>zoom(0.2);
document.getElementById('zoom-out').onclick=()=>zoom(-0.2);
let scale=1;
function zoom(v){scale=Math.max(0.6,Math.min(2.2,scale+v));document.getElementById('hall-inner').style.transform=`scale(${scale})`;}

loadHall();
</script>
</body>
</html>
