<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Вибір місць — Ваш Адмін</title>
  <link rel="icon" href="data:,">
  <link rel="stylesheet" href="/site-081125/styles.css" />
  <style>
    .hall { display: grid; gap: 10px 8px; }
    .row { display: grid; grid-auto-flow: column; gap: 6px; align-items: center; }
    .row.gap-after { margin-bottom: 18px; }
    .row-label { width: 44px; opacity: .8; }
    .seat, .spacer, .aisle {
      width: 32px; height: 28px; display: inline-grid; place-items: center;
      border-radius: 6px; font-size: 14px;
    }
    .seat { border: 1px solid #c8ccd0; background:#fff; cursor: pointer; }
    .seat.taken { background:#e9eef3; color:#8aa; cursor:not-allowed; }
    .seat.selected { outline: 2px solid #2b77ff; }
    .spacer { visibility: hidden; }
    .aisle { width: 14px; background: transparent; }
    .legend { display:flex; gap:18px; align-items:center; margin:10px 0 18px;}
    .legend .dot { width:16px; height:16px; border-radius:4px; border:1px solid #c8ccd0; }
    .dot.free { background:#fff; }
    .dot.sel { outline:2px solid #2b77ff; background:#fff; }
    .dot.taken { background:#e9eef3; }
    .meta { margin: 12px 0 6px; }
  </style>
</head>
<body>
  <div id="site-header"></div>

  <main class="main">
    <h1>Вибір місць</h1>

    <div id="meta" class="meta"></div>

    <div class="legend">
      <span><span class="dot free"></span> вільно</span>
      <span><span class="dot sel"></span> вибрано</span>
      <span><span class="dot taken"></span> зайнято</span>
    </div>

    <div id="error" style="color:#c62828; display:none;"></div>
    <div id="hall" class="hall"></div>

    <h2 style="margin-top:18px">Дані покупця</h2>
    <form id="order-form" onsubmit="event.preventDefault(); goPay();">
      <div><input id="name" class="input" placeholder="Ваше ім’я та прізвище" required></div>
      <div><input id="phone" class="input" placeholder="+380..." required></div>
      <div><input id="email" class="input" placeholder="you@example.com" required></div>
      <div id="summary" style="margin:8px 0;">Вибрано місць: 0 • Сума: 0 грн</div>
      <button class="btn" id="pay-btn" disabled>Перейти до оплати</button>
    </form>
  </main>

  <div id="site-footer"></div>
  <script src="/site-081125/scripts/include.js"></script>
  <script>
/* ================== ПАРАМЕТРЫ ПРОЕКТА ================== */
// ваш Supabase
const SUPABASE_URL  = 'https://<ВАШ-ПРОЕКТ>.supabase.co';
const ANON_KEY      = '<ВАШ_ANON_KEY>';   // тот же ключ в Authorization и apikey
// страницы после оплаты
const SUCCESS_URL   = 'https://monks-commits.github.io/site-081125/success.html';
const FAIL_URL      = 'https://monks-commits.github.io/site-081125/fail.html';
// валюта
const CURRENCY      = 'UAH';
// sandbox: 1 = тестовый LiqPay, 0 = боевой
const SANDBOX       = 1;

/* ========= ВСПОМОГАТЕЛЬНОЕ: ПОЛУЧИТЬ SLUG И ВЫБРАННЫЕ МЕСТА ========= */
function getShowSlug() {
  const u = new URL(location.href);
  // hall.html?show=shevchenko/za-dvoma-zaytsyamy  или academy/chorni-doshky
  return u.searchParams.get('show') || '';
}

function getBuyer() {
  return {
    name:  (document.querySelector('input[name="buyer_name"]')  ?.value || '').trim() ||
           (document.querySelector('input[type="text"]')        ?.value || '').trim(),
    phone: (document.querySelector('input[name="buyer_phone"]') ?.value || '').trim() ||
           (document.querySelector('input[type="tel"]')         ?.value || '').trim(),
    email: (document.querySelector('input[name="buyer_email"]') ?.value || '').trim() ||
           (document.querySelector('input[type="email"]')       ?.value || '').trim(),
  };
}

/* 
  ВАЖНО: используем уже отрисованные кнопки мест.
  Считаем выбранными те, у которых есть состояние "active" (или aria-pressed="true").
  Если у вас другой маркер – поправьте селектор.
*/
function collectSelectedSeats() {
  // кнопки-места, которым вы ставите .active при выборе
  const btns = document.querySelectorAll('.seat.active, .seat[aria-pressed="true"], .seat.selected');
  const seats = [];
  btns.forEach(btn => {
    // пытаемся прочитать подписи ряда/места
    const row  = btn.dataset.row  || btn.getAttribute('data-row')  || btn.closest('[data-row]')?.dataset.row;
    const seat = btn.dataset.seat || btn.getAttribute('data-seat') || btn.textContent.trim();
    // кодируем в понятный вид, напр.: "R7-S12"
    seats.push(`R${row}-S${seat}`);
  });
  return seats;
}

/* ========= РАСЧЁТ И ВАЛИДАЦИЯ ========= */
function getTotalAmountUAH() {
  // на странице у вас уже есть где-то рассчитанная сумма; если храните в DOM — прочитать:
  // пример: <span id="total-sum">200</span>
  const node = document.getElementById('total-sum');
  if (node && node.textContent) return Number(node.textContent.replace(/[^\d.]/g,''));
  // если суммы в DOM нет — пересчёт по data-price у выбранных мест:
  let sum = 0;
  document.querySelectorAll('.seat.active, .seat[aria-pressed="true"], .seat.selected').forEach(b=>{
    const p = Number(b.dataset.price || b.getAttribute('data-price') || 0);
    sum += isNaN(p) ? 0 : p;
  });
  return sum;
}

function validate(buyer, seats, amount) {
  const errs = [];
  if (!seats.length) errs.push('Оберіть хоча б одне місце.');
  if (!buyer.name)  errs.push('Вкажіть ім’я та прізвище.');
  if (!buyer.phone) errs.push('Вкажіть телефон.');
  if (!buyer.email) errs.push('Вкажіть email.');
  if (!(amount > 0)) errs.push('Сума до оплати має бути більшою за 0.');
  return errs;
}

/* ========= LIQPAY: ЗАПУСК ПЛАТЕЖА ЧЕРЕЗ EDGE FUNCTION ========= */
async function startCheckout() {
  const show_slug = getShowSlug();
  const seats     = collectSelectedSeats();
  const buyer     = getBuyer();
  const amount    = getTotalAmountUAH();

  const errors = validate(buyer, seats, amount);
  if (errors.length) { alert(errors.join('\n')); return; }

  // сформируем order_id (уникальный)
  const order_id = `${show_slug}#${Date.now()}`;

  const payload = {
    order_id,
    amount,
    currency: CURRENCY,
    show_slug,
    seats,
    buyer,
    success_url: SUCCESS_URL,
    fail_url:    FAIL_URL,
    sandbox:     SANDBOX
  };

  try {
    const r = await fetch(`${SUPABASE_URL}/functions/v1/liqpay-init`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${ANON_KEY}`,
        'apikey': ANON_KEY
      },
      body: JSON.stringify(payload)
    });

    if (!r.ok) {
      const t = await r.text();
      throw new Error(`Init failed (${r.status}): ${t}`);
    }

    const { data, signature } = await r.json();

    if (!data || !signature) {
      throw new Error('Edge function did not return data/signature');
    }

    submitToLiqpay(data, signature);
  } catch (e) {
    console.error(e);
    alert('Помилка створення платежу. Спробуйте ще раз або зверніться до нас.');
  }
}

/* ========= СКРЫТАЯ ФОРМА ДЛЯ LIQPAY ========= */
function ensureLiqpayForm() {
  let f = document.getElementById('liqpayForm');
  if (f) return f;
  f = document.createElement('form');
  f.id = 'liqpayForm';
  f.method = 'POST';
  f.action = 'https://www.liqpay.ua/api/3/checkout';
  f.style.display = 'none';

  const d = document.createElement('input');
  d.type = 'hidden'; d.name = 'data'; d.id = 'liqpayData';
  const s = document.createElement('input');
  s.type = 'hidden'; s.name = 'signature'; s.id = 'liqpaySignature';
  f.appendChild(d); f.appendChild(s);
  document.body.appendChild(f);
  return f;
}

function submitToLiqpay(data, signature) {
  const f = ensureLiqpayForm();
  document.getElementById('liqpayData').value = data;
  document.getElementById('liqpaySignature').value = signature;
  f.submit();
}

/* ========= ПРИВЯЗЫВАЕМ КНОПКУ ========= */
(function wirePayButton(){
  const payBtn =
    document.getElementById('payBtn') ||
    Array.from(document.querySelectorAll('button, a')).find(x => /оплат/i.test(x.textContent));
  if (payBtn) {
    payBtn.addEventListener('click', (e)=>{
      e.preventDefault();
      startCheckout();
    }, {passive:false});
  } else {
    console.warn('Кнопка оплаты не найдена — проверьте id="payBtn" или текст кнопки.');
  }
})();
</script>

</body>
</html>
