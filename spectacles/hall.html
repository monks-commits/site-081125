<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Вибір місць — Ваш Адмін</title>
  <link rel="icon" href="data:,">
  <link rel="stylesheet" href="/site-081125/styles.css" />
  <style>
    /* Нейтральні стилі на випадок, якщо у styles.css немає потрібних класів */
    .hall {display:grid; gap:10px; margin:16px 0}
    .hall-row {display:flex; align-items:center; gap:10px; flex-wrap:wrap}
    .hall-row-label {width:80px; text-align:right; font-weight:600; color:#475467}
    .seats {display:flex; gap:6px; flex-wrap:wrap}
    .seat {
      min-width:36px; height:36px; border-radius:8px; border:1px solid #D0D5DD; background:#fff;
      cursor:pointer; font:600 13px/34px system-ui, -apple-system, Segoe UI, Roboto, Ubuntu;
      text-align:center; padding:0 8px; user-select:none;
    }
    .seat.taken {background:#E5E7EB; border-color:#E5E7EB; color:#9CA3AF; cursor:not-allowed}
    .seat.selected {background:#155EEF; color:#fff; border-color:#155EEF}
    .legend{display:flex; gap:14px; align-items:center; flex-wrap:wrap; margin-top:6px; color:#475467}
    .legend > span{display:inline-flex; gap:6px; align-items:center}
    .legend .box{width:16px; height:16px; border:1px solid #D0D5DD; border-radius:4px; background:#fff}
    .legend .sel{background:#155EEF; border-color:#155EEF}
    .legend .dis{background:#E5E7EB; border-color:#E5E7EB}
    .order-form .form-row{display:flex; flex-direction:column; gap:6px; margin:10px 0}
    #summary{margin:8px 0 14px}
  </style>
</head>

<body>
  <div id="site-header"></div>

  <main class="main">
    <section class="section">
      <h1>Вибір місць</h1>
      <div id="show-title" class="muted" style="margin-bottom:8px"></div>

      <div id="hall-root" class="hall"></div>
      <div class="legend">
        <span><span class="box"></span> вільно</span>
        <span><span class="box sel"></span> вибрано</span>
        <span><span class="box dis"></span> зайнято</span>
      </div>

      <form id="order-form" class="order-form">
        <h2 style="margin-top:18px">Дані покупця</h2>

        <div class="form-row">
          <label>Ім’я та прізвище</label>
          <input type="text" name="name" required placeholder="Ваше ім’я та прізвище" autocomplete="name" />
        </div>

        <div class="form-row">
          <label>Телефон</label>
          <input type="tel" name="phone" required placeholder="+380..." inputmode="tel" autocomplete="tel" />
        </div>

        <div class="form-row">
          <label>Електронна пошта (куди надійде PDF-квиток)</label>
          <input type="email" name="email" required placeholder="you@example.com" inputmode="email" autocomplete="email" />
        </div>

        <p id="summary">Вибрано місць: 0 • Сума: 0 грн</p>
        <button type="submit" class="btn primary">Перейти до оплати</button>
      </form>
    </section>
  </main>

  <div id="site-footer"></div>

  <script src="/site-081125/scripts/include.js"></script>
  <script>
(function () {
  const qs = new URLSearchParams(location.search);
  const show = qs.get('show') || '';

  // Определяем театр по слагу шоу
  const isAcademy = show.startsWith('academy/');
  const theatreKey = isAcademy ? 'academy' : 'shevchenko';

  // Путь к схеме зала
  const HALL_URL = isAcademy
    ? '/site-081125/data/hall/academy/academy.json'
    : '/site-081125/data/hall/shevchenko/velyka.json';

  const seatRoot = document.getElementById('hall-root') || createRoot();

  function createRoot() {
    const wrap = document.createElement('div');
    wrap.id = 'hall-root';
    wrap.style.margin = '16px 0';
    document.querySelector('.main')?.insertAdjacentElement('afterbegin', wrap);
    return wrap;
  }

  // Вспомогательное: разворачиваем row.seats в массив объектов мест
  function expandSeats(rowObj) {
    if (Array.isArray(rowObj.seats)) {
      // Формат как у Шевченка: уже массив seat-объектов
      return rowObj.seats.map(s => ({
        label: String(s.label ?? ''),
        price: Number(s.price ?? 0),
        status: s.status || 'free'
      }));
    }

    // Формат как у Академии: seats = число; есть zones и aisles
    const count = Number(rowObj.seats) || 0;
    const zones = Array.isArray(rowObj.zones) ? rowObj.zones : [];
    const aisles = Array.isArray(rowObj.aisles) ? rowObj.aisles : [];

    const seats = [];
    for (let i = 1; i <= count; i++) {
      // Ищем цену по зонам
      let price = 0;
      for (const z of zones) {
        if (i >= (z.from ?? 0) && i <= (z.to ?? 0)) {
          price = Number(z.price ?? 0);
          break;
        }
      }
      seats.push({
        label: String(i),
        price,
        status: 'free',
        _aisleAfter: aisles.includes(i)   // после этого места вставим проход
      });
    }
    return seats;
  }

  function renderHall(rows) {
    seatRoot.innerHTML = '';

    // Простые стили (если своих нет)
    const css = document.createElement('style');
    css.textContent = `
      .row { display:flex; align-items:center; gap:8px; margin:8px 0; flex-wrap:wrap; }
      .row-label { width:48px; opacity:.8; }
      .seats { display:flex; gap:6px; flex-wrap:wrap; }
      .seat { width:28px; height:28px; border-radius:6px; border:1px solid #ccc;
              display:flex; align-items:center; justify-content:center; font-size:12px;
              cursor:pointer; user-select:none; }
      .seat.free { background:#f9fafb; }
      .seat.taken { background:#f3f4f6; color:#9ca3af; cursor:not-allowed; }
      .aisle { width:14px; }
    `;
    document.head.appendChild(css);

    rows.forEach((rowObj, idx) => {
      const rowEl = document.createElement('div');
      rowEl.className = 'row';

      const label = document.createElement('div');
      label.className = 'row-label';
      label.textContent = `Ряд ${rowObj.row || (idx + 1)}`;
      rowEl.appendChild(label);

      const seatsWrap = document.createElement('div');
      seatsWrap.className = 'seats';

      const seatList = expandSeats(rowObj);
      seatList.forEach((s, i) => {
        const seat = document.createElement('div');
        seat.className = 'seat ' + (s.status || 'free');
        seat.dataset.price = String(s.price ?? 0);
        seat.dataset.label = s.label;
        seat.textContent = s.label;

        // клики
        if ((s.status || 'free') === 'free') {
          seat.addEventListener('click', () => seat.classList.toggle('selected'));
        }

        seatsWrap.appendChild(seat);

        // вставляем проход (если помечен)
        if (s._aisleAfter) {
          const gap = document.createElement('div');
          gap.className = 'aisle';
          seatsWrap.appendChild(gap);
        }
      });

      rowEl.appendChild(seatsWrap);
      seatRoot.appendChild(rowEl);
    });

    // Обновление суммы по выбранным
    updateTotal();
    seatRoot.addEventListener('click', (e) => {
      if (e.target?.classList?.contains('seat')) updateTotal();
    });
  }

  function updateTotal() {
    const selected = seatRoot.querySelectorAll('.seat.selected');
    let sum = 0;
    selected.forEach(s => sum += Number(s.dataset.price || 0));
    const totalEl = document.getElementById('order-total') || createTotal();
    totalEl.textContent = `Вибрано місць: ${selected.length} • Сума: ${sum} грн`;
  }

  function createTotal() {
    const p = document.createElement('p');
    p.id = 'order-total';
    p.style.margin = '8px 0 16px';
    const form = document.querySelector('form') || document.body;
    form.parentNode.insertBefore(p, form);
    return p;
  }

  // Загрузка схемы
  fetch(HALL_URL, { cache: 'no-store' })
    .then(r => {
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      return r.json();
    })
    .then(json => {
      if (!json || !Array.isArray(json.rows)) {
        throw new Error('Невалидный формат схемы (нет rows)');
      }
      renderHall(json.rows);
    })
    .catch(err => {
      console.error('Ошибка загрузки схемы зали:', err);
      const el = document.createElement('p');
      el.style.color = 'crimson';
      el.textContent = `Не вдалося завантажити схему залу: ${HALL_URL}`;
      seatRoot.innerHTML = '';
      seatRoot.appendChild(el);
    });
})();
</script>

</body>
</html>
