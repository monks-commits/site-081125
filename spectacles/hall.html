<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Вибір місць</title>
  <link rel="icon" href="data:,">
  <link rel="stylesheet" href="../styles.css" />
  <style>
    :root{
      --seat-size: 34px;     /* кнопка кресла */
      --gap-x: 6px;          /* горизонтальный зазор между креслами */
      --gap-y: 8px;          /* вертикальный зазор между рядами */
      --aisle-w: 14px;       /* ширина стандартного прохода */
      --aisle-w-lg: 24px;    /* большой проход */
    }
    .wrap{max-width:980px;margin:0 auto;padding:12px;}
    .stage{
      width:100%;text-align:center;background:#1f1f1f;color:#fff;
      padding:10px 12px;border-radius:12px;margin:0 0 12px 0;font-weight:600;letter-spacing:.3px;
    }
    .row{display:flex;align-items:center;gap:var(--gap-x);margin:0 0 var(--gap-y) 0;flex-wrap:wrap}
    .row-label{margin-right:8px;font-size:12px;min-width:34px;text-align:right;font-weight:600;opacity:.75;user-select:none}
    .seats{display:flex;align-items:center;gap:var(--gap-x);flex-wrap:wrap}
    .seat{
      min-width:var(--seat-size);height:var(--seat-size);border-radius:8px;border:1px solid #d0d5dd;
      display:inline-flex;align-items:center;justify-content:center;font-size:13px;background:#fff;cursor:pointer;
      user-select:none;transition:.12s;
    }
    .seat:hover{box-shadow:0 0 0 2px rgba(25,115,255,.15)}
    .seat[aria-pressed="true"]{background:#155eef;color:#fff;border-color:#155eef}
    .seat.taken{opacity:.45;pointer-events:none}
    .aisle{display:inline-block;width:var(--aisle-w)}
    .aisle-lg{display:inline-block;width:var(--aisle-w-lg)}
    .row-break-lg{margin-bottom:18px;border-bottom:2px dashed #eaeaea;padding-bottom:10px}

    .legend{display:flex;gap:18px;align-items:center;margin:10px 0 16px}
    .legend .pill{display:inline-flex;align-items:center;gap:6px;font-size:13px;opacity:.8}
    .pill .dot{width:16px;height:16px;border-radius:6px;border:1px solid #d0d5dd;background:#fff}
    .pill .dot.sel{background:#155eef;border-color:#155eef}
    .pill .dot.off{background:#eee}
    .panel{margin-top:10px;display:grid;gap:8px}
    .panel input{width:100%;padding:10px 12px;border:1px solid #d0d5dd;border-radius:10px}
    .btn-primary{
      width:100%;padding:12px 14px;border-radius:12px;background:#155eef;color:#fff;border:0;font-weight:600;cursor:pointer
    }

    @media(max-width:420px){
      :root{ --seat-size: 30px; --gap-x: 5px; --gap-y: 7px; }
      .row-label{min-width:28px;font-size:11px;margin-right:6px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div id="site-header"></div>

    <main>
      <h1 style="margin:8px 0 12px">Вибір місць</h1>

      <div class="legend">
        <span class="pill"><span class="dot"></span> вільно</span>
        <span class="pill"><span class="dot sel"></span> вибрано</span>
        <span class="pill"><span class="dot off"></span> недоступно</span>
        <span id="show-breadcrumb" style="margin-left:auto;opacity:.7;font-size:13px"></span>
      </div>

      <div id="hall-root">
        <!-- сюда рендерим сцену + ряды -->
      </div>

      <div class="panel">
        <input id="buyer-name" placeholder="Ваше ім’я та прізвище">
        <input id="buyer-phone" placeholder="+380…" >
        <input id="buyer-email" placeholder="you@example.com">
        <div id="summary" style="opacity:.8">Вибрано місць: 0 • Сума: 0 грн</div>
        <button id="pay-btn" class="btn-primary">Перейти до оплати</button>
      </div>
    </main>

    <div id="site-footer" style="margin-top:18px"></div>
  </div>

  <script src="/site-081125/scripts/include.js"></script>
  <script>
// ================== НАСТРОЙКИ ==================
const HALL_CONFIG = {
  academy: {
    hallJson: '/site-081125/data/hall/academy/academy.json',
    stageTitle: 'Сцена'
  },
  shevchenko: {
    hallJson: '/site-081125/data/hall/shevchenko/velyka.json',
    stageTitle: 'Велика сцена'
  }
};

// ID / селекторы контейнера зала.
// Скрипт попробует найти один из них.
const HALL_ROOT_SELECTORS = [
  '#hall-root',
  '#hall',
  '.hall-wrapper',
  '.hall-layout',
  '.hall-container',
  'main .hall'
];

// ================== СТИЛИ ДЛЯ ЗАЛА ==================
(function injectHallStyles () {
  const css = `
  .va-hall-wrapper {
    max-width: 960px;
    margin: 0 auto 40px;
  }
  .va-stage {
    width: 100%;
    background: #222;
    color: #fff;
    text-align: center;
    padding: 10px 0;
    margin-bottom: 16px;
    border-radius: 8px;
    font-weight: 600;
    font-size: 16px;
  }
  .va-hall-header {
    margin-bottom: 12px;
    font-size: 14px;
    color: #555;
    text-align: center;
  }
  .va-rows-container {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }
  .va-row-line {
    display: flex;
    align-items: center;
    justify-content: flex-start;
  }
  .va-row-label {
    width: 60px;
    text-align: right;
    margin-right: 8px;
    font-size: 12px;
    color: #555;
    flex-shrink: 0;
  }
  .va-row-seats {
    display: flex;
    flex-wrap: nowrap;
    gap: 4px;
    align-items: center;
  }
  .va-seat-btn {
    min-width: 26px;
    height: 26px;
    padding: 0;
    border-radius: 6px;
    border: 1px solid #ccc;
    background: #f8f9fa;
    font-size: 12px;
    line-height: 24px;
    text-align: center;
    cursor: pointer;
    box-sizing: border-box;
  }
  .va-seat-btn:hover {
    background: #e2e6ea;
  }
  .va-seat-btn.va-selected {
    background: #2f76ff;
    color: #fff;
    border-color: #2f76ff;
  }
  .va-seat-btn.va-taken {
    background: #ddd;
    color: #888;
    border-color: #ccc;
    cursor: default;
  }
  .va-seat-gap {
    width: 12px;
    height: 1px;
  }
  .va-row-gap-after {
    margin-bottom: 10px;
  }
  .va-row-offset {
    /* визуальный сдвиг ряда с offset */
    margin-left: 8px;
  }
  @media (max-width: 600px) {
    .va-seat-btn {
      min-width: 24px;
      height: 24px;
      font-size: 11px;
      line-height: 22px;
    }
    .va-row-label {
      width: 50px;
      font-size: 11px;
    }
  }`;
  const style = document.createElement('style');
  style.textContent = css;
  document.head.appendChild(style);
})();

// ================== ПОМОЩНИКИ ==================
function getHallRoot () {
  for (const sel of HALL_ROOT_SELECTORS) {
    const el = document.querySelector(sel);
    if (el) return el;
  }
  // если не нашли — создаём новый контейнер сразу под заголовком
  const main = document.querySelector('main') || document.body;
  const wrapper = document.createElement('div');
  wrapper.id = 'hall-root';
  main.appendChild(wrapper);
  return wrapper;
}

// Вытянуть theatre / show из ?show=academy%2Fchorni-doshky
function parseShowParam () {
  const params = new URLSearchParams(window.location.search);
  const showParam = params.get('show') || '';
  const [theatre, showSlug] = showParam.split('/');
  return { theatre, showSlug, raw: showParam };
}

// найти цену по зонам
function getSeatPrice (rowObj, seatNum) {
  if (!rowObj.zones) return 0;
  const z = rowObj.zones.find(
    zone => seatNum >= zone.from && seatNum <= zone.to
  );
  return z ? z.price : 0;
}

// ================== РЕНДЕР ЗАЛА ==================
async function buildHall () {
  const hallRoot = getHallRoot();
  if (!hallRoot) return;

  const { theatre = '', showSlug = '' } = parseShowParam();
  const theatreKey = theatre === 'academy' ? 'academy' : 'shevchenko';
  const cfg = HALL_CONFIG[theatreKey];

  // корневой wrapper для нашего зала
  const wrapper = document.createElement('div');
  wrapper.className = 'va-hall-wrapper';
  hallRoot.innerHTML = '';
  hallRoot.appendChild(wrapper);

  // заголовок над сценой
  const header = document.createElement('div');
  header.className = 'va-hall-header';
  header.textContent = theatreKey === 'academy'
    ? `Академія руху • ${showSlug || ''}`
    : `Театр ім. Шевченка • ${showSlug || ''}`;
  wrapper.appendChild(header);

  // сцена
  const stage = document.createElement('div');
  stage.className = 'va-stage';
  stage.textContent = cfg.stageTitle;
  wrapper.appendChild(stage);

  // контейнер рядов
  const rowsContainer = document.createElement('div');
  rowsContainer.className = 'va-rows-container';
  wrapper.appendChild(rowsContainer);

  // грузим JSON схемы
  let scheme;
  try {
    const resp = await fetch(cfg.hallJson);
    scheme = await resp.json();
  } catch (e) {
    console.error('Не удалось загрузить схему зала:', e);
    rowsContainer.textContent = 'Не вдалося завантажити схему залу.';
    return;
  }

  const rows = scheme.rows || [];

  rows.forEach(rowObj => {
    const rowLine = document.createElement('div');
    rowLine.className = 'va-row-line';
    if (rowObj.gapAfter) rowLine.classList.add('va-row-gap-after');

    // метка ряда
    const rowLabel = document.createElement('div');
    rowLabel.className = 'va-row-label';
    rowLabel.textContent = `Ряд ${rowObj.row}`;
    rowLine.appendChild(rowLabel);

    // блок кресел
    const seatsBox = document.createElement('div');
    seatsBox.className = 'va-row-seats';

    // offset (для первого ряда Академии — смещение к центру)
    if (rowObj.offset && Number.isFinite(rowObj.offset)) {
      // 30px ~ ширина одного места с зазором
      seatsBox.style.marginLeft = (rowObj.offset * 30) + 'px';
    }

    const aisles = rowObj.aisles || [];

    for (let seatNum = 1; seatNum <= rowObj.seats; seatNum++) {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'va-seat-btn';
      btn.textContent = seatNum;
      btn.dataset.row = rowObj.row;
      btn.dataset.seat = seatNum;

      const price = getSeatPrice(rowObj, seatNum);
      if (price) {
        btn.dataset.price = String(price);
        btn.title = `${price} грн`;
      }

      seatsBox.appendChild(btn);

      // если здесь проход — добавляем визуальный просвет
      if (aisles.includes(seatNum)) {
        const gap = document.createElement('div');
        gap.className = 'va-seat-gap';
        seatsBox.appendChild(gap);
      }
    }

    rowLine.appendChild(seatsBox);
    rowsContainer.appendChild(rowLine);
  });

  // ================== ЛОГИКА ВЫБОРА МЕСТ ==================
  const selected = new Set();

  function getKey (btn) {
    return `${btn.dataset.row}-${btn.dataset.seat}`;
  }

  function updateSummary () {
    const count = selected.size;
    let sum = 0;
    selected.forEach(btn => {
      const p = Number(btn.dataset.price || '0');
      sum += p;
    });

    // пытаемся найти текст "Вибрано місць: X • Сума: Y грн" и обновить его
    const summaryEl = document.querySelector('.order-summary, .hall-summary');
    if (summaryEl) {
      summaryEl.textContent = `Вибрано місць: ${count} • Сума: ${sum} грн`;
    } else {
      // запасной вариант: ищем кусок текста внизу страницы
      const allPs = Array.from(document.querySelectorAll('p, div'));
      const target = allPs.find(el =>
        /Вибрано місц/i.test(el.textContent || '')
      );
      if (target) {
        target.textContent = `Вибрано місць: ${count} • Сума: ${sum} грн`;
      }
    }

    // сумму можно также записать в скрытое поле формы для LiqPay
    const sumInput = document.querySelector('input[name="amount"], input[name="liqpay_amount"]');
    if (sumInput) sumInput.value = String(sum);
  }

  rowsContainer.addEventListener('click', (e) => {
    const btn = e.target.closest('.va-seat-btn');
    if (!btn) return;
    if (btn.classList.contains('va-taken')) return;

    const key = getKey(btn);
    if (selected.has(btn)) {
      selected.delete(btn);
      btn.classList.remove('va-selected');
    } else {
      selected.add(btn);
      btn.classList.add('va-selected');
    }

    updateSummary();
  });

  // начальное состояние
  updateSummary();
}

// запускаем после загрузки DOM
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', buildHall);
} else {
  buildHall();
}
</script>

</body>
</html>
