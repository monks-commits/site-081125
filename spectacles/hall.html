<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Вибір місць — Ваш Адмін</title>
  <link rel="icon" href="data:,">
  <link rel="stylesheet" href="../styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <!-- шапка -->
  <div id="site-header"></div>

  <main class="main" style="max-width:1100px;margin:0 auto;padding:16px">
    <h1>Вибір місць</h1>
    <p id="show-label" style="color:#64748b;margin-bottom:12px;">Вистава: —</p>

    <!-- схема залу -->
    <section class="section" style="background:#fff;border-radius:14px;padding:18px;margin-bottom:18px;">
      <!-- кнопки масштабу -->
      <div class="hall-zoom-controls" style="display:flex;justify-content:flex-end;gap:6px;margin-bottom:8px;">
        <button type="button" id="zoom-out"
                style="width:32px;height:32px;border-radius:16px;border:1px solid #d0d5dd;background:#fff;font-size:18px;line-height:1;">
          −
        </button>
        <button type="button" id="zoom-in"
                style="width:32px;height:32px;border-radius:16px;border:1px solid #d0d5dd;background:#fff;font-size:18px;line-height:1;">
          +
        </button>
      </div>

      <div class="hall-wrapper">
        <div id="hall-inner">
          <div class="hall-stage">СЦЕНА</div>
          <div id="hall-rows"></div>
        </div>
      </div>

      <p id="hall-error" style="color:#b91c1c;display:none;margin-top:10px;"></p>
    </section>

    <!-- форма покупця + сума -->
    <section class="section" style="background:#fff;border-radius:14px;padding:18px;">
      <h2 style="margin-top:0;">Дані покупця</h2>
      <div class="form-row" style="display:flex;gap:12px;flex-wrap:wrap;">
        <div style="flex:1 1 260px;">
          <label for="buyer-name" style="font-size:14px;">Ім’я та прізвище</label>
          <input id="buyer-name" type="text" autocomplete="name"
                 placeholder="Ваше ім’я та прізвище"
                 style="width:100%;height:44px;border-radius:10px;border:1px solid #d0d5dd;padding:0 12px;font-size:15px;">
        </div>
        <div style="flex:1 1 200px;">
          <label for="buyer-phone" style="font-size:14px;">Телефон</label>
          <input id="buyer-phone" type="tel" inputmode="tel" autocomplete="tel"
                 placeholder="+380..."
                 style="width:100%;height:44px;border-radius:10px;border:1px solid #d0d5dd;padding:0 12px;font-size:15px;">
        </div>
      </div>
      <div style="margin-top:10px;">
        <label for="buyer-email" style="font-size:14px;">Електронна пошта (куди надійде квиток)</label>
        <input id="buyer-email" type="email" inputmode="email" autocomplete="email"
               placeholder="you@example.com"
               style="width:100%;height:44px;border-radius:10px;border:1px solid #d0d5dd;padding:0 12px;font-size:15px;">
      </div>

      <p style="margin-top:16px;">
        Вибрано місць: <b><span id="seat-count">0</span></b> •
        Сума до сплати: <b><span id="total-amount">0</span> грн</b>
      </p>

      <button id="pay-button" class="primary-btn" disabled>
        Перейти до оплати
      </button>

      <p id="pay-error" style="color:#b91c1c;margin-top:10px;display:none;"></p>
      <p class="muted" style="margin-top:8px;font-size:13px;color:#6b7280;">
        Після оплати ви повернетеся на сайт, а квитки надійдуть на вказану пошту.
      </p>
    </section>
  </main>

  <!-- подвал -->
  <div id="site-footer"></div>

  <!-- інклюди -->
  <script src="/scripts/include.js"></script>

  <script>
    // =============== НАСТРОЙКИ SUPABASE + EDGE-ФУНКЦІЇ ===============
    const SUPABASE_URL = 'https://yqhzekifwxotizsmaeaf.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlxaHpla2lmd3hvdGl6c21hZWFmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEyMzQyNjgsImV4cCI6MjA3NjgxMDI2OH0.lUoppCppKZisZdyOrreCov_-xEOCvGuwxd28XZY4O_k';

    const LIQPAY_FN_URL =
      'https://yqhzekifwxotizsmaeaf.supabase.co/functions/v1/liqpay-create-index-ts';

    const supabaseClient = window.supabase.createClient(
      SUPABASE_URL,
      SUPABASE_ANON_KEY
    );

    // =============== ОПРЕДЕЛЯЕМ ВИСТАВУ І ЗАЛ ===============
    const urlParams = new URLSearchParams(window.location.search);
    const showSlug = urlParams.get('show') || '';
    const showLabelEl = document.getElementById('show-label');

    if (showSlug) {
      showLabelEl.textContent = 'Вистава: ' + showSlug.replace('/', ' — ');
    } else {
      showLabelEl.textContent = 'Вистава не визначена (show=...)';
    }

    function getTheatreKey(slug) {
      if (!slug) return 'shevchenko';
      if (slug.startsWith('shevchenko')) return 'shevchenko';
      if (slug.startsWith('academy')) return 'academy';
      return 'shevchenko';
    }

    const theatreKey = getTheatreKey(showSlug);

    const HALL_URLS = {
      shevchenko: '/data/hall/shevchenko/velyka.json',
      academy:    '/data/hall/academy/academy.json',
    };

    const hallDataUrl   = HALL_URLS[theatreKey];
    const hallRowsEl    = document.getElementById('hall-rows');
    const hallErrorEl   = document.getElementById('hall-error');
    const seatCountEl   = document.getElementById('seat-count');
    const totalAmountEl = document.getElementById('total-amount');
    const payButton     = document.getElementById('pay-button');
    const payErrorEl    = document.getElementById('pay-error');

    const hallInnerEl   = document.getElementById('hall-inner');
    const zoomInBtn     = document.getElementById('zoom-in');
    const zoomOutBtn    = document.getElementById('zoom-out');

    const selectedSeats = new Set();     // P{row}-M{seat}
    let hallConfig      = null;
    let takenSeatIds    = new Set();     // з таблиці bookings

    // масштаб схеми
    let hallScale = 1;
    const MIN_SCALE = 0.6;
    const MAX_SCALE = 2.2;
    const SCALE_STEP = 0.25;

    function applyHallScale() {
      if (!hallInnerEl) return;
      hallInnerEl.style.transform = 'scale(' + hallScale + ')';
      hallInnerEl.style.transformOrigin = 'top left';
    }

    if (zoomInBtn) {
      zoomInBtn.addEventListener('click', () => {
        hallScale = Math.min(MAX_SCALE, hallScale + SCALE_STEP);
        applyHallScale();
      });
    }

    if (zoomOutBtn) {
      zoomOutBtn.addEventListener('click', () => {
        hallScale = Math.max(MIN_SCALE, hallScale - SCALE_STEP);
        applyHallScale();
      });
    }

    // =============== ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ ===============
    function showInlineError(el, msg) {
      el.textContent = msg;
      el.style.display = 'block';
    }

    function hideInlineError(el) {
      el.textContent = '';
      el.style.display = 'none';
    }

    function computeSeatPrice(rowCfg, seatNumber) {
      if (!rowCfg || !Array.isArray(rowCfg.zones)) return 0;
      const z = rowCfg.zones.find(
        (zone) => seatNumber >= zone.from && seatNumber <= zone.to
      );
      return z ? Number(z.price || 0) : 0;
    }

    function updateSummary() {
      const ids = Array.from(selectedSeats);
      seatCountEl.textContent = ids.length.toString();

      let sum = 0;
      ids.forEach((seatId) => {
        const [rowPart, seatPart] = seatId.split('-'); // P12-M5
        const rowNum  = parseInt(rowPart.slice(1), 10);
        const seatNum = parseInt(seatPart.slice(1), 10);
        const rowCfg  = hallConfig.rows.find(r => r.row === rowNum);
        sum += computeSeatPrice(rowCfg, seatNum);
      });

      totalAmountEl.textContent = sum.toString();
      payButton.disabled = (ids.length === 0);
    }

    // =============== РЕНДЕР ЗАЛУ ===============
    function renderHall() {
      if (!hallConfig || !Array.isArray(hallConfig.rows)) {
        hallRowsEl.innerHTML = '';
        showInlineError(hallErrorEl, 'Не вдалося завантажити схему залу.');
        return;
      }

      const isAcademyHall =
        theatreKey === 'academy' ||
        (hallConfig.name && hallConfig.name.includes('Академія руху'));

      hallRowsEl.innerHTML = '';
      hideInlineError(hallErrorEl);
      selectedSeats.clear();
      updateSummary();

      hallConfig.rows.forEach((rowCfg) => {
        const rowNum     = rowCfg.row;
        const seatsCount = rowCfg.seats;
        const aisles     = Array.isArray(rowCfg.aisles) ? rowCfg.aisles : [];

        const rowDiv = document.createElement('div');
        rowDiv.className = 'hall-row';

        const labelDiv = document.createElement('div');
        labelDiv.className = 'hall-row-label';
        labelDiv.textContent = rowNum;
        rowDiv.appendChild(labelDiv);

        const seatsWrap = document.createElement('div');
        seatsWrap.className = 'hall-row-seats';

        // сдвиг ряда (offset) — важно для 1-го ряда Академії
        const offset = rowCfg.offset || 0;
        if (offset > 0) {
          seatsWrap.style.marginLeft = `${offset * 30}px`;
        }

        for (let s = 1; s <= seatsCount; s++) {
          // вертикальний прохід?
          if (aisles.includes(s)) {
            const aisleDiv = document.createElement('div');
            aisleDiv.className = 'hall-aisle';
            seatsWrap.appendChild(aisleDiv);
          }

          const seatId = `P${rowNum}-M${s}`;
          const price  = computeSeatPrice(rowCfg, s);

          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'hall-seat';
          btn.dataset.seatId = seatId;
          btn.textContent = s.toString();
          btn.title = `Ряд ${rowNum}, місце ${s}${price ? ' — ' + price + ' грн' : ''}`;

          const isTakenByBooking = takenSeatIds.has(seatId);

          if (isAcademyHall) {
            // Поки немає квот — весь зал Академії сірий і неактивний
            btn.classList.add('taken');
            btn.disabled = true;
          } else if (isTakenByBooking) {
            btn.classList.add('taken');
            btn.disabled = true;
          } else {
            btn.addEventListener('click', () => {
              if (btn.disabled || btn.classList.contains('taken')) {
                return;
              }
              if (btn.classList.contains('selected')) {
                btn.classList.remove('selected');
                selectedSeats.delete(seatId);
              } else {
                btn.classList.add('selected');
                selectedSeats.add(seatId);
              }
              updateSummary();
            });
          }

          seatsWrap.appendChild(btn);
        }

        rowDiv.appendChild(seatsWrap);
        hallRowsEl.appendChild(rowDiv);

        // горизонтальний прохід між блоками рядiв
        if (rowCfg.gapAfter) {
          const gapRow = document.createElement('div');
          gapRow.className = 'hall-row-gap';
          hallRowsEl.appendChild(gapRow);
        }
      });

      // на всякий случай применим текущий масштаб
      applyHallScale();
    }

    // =============== ЗАГРУЗКА СХЕМЫ + БРОНІ ===============
    async function loadHallAndBookings() {
      try {
        const hallResp = await fetch(hallDataUrl, { cache: 'no-store' });
        if (!hallResp.ok) {
          throw new Error('Hall not found: ' + hallDataUrl);
        }
        hallConfig = await hallResp.json();

        if (!showSlug) {
          takenSeatIds = new Set();
          renderHall();
          return;
        }

        const nowIso = new Date().toISOString();

        const { data: bookings, error: bookingsError } = await supabaseClient
          .from('bookings')
          .select('seat_id, expires_at, show_slug')
          .eq('show_slug', showSlug);

        if (bookingsError) {
          console.warn('bookingsError', bookingsError);
          takenSeatIds = new Set();
        } else {
          takenSeatIds = new Set(
            (bookings || [])
              .filter(b => !b.expires_at || b.expires_at > nowIso)
              .map(b => b.seat_id)
          );
        }

        renderHall();
      } catch (e) {
        console.error(e);
        showInlineError(hallErrorEl, 'Помилка завантаження залу: ' + e.message);
      }
    }

    // =============== СОЗДАНИЕ ЗАКАЗА + ВЫЗОВ LIQPAY ===============
    async function handlePayButtonClick() {
      hideInlineError(payErrorEl);

      try {
        const selected = Array.from(selectedSeats);
        if (!selected.length) {
          showInlineError(payErrorEl, 'Будь ласка, оберіть хоча б одне місце.');
          return;
        }

        const buyerName  = document.getElementById('buyer-name').value.trim();
        const buyerPhone = document.getElementById('buyer-phone').value.trim();
        const buyerEmail = document.getElementById('buyer-email').value.trim();

        if (!buyerName || !buyerPhone || !buyerEmail) {
          showInlineError(payErrorEl, 'Заповніть, будь ласка, всі поля покупця.');
          return;
        }

        const amount = Number(totalAmountEl.textContent || '0');
        if (!amount || isNaN(amount)) {
          showInlineError(payErrorEl, 'Не вдалося визначити суму замовлення.');
          return;
        }

        if (!showSlug) {
          showInlineError(payErrorEl, 'Не вдалося визначити виставу (show).');
          return;
        }

        const currency = 'UAH';
        const prefix   = showSlug.startsWith('shevchenko') ? 'SHEV' : 'AKAD';
        const orderId  = prefix + '-' + Date.now();

        // 1) INSERT в orders
        const { data: orderRow, error: orderError } = await supabaseClient
          .from('orders')
          .insert({
            order_id:    orderId,
            show_slug:   showSlug,
            seats:       selected,
            amount:      amount,
            currency:    currency,
            buyer_name:  buyerName,
            buyer_phone: buyerPhone,
            buyer_email: buyerEmail,
            status:      'pending'
          })
          .select()
          .single();

        if (orderError) {
          console.error('orderError', orderError);
          showInlineError(payErrorEl, 'Помилка при створенні замовлення. Спробуйте ще раз.');
          return;
        }

        // 2) Броні в bookings
        const HOLD_MINUTES = 15;
        const now       = new Date();
        const expiresAt = new Date(now.getTime() + HOLD_MINUTES * 60 * 1000).toISOString();

        const bookingsPayload = selected.map(seatId => ({
          show_slug:   showSlug,
          seat_id:     seatId,
          buyer_name:  buyerName,
          buyer_phone: buyerPhone,
          created_at:  now.toISOString(),
          expires_at:  expiresAt
        }));

        const { error: bookingsError } = await supabaseClient
          .from('bookings')
          .insert(bookingsPayload);

        if (bookingsError) {
          console.warn('bookingsError (не критично для оплати)', bookingsError);
        }

        // 3) Вызов Edge-функції LiqPay
        const baseOrigin = window.location.origin;
        const resultUrl = baseOrigin + '/spectacles/success.html';
        const serverUrl = baseOrigin + '/spectacles/liqpay-callback.html';

        payButton.disabled = true;

        const resp = await fetch(LIQPAY_FN_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            apikey: SUPABASE_ANON_KEY
          },
          body: JSON.stringify({
            order_id:     orderId,
            show_slug:    showSlug,
            seats:        selected,
            amount,
            currency,
            description:  'Квитки: ' + showSlug,
            buyer_name:   buyerName,
            buyer_phone:  buyerPhone,
            buyer_email:  buyerEmail,
            result_url:   resultUrl,
            server_url:   serverUrl
          })
        });

        if (!resp.ok) {
          const text = await resp.text();
          console.error('LiqPay fn error:', text);
          showInlineError(payErrorEl, 'Помилка при створенні рахунку LiqPay.');
          payButton.disabled = false;
          return;
        }

        const data = await resp.json();
        console.log('LiqPay fn response:', data);

        if (!data || !data.checkout_url) {
          showInlineError(payErrorEl, 'Сервер не повернув посилання на оплату.');
          payButton.disabled = false;
          return;
        }

        window.location.href = data.checkout_url;
      } catch (e) {
        console.error(e);
        showInlineError(payErrorEl, 'Неочікувана помилка: ' + e.message);
        payButton.disabled = false;
      }
    }

    payButton.addEventListener('click', (e) => {
      e.preventDefault();
      handlePayButtonClick();
    });

    // старт
    applyHallScale();
    loadHallAndBookings();
  </script>
</body>
</html>
