<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Вибір місць — Ваш Адмін</title>
<link rel="icon" href="data:,">
<link rel="stylesheet" href="../styles.css">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
.hall-wrapper{overflow-x:auto;padding:10px;border:1px solid #e5e7eb;border-radius:10px;}
#hall-inner{transform-origin:top left;display:inline-block;}
.hall-stage{background:#e5e7eb;text-align:center;padding:6px 0;margin-bottom:10px;border-radius:6px;font-weight:600;}
.hall-row{display:flex;align-items:center;margin-bottom:4px;}
.hall-row-label{width:28px;text-align:right;margin-right:6px;font-size:14px;color:#475569;}
.hall-row-seats{display:flex;gap:4px;}
.hall-seat{width:26px;height:26px;border-radius:4px;border:1px solid #94a3b8;background:#facc15;font-size:12px;cursor:pointer;}
.hall-seat.selected{outline:2px solid #2563eb;}
.hall-seat.taken{background:#b91c1c;color:#fff;cursor:not-allowed;}
.hall-seat.sold{background:#94a3b8;color:#fff;cursor:not-allowed;}
.hall-aisle{width:4px;}
@media(max-width:600px){
  .hall-seat{width:22px;height:22px;font-size:11px;}
  .hall-row-label{font-size:12px;width:24px;}
}
</style>
</head>

<body>
<div id="site-header"></div>

<main class="main" style="max-width:1100px;margin:0 auto;padding:16px">
<h1>Вибір місць</h1>
<p id="show-label" style="color:#64748b;margin-bottom:12px;">Вистава: —</p>

<section class="section" style="background:#fff;border-radius:14px;padding:18px;margin-bottom:18px;">
<div class="hall-zoom-controls" style="display:flex;justify-content:flex-end;gap:6px;margin-bottom:8px;">
<button id="zoom-out" style="width:32px;height:32px;border-radius:16px;border:1px solid #d0d5dd;background:#fff;font-size:18px;">−</button>
<button id="zoom-in" style="width:32px;height:32px;border-radius:16px;border:1px solid #d0d5dd;background:#fff;font-size:18px;">+</button>
</div>

<div class="hall-wrapper">
  <div id="hall-inner">
    <div class="hall-stage">СЦЕНА</div>
    <div id="hall-rows"></div>
  </div>
</div>

<p id="hall-error" style="color:#b91c1c;display:none;margin-top:10px;"></p>
</section>

<section class="section" style="background:#fff;border-radius:14px;padding:18px;">
<h2 style="margin-top:0;">Дані покупця</h2>

<div style="display:flex;gap:12px;flex-wrap:wrap;">
  <div style="flex:1 1 260px;">
    <label for="buyer-name" style="font-size:14px;">Ім’я та прізвище</label>
    <input id="buyer-name" type="text" autocomplete="name" placeholder="Ваше ім’я та прізвище"
    style="width:100%;height:44px;border-radius:10px;border:1px solid #d0d5dd;padding:0 12px;font-size:15px;">
  </div>

  <div style="flex:1 1 200px;">
    <label for="buyer-phone" style="font-size:14px;">Телефон</label>
    <input id="buyer-phone" type="tel" placeholder="+380..."
    style="width:100%;height:44px;border-radius:10px;border:1px solid #d0d5dd;padding:0 12px;font-size:15px;">
  </div>
</div>

<label for="buyer-email" style="font-size:14px;margin-top:10px;display:block;">Електронна пошта</label>
<input id="buyer-email" type="email" placeholder="you@example.com"
style="width:100%;height:44px;border-radius:10px;border:1px solid #d0d5dd;padding:0 12px;font-size:15px;">

<p style="margin-top:16px;">Вибрано місць: <b><span id="seat-count">0</span></b> • Сума: <b><span id="total-amount">0</span> грн</b></p>

<button id="pay-button" class="primary-btn" disabled>Перейти до оплати</button>
<p id="pay-error" style="color:#b91c1c;margin-top:10px;display:none;"></p>
</section>
</main>

<div id="site-footer"></div>
<script src="/scripts/include.js"></script>

<script>
const SUPABASE_URL='https://yqhzekifwxotizsmaeaf.supabase.co';
const SUPABASE_ANON_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlxaHpla2lmd3hvdGl6c21hZWFmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEyMzQyNjgsImV4cCI6MjA3NjgxMDI2OH0.lUoppCppKZisZdyOrreCov_-xEOCvGuwxd28XZY4O_k';
const supabaseClient=window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);

const params=new URLSearchParams(location.search);
const showSlug=params.get('show')||'';
document.getElementById('show-label').textContent=showSlug?'Вистава: '+showSlug:'Вистава не визначена';

function getTheatre(slug){
  if(slug.startsWith('shevchenko'))return 'shevchenko';
  if(slug.startsWith('academy'))return 'academy';
  return 'shevchenko';
}

const theatre=getTheatre(showSlug);
const HALL={
 shevchenko:'/data/hall/shevchenko/velyka.json',
 academy:'/data/hall/academy/academy.json'
};

let hallConfig=null, takenSeats=new Set(), selected=new Set();
const hallRows=document.getElementById('hall-rows');

function seatPrice(rowCfg,seat){
  if(!rowCfg.zones)return 0;
  const z=rowCfg.zones.find(z=>seat>=z.from&&seat<=z.to);
  return z?z.price:0;
}

function renderHall(){
 hallRows.innerHTML='';
 selected.clear();
 let isAcademy=theatre==='academy';

 hallConfig.rows.forEach(rowCfg=>{
   const row=document.createElement('div');
   row.className='hall-row';

   const lbl=document.createElement('div');
   lbl.className='hall-row-label';
   lbl.textContent=rowCfg.row;
   row.appendChild(lbl);

   const wrap=document.createElement('div');
   wrap.className='hall-row-seats';

   for(let s=1;s<=rowCfg.seats;s++){
     if(rowCfg.aisles.includes(s)){
       const a=document.createElement('div');
       a.className='hall-aisle';
       wrap.appendChild(a);
     }

     const id=`P${rowCfg.row}-M${s}`;
     const btn=document.createElement('button');
     btn.type='button';
     btn.className='hall-seat';
     btn.dataset.id=id;
     btn.textContent=s;

     const pr=seatPrice(rowCfg,s);
     btn.title=`Ряд ${rowCfg.row}, місце ${s}${pr?' — '+pr+' грн':''}`;

     const taken=takenSeats.has(id);

     if(isAcademy){
       btn.classList.add('sold'); btn.disabled=true;
     } else if(taken){
       btn.classList.add('taken'); btn.disabled=true;
     } else {
       btn.onclick=()=>{
         if(btn.classList.contains('selected')){
           btn.classList.remove('selected'); selected.delete(id);
         } else {
           btn.classList.add('selected'); selected.add(id);
         }
         updateSummary();
       }
     }
     wrap.appendChild(btn);
   }

   row.appendChild(wrap);
   hallRows.appendChild(row);
 });
}

function updateSummary(){
 document.getElementById('seat-count').textContent=selected.size;
 let sum=0;
 selected.forEach(id=>{
   const [r,m]=id.split('-');
   const rowNum=+r.slice(1);
   const seat=+m.slice(1);
   const rowCfg=hallConfig.rows.find(r=>r.row===rowNum);
   sum+=seatPrice(rowCfg,seat);
 });
 document.getElementById('total-amount').textContent=sum;
 document.getElementById('pay-button').disabled=(selected.size===0);
}

async function load(){
 const hall=await fetch(HALL[theatre],{cache:'no-store'}).then(r=>r.json());
 hallConfig=hall;

 if(!showSlug){renderHall();return;}

 const now=new Date().toISOString();
 const {data}=await supabaseClient.from('bookings')
   .select('seat_id,expires_at,show_slug')
   .eq('show_slug',showSlug);

 takenSeats=new Set((data||[])
   .filter(b=>!b.expires_at||b.expires_at>now)
   .map(b=>b.seat_id));

 renderHall();
}

document.getElementById('zoom-in').onclick=()=>{zoom(0.2)};
document.getElementById('zoom-out').onclick=()=>{zoom(-0.2)};
let scale=1; function zoom(v){scale=Math.max(0.6,Math.min(2.2,scale+v));document.getElementById('hall-inner').style.transform=`scale(${scale})`;};

load();
</script>
</body>
</html>
