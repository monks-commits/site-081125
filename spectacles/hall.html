<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Вибір місць — Ваш Адмін</title>
  <link rel="icon" href="data:,">
  <link rel="stylesheet" href="../styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <!-- шапка -->
  <div id="site-header"></div>

  <main class="main" style="max-width:1100px;margin:0 auto;padding:16px">
    <h1>Вибір місць</h1>
    <p id="show-label" style="color:#64748b;margin-bottom:12px;">Вистава: —</p>

    <!-- схема залу -->
    <section class="section" style="background:#fff;border-radius:14px;padding:18px;margin-bottom:18px;">
      <div class="hall-wrapper">
        <div class="hall-stage">СЦЕНА</div>
        <div id="hall-rows"></div>
      </div>
      <p id="hall-error" style="color:#b91c1c;display:none;margin-top:10px;"></p>
    </section>

    <!-- форма покупця + сума -->
    <section class="section" style="background:#fff;border-radius:14px;padding:18px;">
      <h2 style="margin-top:0;">Дані покупця</h2>
      <div class="form-row" style="display:flex;gap:12px;flex-wrap:wrap;">
        <div style="flex:1 1 260px;">
          <label for="buyer-name" style="font-size:14px;">Ім’я та прізвище</label>
          <input id="buyer-name" type="text" autocomplete="name"
                 placeholder="Ваше ім’я та прізвище"
                 style="width:100%;height:44px;border-radius:10px;border:1px solid #d0d5dd;padding:0 12px;font-size:15px;">
        </div>
        <div style="flex:1 1 200px;">
          <label for="buyer-phone" style="font-size:14px;">Телефон</label>
          <input id="buyer-phone" type="tel" inputmode="tel" autocomplete="tel"
                 placeholder="+380..."
                 style="width:100%;height:44px;border-radius:10px;border:1px solid #d0d5dd;padding:0 12px;font-size:15px;">
        </div>
      </div>
      <div style="margin-top:10px;">
        <label for="buyer-email" style="font-size:14px;">Електронна пошта (куди надійде квиток)</label>
        <input id="buyer-email" type="email" inputmode="email" autocomplete="email"
               placeholder="you@example.com"
               style="width:100%;height:44px;border-radius:10px;border:1px solid #d0d5dd;padding:0 12px;font-size:15px;">
      </div>

      <p style="margin-top:16px;">
        Вибрано місць: <b><span id="seat-count">0</span></b> •
        Сума до сплати: <b><span id="total-amount">0</span> грн</b>
      </p>

      <button id="pay-button" class="primary-btn" disabled>
        Перейти до оплати
      </button>

      <p id="pay-error" style="color:#b91c1c;margin-top:10px;display:none;"></p>
      <p class="muted" style="margin-top:8px;font-size:13px;color:#6b7280;">
        Після оплати ви повернетеся на сайт, а квитки надійдуть на вказану пошту.
      </p>
    </section>
  </main>

  <!-- подвал -->
  <div id="site-footer"></div>

  <!-- інклюди -->
  <script src="/site-081125/scripts/include.js"></script>

  <script>
    // =============== НАСТРОЙКИ SUPABASE + EDGE-ФУНКЦІЇ ===============
    const SUPABASE_URL = 'https://yqhzekifwxotizsmaeaf.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlxaHpla2lmd3hvdGl6c21hZWFmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEyMzQyNjgsImV4cCI6MjA3NjgxMDI2OH0.lUoppCppKZisZdyOrreCov_-xEOCvGuwxd28XZY4O_k';

    const LIQPAY_FN_URL =
      'https://yqhzekifwxotizsmaeaf.supabase.co/functions/v1/liqpay-create-index-ts';

    const supabaseClient = window.supabase.createClient(
      SUPABASE_URL,
      SUPABASE_ANON_KEY
    );

    // =============== КВОТЫ ДЛЯ ТРЁХ ВИСТАВ ===============
    // shevchenko/za-dvoma-zaytsiamy → блок A
    // shevchenko/zerna-shchastia    → блок B
    // shevchenko/sorochynskyi-yarmarok → блок C
    const QUOTAS = {
      "shevchenko/za-dvoma-zaytsiamy": [
        { row: 3,  from: 6,  to: 15, price: 200 },
        { row: 4,  from: 6,  to: 15, price: 180 },
        { row: 7,  from: 6,  to: 15, price: 170 },
        { row: 9,  from: 6,  to: 15, price: 160 },
        { row: 12, from: 6,  to: 15, price: 140 },
        { row: 13, from: 6,  to: 15, price: 120 },
        { row: 15, from: 6,  to: 15, price: 100 },
        { row: 17, from: 4,  to: 8,  price: 70 },
        { row: 17, from: 12, to: 16, price: 70 }
      ],
      "shevchenko/zerna-shchastia": [
        { row: 2,  from: 11, to: 15, price: 100 },
        { row: 3,  from: 11, to: 15, price: 100 },
        { row: 4,  from: 6,  to: 15, price: 90 },
        { row: 9,  from: 6,  to: 15, price: 80 },
        { row: 15, from: 6,  to: 15, price: 70 }
      ],
      "shevchenko/sorochynskyi-yarmarok": [
        { row: 3,  from: 6,  to: 15, price: 200 },
        { row: 4,  from: 6,  to: 15, price: 180 },
        { row: 7,  from: 6,  to: 15, price: 170 },
        { row: 9,  from: 6,  to: 15, price: 160 },
        { row: 12, from: 6,  to: 15, price: 140 },
        { row: 13, from: 6,  to: 15, price: 120 },
        { row: 15, from: 6,  to: 15, price: 100 },
        { row: 18, from: 6,  to: 15, price: 70 }
      ]
    };

    function getQuotaList() {
      return QUOTAS[showSlug] || null;
    }

    function getQuotaPrice(row, seat) {
      const list = getQuotaList();
      if (!list) return null;
      const q = list.find(q => q.row === row && seat >= q.from && seat <= q.to);
      return q ? q.price : null;
    }

    // =============== ОПРЕДЕЛЯЕМ ВИСТАВУ І ЗАЛ ===============
    const urlParams = new URLSearchParams(window.location.search);
    const showSlug = urlParams.get('show') || '';
    const showLabelEl = document.getElementById('show-label');

    if (showSlug) {
      showLabelEl.textContent = 'Вистава: ' + showSlug.replace('/', ' — ');
    } else {
      showLabelEl.textContent = 'Вистава не визначена (show=...)';
    }

    // По slug понимаем театр
    function getTheatreKey(slug) {
      if (!slug) return 'shevchenko';
      if (slug.startsWith('shevchenko')) return 'shevchenko';
      if (slug.startsWith('academy')) return 'academy';
      return 'shevchenko';
    }

    const theatreKey = getTheatreKey(showSlug);

    const HALL_URLS = {
      shevchenko: '/site-081125/data/hall/shevchenko/velyka.json',
      academy:    '/site-081125/data/hall/academy/academy.json',
    };

    const hallDataUrl = HALL_URLS[theatreKey];

    const hallRowsEl   = document.getElementById('hall-rows');
    const hallErrorEl  = document.getElementById('hall-error');
    const seatCountEl  = document.getElementById('seat-count');
    const totalAmountEl = document.getElementById('total-amount');
    const payButton    = document.getElementById('pay-button');
    const payErrorEl   = document.getElementById('pay-error');

    const selectedSeats = new Set(); // P{row}-M{seat}
    let hallConfig = null;
    let takenSeatIds = new Set(); // из таблицы bookings
    const rowPricesMap = new Map(); // row -> price (из квот)

    // =============== ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ ===============
    function showInlineError(el, msg) {
      el.textContent = msg;
      el.style.display = 'block';
    }

    function hideInlineError(el) {
      el.textContent = '';
      el.style.display = 'none';
    }

    function computeSeatPriceFromZones(rowCfg, seatNumber) {
      if (!rowCfg || !Array.isArray(rowCfg.zones)) return 0;
      const z = rowCfg.zones.find(
        (zone) => seatNumber >= zone.from && seatNumber <= zone.to
      );
      return z ? Number(z.price || 0) : 0;
    }

    function computeSeatPrice(rowCfg, rowNum, seatNum) {
      // если есть квоты для этого show — берём цену из квоты
      const qp = getQuotaPrice(rowNum, seatNum);
      if (qp !== null) return qp;
      // иначе — стандартная зона из hallConfig
      return computeSeatPriceFromZones(rowCfg, seatNum);
    }

    function updateSummary() {
      const ids = Array.from(selectedSeats);
      seatCountEl.textContent = ids.length.toString();

      let sum = 0;
      ids.forEach((seatId) => {
        const [rowPart, seatPart] = seatId.split('-'); // P12-M5
        const rowNum = parseInt(rowPart.slice(1), 10);
        const seatNum = parseInt(seatPart.slice(1), 10);
        const rowCfg = hallConfig.rows.find(r => r.row === rowNum);
        sum += computeSeatPrice(rowCfg, rowNum, seatNum);
      });

      totalAmountEl.textContent = sum.toString();
      payButton.disabled = (ids.length === 0);
    }

    // =============== РЕНДЕР ЗАЛУ ===============
    function renderHall() {
      if (!hallConfig || !Array.isArray(hallConfig.rows)) {
        hallRowsEl.innerHTML = '';
        showInlineError(hallErrorEl, 'Не вдалося завантажити схему залу.');
        return;
      }

      hallRowsEl.innerHTML = '';
      hideInlineError(hallErrorEl);
      selectedSeats.clear();
      updateSummary();

      // карта "ряд -> цена" по квоте (предполагаем одна цена на ряд)
      rowPricesMap.clear();
      const quotaList = getQuotaList();
      if (quotaList) {
        quotaList.forEach(q => {
          if (!rowPricesMap.has(q.row)) {
            rowPricesMap.set(q.row, q.price);
          }
        });
      }

      hallConfig.rows.forEach((rowCfg) => {
        const rowNum = rowCfg.row;
        const seatsCount = rowCfg.seats;
        const aisles = Array.isArray(rowCfg.aisles) ? rowCfg.aisles : [];

        const rowDiv = document.createElement('div');
        rowDiv.className = 'hall-row';

        // Метка ряда слева
        const labelDiv = document.createElement('div');
        labelDiv.className = 'row-label';
        labelDiv.textContent = rowNum;
        rowDiv.appendChild(labelDiv);

        // Контейнер мест
        const seatsWrap = document.createElement('div');
        seatsWrap.className = 'hall-row-seats';

        for (let s = 1; s <= seatsCount; s++) {
          // проход по вертикали
          if (aisles.includes(s)) {
            const aisleDiv = document.createElement('div');
            aisleDiv.className = 'aisle';
            seatsWrap.appendChild(aisleDiv);
          }

          const seatId = `P${rowNum}-M${s}`;

          const rowCfgLocal = rowCfg;
          const price = computeSeatPrice(rowCfgLocal, rowNum, s);
          const isInQuota = (getQuotaPrice(rowNum, s) !== null);

          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'seat';
          btn.dataset.seatId = seatId;
          btn.textContent = s.toString();
          btn.title = price
            ? `Ряд ${rowNum}, місце ${s} — ${price} грн`
            : `Ряд ${rowNum}, місце ${s}`;

          if (takenSeatIds.has(seatId)) {
            // занято в bookings
            btn.classList.add('taken');
            btn.disabled = true;
          } else {
            const hasQuotasForShow = !!quotaList;

            if (hasQuotasForShow) {
              // если для цього спектаклю є квоти:
              if (isInQuota) {
                // место в квоте → активное
                btn.classList.add('free'); // используем твоё из styles.css
                btn.addEventListener('click', () => {
                  if (btn.classList.contains('selected')) {
                    btn.classList.remove('selected');
                    selectedSeats.delete(seatId);
                  } else {
                    btn.classList.add('selected');
                    selectedSeats.add(seatId);
                  }
                  updateSummary();
                });
              } else {
                // не в квоте → недоступне (сіра кнопка без обробника)
                btn.disabled = true;
              }
            } else {
              // для спектаклів без QUOTAS — стара логіка: всі вільні місця активні
              btn.classList.add('free');
              btn.addEventListener('click', () => {
                if (btn.classList.contains('selected')) {
                  btn.classList.remove('selected');
                  selectedSeats.delete(seatId);
                } else {
                  btn.classList.add('selected');
                  selectedSeats.add(seatId);
                }
                updateSummary();
              });
            }
          }

          seatsWrap.appendChild(btn);
        }

        rowDiv.appendChild(seatsWrap);
        hallRowsEl.appendChild(rowDiv);

        // подпись под рядом, если есть квота для этого ряда
        if (rowPricesMap.has(rowNum)) {
          const priceLabel = document.createElement('div');
          priceLabel.style.margin = '2px 0 6px 34px';
          priceLabel.style.fontSize = '12px';
          priceLabel.style.color = '#6b7280';
          priceLabel.textContent = `Ряд ${rowNum} — ${rowPricesMap.get(rowNum)} грн`;
          hallRowsEl.appendChild(priceLabel);
        }

        // РАНЬШЕ ЗДЕСЬ БЫЛ rowCfg.gapAfter -> row-break-lg
        // Мы его НЕ используем, чтобы ряды были без горизонтального прохода.
      });
    }

    // =============== ЗАГРУЗКА СХЕМЫ + БРОНІ ===============
    async function loadHallAndBookings() {
      try {
        // 1) Схема залу
        const hallResp = await fetch(hallDataUrl, { cache: 'no-store' });
        if (!hallResp.ok) {
          throw new Error('Hall not found: ' + hallDataUrl);
        }
        hallConfig = await hallResp.json();

        // 2) Броні з bookings (непрострочені)
        if (!showSlug) {
          takenSeatIds = new Set();
          renderHall();
          return;
        }

        const nowIso = new Date().toISOString();

        const { data: bookings, error: bookingsError } = await supabaseClient
          .from('bookings')
          .select('seat_id, expires_at, show_slug')
          .eq('show_slug', showSlug);

        if (book
