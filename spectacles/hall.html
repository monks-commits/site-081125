<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Вибір місць — Ваш Адмін</title>
  <link rel="icon" href="data:,">
  <link rel="stylesheet" href="/site-081125/styles.css" />
  <style>
    .hall { display: grid; gap: 10px 8px; }
    .row { display: grid; grid-auto-flow: column; gap: 6px; align-items: center; }
    .row.gap-after { margin-bottom: 18px; }
    .row-label { width: 44px; opacity: .8; }
    .seat, .spacer, .aisle {
      width: 32px; height: 28px; display: inline-grid; place-items: center;
      border-radius: 6px; font-size: 14px;
    }
    .seat { border: 1px solid #c8ccd0; background:#fff; cursor: pointer; }
    .seat.taken { background:#e9eef3; color:#8aa; cursor:not-allowed; }
    .seat.selected { outline: 2px solid #2b77ff; }
    .spacer { visibility: hidden; }
    .aisle { width: 14px; background: transparent; }
    .legend { display:flex; gap:18px; align-items:center; margin:10px 0 18px;}
    .legend .dot { width:16px; height:16px; border-radius:4px; border:1px solid #c8ccd0; }
    .dot.free { background:#fff; }
    .dot.sel { outline:2px solid #2b77ff; background:#fff; }
    .dot.taken { background:#e9eef3; }
    .meta { margin: 12px 0 6px; }
  </style>
</head>
<body>
  <div id="site-header"></div>

  <main class="main">
    <h1>Вибір місць</h1>

    <div id="meta" class="meta"></div>

    <div class="legend">
      <span><span class="dot free"></span> вільно</span>
      <span><span class="dot sel"></span> вибрано</span>
      <span><span class="dot taken"></span> зайнято</span>
    </div>

    <div id="error" style="color:#c62828; display:none;"></div>
    <div id="hall" class="hall"></div>

    <h2 style="margin-top:18px">Дані покупця</h2>
    <form id="order-form" onsubmit="event.preventDefault(); goPay();">
      <div><input id="name" class="input" placeholder="Ваше ім’я та прізвище" required></div>
      <div><input id="phone" class="input" placeholder="+380..." required></div>
      <div><input id="email" class="input" placeholder="you@example.com" required></div>
      <div id="summary" style="margin:8px 0;">Вибрано місць: 0 • Сума: 0 грн</div>
      <button class="btn" id="pay-btn" disabled>Перейти до оплати</button>
    </form>
  </main>

  <div id="site-footer"></div>
  <script src="/site-081125/scripts/include.js"></script>
  <script>
    const HALL_BASE = '/site-081125/data/hall';
    // Мапа "театр + назва сцени" -> файл схеми
    const HALL_MAP = {
      shevchenko: { 'Велика сцена': 'shevchenko/velyka.json' },
      academy:    { 'Велика сцена': 'academy/academy.json' }
    };

    const urlp = new URLSearchParams(location.search);
    // В URL приходит show=academy/slug или shevchenko/slug
    const showPath = (urlp.get('show') || '').replace(/^\/+/, '');
    const [theatre, ...rest] = showPath.split('/');
    const showSlug = rest.join('/');

    const hallEl = document.getElementById('hall');
    const errEl  = document.getElementById('error');
    const metaEl = document.getElementById('meta');
    const payBtn = document.getElementById('pay-btn');
    const sumEl  = document.getElementById('summary');

    let selection = []; // [{row, seat, price}]
    let currentShow = { title:'', hall:'', city:'', theatre:'' };

    function setError(msg){
      errEl.textContent = msg;
      errEl.style.display = 'block';
    }

    function updateSummary(){
      const total = selection.reduce((s,x)=>s + (x.price||0), 0);
      sumEl.textContent = `Вибрано місць: ${selection.length} • Сума: ${total} грн`;
      payBtn.disabled = selection.length === 0;
    }

    function toggleSeat(btn, info){
      if (btn.classList.contains('taken')) return;
      const key = `${info.row}-${info.seat}`;
      const idx = selection.findIndex(x => `${x.row}-${x.seat}` === key);
      if (idx >= 0){
        selection.splice(idx,1);
        btn.classList.remove('selected');
      } else {
        selection.push(info);
        btn.classList.add('selected');
      }
      updateSummary();
    }

    // Преобразование «параметрической» схемы (rows[].seats + zones + aisles + offset)
    function buildRowSeatsFromZones(rowDef){
      const seats = [];
      for (let i=1;i<=rowDef.seats;i++){
        // цена по зонам
        let price = null;
        if (Array.isArray(rowDef.zones)){
          for (const z of rowDef.zones){
            if (i >= z.from && i <= z.to){ price = z.price; break; }
          }
        }
        seats.push({ label:String(i), price, status: price ? 'free' : 'taken' });
      }
      return seats;
    }

    function renderHall(scheme){
      hallEl.innerHTML = '';
      selection = [];

      // Схема может прийти в двух форматах:
      // A) { rows: [ { name:'Ряд 1', seats:[{label,price,status}, ...] }, ... ] }
      // B) { rows: [ { row, seats: N, aisles:[], zones:[], offset?, gapAfter? }, ... ] }

      const rows = scheme.rows || [];
      rows.forEach(r => {
        const rowWrap = document.createElement('div');
        rowWrap.className = 'row';
        if (r.gapAfter) rowWrap.classList.add('gap-after');

        const label = document.createElement('div');
        label.className = 'row-label';
        label.textContent = r.name || `Ряд ${r.row || ''}`;
        rowWrap.appendChild(label);

        // левый отступ (центрируем первый ряд Академии)
        const offset = Number(r.offset || 0);
        for (let k=0;k<offset;k++){
          const sp = document.createElement('div');
          sp.className = 'spacer';
          rowWrap.appendChild(sp);
        }

        // извлекаем массив мест
        let seatsArr;
        if (Array.isArray(r.seats)){ // формат A
          // seats уже массив объектов -> оставляем как есть
          seatsArr = r.seats.map(s => ({
            label: s.label || String(s),
            price: s.price ?? null,
            status: s.status || (s.price ? 'free' : 'taken')
          }));
        } else if (typeof r.seats === 'number'){ // формат B
          seatsArr = buildRowSeatsFromZones(r);
        } else {
          seatsArr = [];
        }

        const aisles = Array.isArray(r.aisles) ? r.aisles.slice().sort((a,b)=>a-b) : [];
        let nextAisle = aisles.shift(); // позиции между местами (после seat с таким номером)

        seatsArr.forEach((s, idx) => {
          const seatNum = idx+1;

          const b = document.createElement('button');
          b.type = 'button';
          b.className = 'seat' + (s.status === 'taken' ? ' taken' : '');
          b.textContent = s.label;
          b.title = s.price ? `${s.price} грн` : 'Недоступно';
          if (s.status !== 'taken'){
            b.addEventListener('click', () => toggleSeat(b, { row: (r.row || rows.indexOf(r)+1), seat: seatNum, price: s.price || 0 }));
          }
          rowWrap.appendChild(b);

          // вставка вертикального прохода
          if (nextAisle && seatNum === nextAisle){
            const a = document.createElement('div');
            a.className = 'aisle';
            rowWrap.appendChild(a);
            nextAisle = aisles.shift();
          }
        });

        hallEl.appendChild(rowWrap);
      });

      updateSummary();
    }

    async function init(){
      try {
        // show.json нам не нужен для схемы — театр и сцена уже в URL и AFISHA,
        // но выведем шапку
        currentShow.theatre = theatre || '';
        currentShow.hall    = 'Велика сцена';
        metaEl.textContent  = `${currentShow.hall} • ${theatre === 'academy' ? 'Академія руху' : 'Театр ім. Шевченка'}`;

        const mapForTheatre = HALL_MAP[theatre] || {};
        const hallFile = mapForTheatre[currentShow.hall];
        if (!hallFile){
          setError('Не вдалося знайти схему зали для цього майданчика.');
          return;
        }

        const url = `${HALL_BASE}/${hallFile}`;
        const r = await fetch(url, { cache: 'no-store' });
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        const scheme = await r.json();

        renderHall(scheme);
      } catch (e){
        console.error(e);
        setError('Не вдалося завантажити схему залу.');
      }
    }

    function goPay(){
      // Здесь у вас уже рабочий LiqPay init — берите selection (ряд/место/цена) и собирайте order
      alert('Оплата: вибрано місць ' + selection.length + ' (сума вгорі). Підключення LiqPay — як робили для Шевченка.');
    }

    init();
  </script>
</body>
</html>
