<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Вибір місць</title>
  <link rel="icon" href="data:,">
  <link rel="stylesheet" href="../styles.css">
  <style>
    /* Минимальные стили, чтобы не “ехало” */
    .hall-wrap{max-width:1100px;margin:24px auto;padding:0 12px}
    .legend{display:flex;gap:16px;margin:8px 0 16px}
    .legend span{display:inline-flex;align-items:center;gap:8px}
    .dot{width:12px;height:12px;border-radius:3px;border:1px solid #bbb;background:#fff;display:inline-block}
    .dot.sel{background:#dff1ff;border-color:#5aa7ff}
    .dot.taken{background:#ddd;border-color:#bbb}

    .row{display:flex;align-items:center;gap:10px;margin:10px 0;flex-wrap:wrap}
    .row-label{width:52px;min-width:52px;text-align:left;color:#333}
    .seats{display:grid;grid-auto-flow:column;gap:8px}
    /* чтобы сетка не “перескакивала” на новую строку */
    .seats{grid-auto-columns:min-content}
    .seat{
      min-width:34px; height:34px; padding:0 6px;
      display:inline-flex;align-items:center;justify-content:center;
      border:1px solid #c7c7c7;border-radius:6px;background:#fff;cursor:pointer;
      user-select:none; font:14px/1.1 system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    .seat:hover{border-color:#999}
    .seat.sel{background:#dff1ff;border-color:#5aa7ff}
    .seat.taken{background:#e8e8e8;color:#888;border-color:#d0d0d0;cursor:not-allowed}

    .aisle{width:22px} /* вертикальный проём между блоками мест */

    .form{margin-top:18px;display:grid;gap:10px;max-width:900px}
    .form input{height:40px;border:1px solid #ccc;border-radius:8px;padding:0 12px;font:16px system-ui}
    .paybar{display:flex;align-items:center;gap:16px;margin-top:10px}
    .btn{background:#2563eb;color:#fff;border:none;border-radius:10px;padding:14px 22px;font:16px;cursor:pointer}
    .btn:disabled{opacity:.5;cursor:not-allowed}

    .meta{color:#666;margin:0 0 8px}
    .error{color:#b00020;margin:12px 0}
  </style>
</head>
<body>
  <div class="hall-wrap">
    <div id="site-header"></div>

    <h1>Вибір місць</h1>
    <p class="meta" id="meta"></p>

    <div class="legend">
      <span><i class="dot"></i> вільно</span>
      <span><i class="dot sel"></i> вибрано</span>
      <span><i class="dot taken"></i> зайнято</span>
    </div>

    <div id="hall-root" aria-live="polite"></div>
    <p class="error" id="err" style="display:none"></p>

    <div class="form">
      <input id="fio" placeholder="Ваше ім’я та прізвище" autocomplete="name">
      <input id="phone" placeholder="+380…" autocomplete="tel">
      <input id="email" placeholder="you@example.com" autocomplete="email">
      <div class="paybar">
        <button id="pay" class="btn" disabled>Перейти до оплати</button>
        <span id="sum">Вибрано місць: 0 • Сума: 0 грн</span>
      </div>
    </div>

    <div id="site-footer" style="margin-top:32px"></div>
  </div>

  <script src="/site-081125/scripts/include.js"></script>
  <!-- LiqPay (не ломает страницу, если недоступен) -->
  <script async src="https://static.liqpay.com/libjs/checkout.js"></script>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const root = document.getElementById('hall-root');
    const err  = document.getElementById('err');
    const sumBox = document.getElementById('sum');
    const payBtn = document.getElementById('pay');
    const metaEl = document.getElementById('meta');

    // ---------- разбор параметра ?show=academy/chorni-doshky ----------
    const sp = new URLSearchParams(location.search);
    const show = sp.get('show') || '';
    const [theatreKey, showSlug] = show.split('/');

    // показываем «хлебные крошки» сверху
    metaEl.textContent = show
      ? `Подія: ${show.replace('/', ' • ')}`
      : 'Подія не вказана';

    // ---------- определяем путь к схеме ----------
    let hallJson = '';
    if (theatreKey === 'academy' || theatreKey === 'akademia' || theatreKey === 'akademy') {
      // На проекте встречались варианты «academy»/«akademia». Поддержим оба.
      hallJson = '/site-081125/data/hall/academy/academy.json';
    } else if (theatreKey === 'shevchenko') {
      hallJson = '/site-081125/data/hall/shevchenko/velyka.json';
    } else {
      showError('Невідомий майданчик у параметрі ?show=');
      return;
    }

    // ---------- утилиты ценообразования из зон ----------
    function makePriceGetter(zonesArr) {
      // zonesArr: [{from,to,price}, ...]
      return function seatPrice(n){
        for (const z of zonesArr) {
          if (n >= z.from && n <= z.to) return z.price;
        }
        return 0;
      };
    }

    function showError(msg){
      err.textContent = msg;
      err.style.display = 'block';
    }

    const selected = new Map(); // key "row-seat" -> {row,seat,price}

    function updateSummary(){
      let total = 0, count = 0;
      selected.forEach(v => { total += v.price; count++; });
      sumBox.textContent = `Вибрано місць: ${count} • Сума: ${total} грн`;
      payBtn.disabled = count === 0;
    }

    function toggleSeat(el, row, seat, price){
      const key = row + '-' + seat;
      if (el.classList.contains('taken')) return;

      if (selected.has(key)) {
        selected.delete(key);
        el.classList.remove('sel');
      } else {
        selected.set(key, {row, seat, price});
        el.classList.add('sel');
      }
      updateSummary();
    }

    // ---------- рендер ряда ----------
    function renderRow(container, rowObj){
      const rowWrap = document.createElement('div');
      rowWrap.className = 'row';

      const label = document.createElement('div');
      label.className = 'row-label';
      label.textContent = 'Ряд ' + rowObj.row;
      rowWrap.appendChild(label);

      const seatsGrid = document.createElement('div');
      seatsGrid.className = 'seats';
      rowWrap.appendChild(seatsGrid);

      const aisles = new Set(rowObj.aisles || []);
      const priceOf = makePriceGetter(rowObj.zones || []); // для академии
      const totalSeats = Number(rowObj.seats) || 0;

      for (let s=1; s<=totalSeats; s++){
        if (aisles.has(s)) {
          const gap = document.createElement('div');
          gap.className = 'aisle';
          seatsGrid.appendChild(gap);
        }
        const seat = document.createElement('div');
        seat.className = 'seat';
        seat.textContent = s;

        const price = priceOf(s) || (rowObj.price || 0); // поддержка обоих форматов
        seat.title = price ? `${price} грн` : '';

        seat.addEventListener('click', () => toggleSeat(seat, rowObj.row, s, price));
        seatsGrid.appendChild(seat);
      }

      container.appendChild(rowWrap);
    }

    // ---------- основной поток ----------
    fetch(hallJson, {cache:'no-store'})
      .then(r => { if(!r.ok) throw new Error('not ok'); return r.json(); })
      .then(data => {
        // Формат 1 (академия): { rows:[ {row,seats,aisles:[],zones:[{from,to,price}]} ... ] }
        // Формат 2 (похоже у Шевченко ранее был другой): { name:'...', rows:[ { name:'Ряд 1', seats:[ {label,price,status}, ...] }, ... ] }
        root.innerHTML = '';

        if (Array.isArray(data.rows) && data.rows.length) {
          // Определяем по первой записи, какой это тип
          const r0 = data.rows[0];
          if ('seats' in r0 && typeof r0.seats === 'number') {
            // Тип Академии (или совместимый) — используем наш общий рендер
            data.rows.forEach(r => renderRow(root, r));
          } else if (Array.isArray(r0.seats)) {
            // Тип “массив мест” (Шевченко тестовый). Преобразуем в наш универсальный.
            data.rows.forEach((rx, i) => {
              const priceZones = []; // попытаемся собрать диапазоны одинаковой цены
              // быстрый плоский рендер без зон и проходов
              const rowObj = { row: i+1, seats: rx.seats.length, aisles: [], zones: [] };

              // если в массиве мест есть цена, построим зоны по одинаковым ценам
              let start = 1, curPrice = rx.seats[0]?.price || 0;
              for (let idx=1; idx<=rx.seats.length; idx++){
                const p = rx.seats[idx-1]?.price || 0;
                const nextP = rx.seats[idx]?.price || null;
                if (nextP !== p){
                  priceZones.push({from:start, to:idx, price:p});
                  start = idx+1;
                }
              }
              rowObj.zones = priceZones;
              renderRow(root, rowObj);
            });
          } else {
            showError('Невідомий формат схеми залу.');
          }
        } else {
          showError('Порожня схема залу.');
        }
      })
      .catch(() => showError('Не вдалося завантажити схему залу.'));

    // ---------- оплата (заглушка LiqPay: форма есть, падать не будет) ----------
    payBtn.addEventListener('click', () => {
      // здесь можно собрать selected -> оформить корзину
      alert('Оплата: демонстраційний режим. Обрано: ' + selected.size + ' місць.');
      // TODO: тут же сформируйте POST на ваш бекенд/liqpay checkout
    });
  });
  </script>
</body>
</html>
