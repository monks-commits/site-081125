<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Вибір місць</title>
  <link rel="icon" href="data:,">
  <link rel="stylesheet" href="../styles.css" />
  <style>
    :root{
      --seat-size: 34px;     /* кнопка кресла */
      --gap-x: 6px;          /* горизонтальный зазор между креслами */
      --gap-y: 8px;          /* вертикальный зазор между рядами */
      --aisle-w: 14px;       /* ширина стандартного прохода */
      --aisle-w-lg: 24px;    /* большой проход */
    }
    .wrap{max-width:980px;margin:0 auto;padding:12px;}
    .stage{
      width:100%;text-align:center;background:#1f1f1f;color:#fff;
      padding:10px 12px;border-radius:12px;margin:0 0 12px 0;font-weight:600;letter-spacing:.3px;
    }
    .row{display:flex;align-items:center;gap:var(--gap-x);margin:0 0 var(--gap-y) 0;flex-wrap:wrap}
    .row-label{margin-right:8px;font-size:12px;min-width:34px;text-align:right;font-weight:600;opacity:.75;user-select:none}
    .seats{display:flex;align-items:center;gap:var(--gap-x);flex-wrap:wrap}
    .seat{
      min-width:var(--seat-size);height:var(--seat-size);border-radius:8px;border:1px solid #d0d5dd;
      display:inline-flex;align-items:center;justify-content:center;font-size:13px;background:#fff;cursor:pointer;
      user-select:none;transition:.12s;
    }
    .seat:hover{box-shadow:0 0 0 2px rgba(25,115,255,.15)}
    .seat[aria-pressed="true"]{background:#155eef;color:#fff;border-color:#155eef}
    .seat.taken{opacity:.45;pointer-events:none}
    .aisle{display:inline-block;width:var(--aisle-w)}
    .aisle-lg{display:inline-block;width:var(--aisle-w-lg)}
    .row-break-lg{margin-bottom:18px;border-bottom:2px dashed #eaeaea;padding-bottom:10px}

    .legend{display:flex;gap:18px;align-items:center;margin:10px 0 16px}
    .legend .pill{display:inline-flex;align-items:center;gap:6px;font-size:13px;opacity:.8}
    .pill .dot{width:16px;height:16px;border-radius:6px;border:1px solid #d0d5dd;background:#fff}
    .pill .dot.sel{background:#155eef;border-color:#155eef}
    .pill .dot.off{background:#eee}
    .panel{margin-top:10px;display:grid;gap:8px}
    .panel input{width:100%;padding:10px 12px;border:1px solid #d0d5dd;border-radius:10px}
    .btn-primary{
      width:100%;padding:12px 14px;border-radius:12px;background:#155eef;color:#fff;border:0;font-weight:600;cursor:pointer
    }

    @media(max-width:420px){
      :root{ --seat-size: 30px; --gap-x: 5px; --gap-y: 7px; }
      .row-label{min-width:28px;font-size:11px;margin-right:6px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div id="site-header"></div>

    <main>
      <h1 style="margin:8px 0 12px">Вибір місць</h1>

      <div class="legend">
        <span class="pill"><span class="dot"></span> вільно</span>
        <span class="pill"><span class="dot sel"></span> вибрано</span>
        <span class="pill"><span class="dot off"></span> недоступно</span>
        <span id="show-breadcrumb" style="margin-left:auto;opacity:.7;font-size:13px"></span>
      </div>

      <div id="hall-root">
        <!-- сюда рендерим сцену + ряды -->
      </div>

      <div class="panel">
        <input id="buyer-name" placeholder="Ваше ім’я та прізвище">
        <input id="buyer-phone" placeholder="+380…" >
        <input id="buyer-email" placeholder="you@example.com">
        <div id="summary" style="opacity:.8">Вибрано місць: 0 • Сума: 0 грн</div>
        <button id="pay-btn" class="btn-primary">Перейти до оплати</button>
      </div>
    </main>

    <div id="site-footer" style="margin-top:18px"></div>
  </div>

  <script src="/site-081125/scripts/include.js"></script>
  <script>
    // ---------- helpers ----------
    const qs = new URLSearchParams(location.search);
    const slug = (qs.get('show')||'').trim(); // напр. "academy/chorni-doshky" або "shevchenko/za-dvoma-zaytsyamy"
    const [theatre = '', showKey = ''] = slug.split('/');

    // где лежат схемы:
    const HALL_FILE = theatre === 'shevchenko' ? 'velyka.json' : 'academy.json';
    const HALL_URL  = `/site-081125/data/hall/${theatre}/${HALL_FILE}`;

    // подпись сцены
    const STAGE_TITLE =
      theatre === 'shevchenko' ? 'Велика сцена' :
      theatre === 'academy'    ? 'Сцена' : 'Сцена';

    // Для крошки
    const theatreTitle =
      theatre === 'shevchenko' ? 'Театр ім. Шевченка' :
      theatre === 'academy'    ? 'Академія руху' : theatre;

    document.getElementById('show-breadcrumb').textContent =
      [theatreTitle, '•', (showKey||'').replaceAll('-', ' ')].join(' ');

    const hallRoot = document.getElementById('hall-root');
    const summaryEl = document.getElementById('summary');
    const payBtn = document.getElementById('pay-btn');

    const selection = new Map(); // key = `${row}-${seat}`, value = price

    function fmt(n){return new Intl.NumberFormat('uk-UA').format(n||0)}

    function updateSummary(){
      let qty = selection.size;
      let sum = 0;
      selection.forEach(v => sum += v||0);
      summaryEl.textContent = `Вибрано місць: ${qty} • Сума: ${fmt(sum)} грн`;
      payBtn.disabled = !qty;
    }

    function seatKey(r,s){ return `${r}-${s}`; }

    // ---------- рендер ----------
    function renderHall(model){
      hallRoot.innerHTML = '';

      // «Сцена»
      const stageEl = document.createElement('div');
      stageEl.className = 'stage';
      stageEl.textContent = STAGE_TITLE;
      hallRoot.appendChild(stageEl);

      // ряды
      const rows = model?.rows || [];
      rows.forEach((rowObj, idx) => {
        const rowNumber = rowObj.row ?? (idx+1);

        const rowEl = document.createElement('div');
        rowEl.className = 'row';

        // подпись ряда
        const label = document.createElement('span');
        label.className = 'row-label';
        label.textContent = `Ряд ${rowNumber}`;
        rowEl.appendChild(label);

        const seatsBox = document.createElement('div');
        seatsBox.className = 'seats';
        rowEl.appendChild(seatsBox);

        const aisles = rowObj.aisles || [];           // напр. [6,17]
        const seatsCount = rowObj.seats || 0;

        // для цен: zones: [{from,to,price}, ...]
        function priceForSeat(n){
          const zones = rowObj.zones || [];
          for (const z of zones){
            if (n >= z.from && n <= z.to) return z.price;
          }
          return 0;
        }

        for (let n=1; n<=seatsCount; n++){
          // вставка прохода перед этим местом (если индекс включён)
          if (aisles.includes(n)){
            const gap = document.createElement('span');
            gap.className = 'aisle';
            seatsBox.appendChild(gap);
          }

          const seat = document.createElement('button');
          seat.type = 'button';
          seat.className = 'seat';
          seat.textContent = n;
          const price = priceForSeat(n);
          seat.dataset.price = price;
          seat.title = price ? `${price} грн` : '';

          seat.addEventListener('click', ()=>{
            const k = seatKey(rowNumber,n);
            const pressed = seat.getAttribute('aria-pressed') === 'true';
            if (pressed){
              seat.setAttribute('aria-pressed','false');
              selection.delete(k);
            } else {
              seat.setAttribute('aria-pressed','true');
              selection.set(k, price||0);
            }
            updateSummary();
          });

          seatsBox.appendChild(seat);
        }

        // большой вертикальный проход между 17 и 18 рядом — только Академія
        if (theatre === 'academy' && rowNumber === 17){
          rowEl.classList.add('row-break-lg');
        }

        hallRoot.appendChild(rowEl);
      });
    }

    // ---------- события ----------
    payBtn.addEventListener('click', ()=>{
      // тут просто проверяем вводы и показываем, что всё ок;
      // интеграцию с LiqPay/Supabase добавим на следующем шаге
      const name = document.getElementById('buyer-name').value.trim();
      const phone = document.getElementById('buyer-phone').value.trim();
      const mail = document.getElementById('buyer-email').value.trim();

      if (!selection.size) { alert('Виберіть хоча б одне місце.'); return; }
      if (!name || !phone || !mail){ alert('Заповніть, будь ласка, всі поля покупця.'); return; }

      let sum = 0; selection.forEach(v => sum += v||0);
      alert(`Замовлення сформовано.\nМісць: ${selection.size}\nСума: ${fmt(sum)} грн\n(Оплату підключимо далі)`);
    });

    // ---------- загрузка модели ----------
    fetch(HALL_URL, { cache: 'no-store' })
      .then(r=>{ if(!r.ok) throw new Error('Hall not found'); return r.json(); })
      .then(renderHall)
      .catch(e=>{
        hallRoot.innerHTML = `<p style="color:#b42318">Не вдалося завантажити схему залу: <code>${HALL_URL}</code></p>`;
        console.error(e);
      });
  </script>
</body>
</html>
