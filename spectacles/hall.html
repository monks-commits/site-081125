<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Вибір місць — Ваш Адмін</title>
  <link rel="stylesheet" href="../styles.css" />
  <style>
    body { background:#f4f4f6; }
    main { max-width:1100px; margin:0 auto; padding:24px 16px 50px; }

    .hall-wrap { background:#fff; border-radius:14px; padding:22px; margin-bottom:24px; }
    .hall-row { display:flex; gap:8px; align-items:center; margin-bottom:8px; }
    .row-label { width:26px; text-align:right; font-size:12px; color:#475569; flex:0 0 26px; }

    .seat {
      width:36px; height:36px; border-radius:10px;
      display:flex; align-items:center; justify-content:center;
      border:1px solid #d0d5dd; background:#fff; color:#0f172a;
      font-size:13px; user-select:none; transition:.15s; cursor:default;
    }
    .seat.disabled { background:#eceff3; border-color:#e3e8ef; color:#94a3b8; cursor:not-allowed; }
    .seat.available { background:#fde68a; border-color:#fbbf24; cursor:pointer; }
    .seat.available:hover { filter:brightness(0.97); }
    .seat.selected { background:#ef4444; border-color:#ef4444; color:#fff; }
    .seat.sold { background:#22c55e; border-color:#16a34a; color:#fff; cursor:not-allowed; }

    .pass-gap { width:36px; height:1px; flex:0 0 36px; }

    .order-form { background:#fff; border-radius:14px; padding:22px; }
    .flex-row { display:flex; gap:12px; flex-wrap:wrap; }
    .form-group { flex:1 1 240px; display:flex; flex-direction:column; gap:6px; }
    .form-group input {
      height:44px; border:1px solid #d0d5dd; border-radius:10px; padding:0 12px; font-size:15px;
    }
    .primary-btn {
      background:#155EEF; color:#fff; border:none; border-radius:999px; padding:11px 30px;
      font-size:15px; font-weight:600; cursor:pointer;
    }
    .primary-btn:disabled { background:#95b5ff; cursor:not-allowed; }
    .muted { color:#64748b; font-size:13px; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div id="site-header"></div>

  <main>
    <h1>Вибір місць</h1>
    <p id="show-label" class="muted" style="margin-bottom:14px;">Вистава: —</p>

    <div class="hall-wrap">
      <div id="hall"></div>
    </div>

    <div class="order-form" id="buyer-form">
      <h2>Дані покупця</h2>
      <div class="flex-row">
        <div class="form-group">
          <label for="buyer-name">Ім’я та прізвище</label>
          <input id="buyer-name" placeholder="Ваше ім’я та прізвище" autocomplete="name" />
        </div>
        <div class="form-group">
          <label for="buyer-phone">Телефон</label>
          <input id="buyer-phone" placeholder="+380..." inputmode="tel" autocomplete="tel" />
        </div>
      </div>
      <div class="form-group" style="margin-top:14px;">
        <label for="buyer-email">Електронна пошта (куди надійде PDF-квиток)</label>
        <input id="buyer-email" placeholder="you@example.com" inputmode="email" autocomplete="email" />
      </div>

      <p style="margin-top:14px;">
        Вибрано місць: <span id="seat-count">0</span> • Сума: <span id="seat-sum">0</span> грн
      </p>
      <button id="to-checkout" class="primary-btn" disabled>Перейти до оплати</button>
      <p class="muted" style="margin-top:10px;">
        * Зараз активні місця тільки для «За двома зайцями» — ряди 12–18. Інші вистави підключимо далі.
      </p>
    </div>
  </main>

  <div id="site-footer"></div>
  <script src="/site-081125/scripts/include.js"></script>

  <script>
    const params = new URLSearchParams(location.search);
    // В наших посиланнях ми передаємо show=slug (або slug у параметрі slug)
    const showSlug = params.get("show") || params.get("slug") || "";
    document.getElementById("show-label").textContent =
      "Вистава: " + (showSlug ? showSlug.replace("/", " — ") : "—");

    const ROWS = 18;
    const SEATS_PER_ROW = 20;
    const PASS_AFTER = 10;

    function priceForRow(r){
      if (r<=1) return 170;
      if (r<=2) return 200;
      if (r<=3) return 200;
      if (r<=6) return 180;
      if (r<=8) return 170;
      if (r<=10) return 160;
      if (r<=12) return 140;
      if (r<=14) return 120;
      if (r<=16) return 100;
      return 70;
    }

    const hallEl = document.getElementById("hall");
    const selected = new Set();
    const seatCountEl = document.getElementById("seat-count");
    const seatSumEl = document.getElementById("seat-sum");
    const btnCheckout = document.getElementById("to-checkout");

    let statusMap = new Map();

    // Єдине правило доступності: тільки «За двома зайцями» та тільки ряди 12–18
    function isSeatAvailable(row){
      return (
        showSlug === "shevchenko/za-dvoma-zaytsiamy" &&
        row >= 12 && row <= 18
      );
    }

    function renderHall(){
      hallEl.innerHTML = "";
      for(let r=1; r<=ROWS; r++){
        const rowEl = document.createElement("div");
        rowEl.className = "hall-row";

        const lbl = document.createElement("div");
        lbl.className = "row-label";
        lbl.textContent = r;
        rowEl.appendChild(lbl);

        for(let s=1; s<=SEATS_PER_ROW; s++){
          if (s === PASS_AFTER + 1){
            const gap = document.createElement("div");
            gap.className = "pass-gap";
            rowEl.appendChild(gap);
          }

          const seatId = `P${r}-M${s}`;
          const seatPrice = priceForRow(r);
          const el = document.createElement("div");
          el.className = "seat disabled";
          el.textContent = s;
          el.title = `Ряд ${r}, місце ${s} — ${seatPrice} грн`;

          const st = statusMap.get(seatId);
          if (st === "sold"){
            el.classList.remove("disabled");
            el.classList.add("sold");
          } else if (st === "reserved"){
            el.classList.remove("disabled");
            el.classList.add("selected");
          } else if (isSeatAvailable(r)){
            el.classList.remove("disabled");
            el.classList.add("available");
            el.addEventListener("click", ()=>{
              if (el.classList.contains("selected")){
                el.classList.remove("selected");
                el.classList.add("available");
                selected.delete(seatId);
              } else {
                el.classList.remove("available");
                el.classList.add("selected");
                selected.add(seatId);
              }
              updateSummary();
            });
          }

          rowEl.appendChild(el);
        }

        hallEl.appendChild(rowEl);
      }
    }

    function updateSummary(){
      const ids = [...selected];
      seatCountEl.textContent = ids.length;
      const sum = ids.reduce((acc, id)=>{
        const row = parseInt(id.split("-")[0].slice(1),10);
        return acc + priceForRow(row);
      }, 0);
      seatSumEl.textContent = sum;
      btnCheckout.disabled = (ids.length === 0);
    }

    (async function tryFetchStatuses(){
      try{
        const SUPABASE_URL = "https://yqhzekifwxotizsmaeaf.supabase.co";
        const SUPABASE_ANON_KEY = "sb_publishable_z1h_G-7K7HGCjOUtRZpI9Q_o1m9inZM";
        const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const { data, error } = await sb
          .from("bookings")
          .select("seat_id,status,expires_at")
          .eq("show_slug", showSlug);

        if (!error && Array.isArray(data)){
          const nowIso = new Date().toISOString();
          data.forEach(row=>{
            if (row.status === "reserved" && row.expires_at && row.expires_at < nowIso) return;
            statusMap.set(row.seat_id, row.status);
          });
        }
      } catch(e){
        console.warn("Статуси місць недоступні:", e.message);
      } finally {
        renderHall();
      }
    })();

    document.getElementById("to-checkout").addEventListener("click", ()=>{
      const ids = [...selected];
      const sum = Number(seatSumEl.textContent) || 0;

      const name  = document.getElementById("buyer-name").value.trim();
      const phone = document.getElementById("buyer-phone").value.trim();
      const email = document.getElementById("buyer-email").value.trim();

      const orderId = "SHEV-" + Date.now();

      const url = new URL(location.origin + "/site-081125/checkout.html");
      url.searchParams.set("show", showSlug);
      url.searchParams.set("seats", ids.join(","));
      url.searchParams.set("amount", String(sum));
      url.searchParams.set("order_id", orderId);
      if (name)  url.searchParams.set("name", name);
      if (phone) url.searchParams.set("phone", phone);
      if (email) url.searchParams.set("email", email);

      location.href = url.toString();
    });
  </script>
</body>
</html>
