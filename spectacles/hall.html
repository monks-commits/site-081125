<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Вибір місць — Ваш Адмін</title>
  <link rel="icon" href="data:,">
  <link rel="stylesheet" href="/site-081125/styles.css" />
  <style>
    /* Нейтральні стилі на випадок, якщо у styles.css немає потрібних класів */
    .hall {display:grid; gap:10px; margin:16px 0}
    .hall-row {display:flex; align-items:center; gap:10px; flex-wrap:wrap}
    .hall-row-label {width:80px; text-align:right; font-weight:600; color:#475467}
    .seats {display:flex; gap:6px; flex-wrap:wrap}
    .seat {
      min-width:36px; height:36px; border-radius:8px; border:1px solid #D0D5DD; background:#fff;
      cursor:pointer; font:600 13px/34px system-ui, -apple-system, Segoe UI, Roboto, Ubuntu;
      text-align:center; padding:0 8px; user-select:none;
    }
    .seat.taken {background:#E5E7EB; border-color:#E5E7EB; color:#9CA3AF; cursor:not-allowed}
    .seat.selected {background:#155EEF; color:#fff; border-color:#155EEF}
    .legend{display:flex; gap:14px; align-items:center; flex-wrap:wrap; margin-top:6px; color:#475467}
    .legend > span{display:inline-flex; gap:6px; align-items:center}
    .legend .box{width:16px; height:16px; border:1px solid #D0D5DD; border-radius:4px; background:#fff}
    .legend .sel{background:#155EEF; border-color:#155EEF}
    .legend .dis{background:#E5E7EB; border-color:#E5E7EB}
    .order-form .form-row{display:flex; flex-direction:column; gap:6px; margin:10px 0}
    #summary{margin:8px 0 14px}
  </style>
</head>

<body>
  <div id="site-header"></div>

  <main class="main">
    <section class="section">
      <h1>Вибір місць</h1>
      <div id="show-title" class="muted" style="margin-bottom:8px"></div>

      <div id="hall-root" class="hall"></div>
      <div class="legend">
        <span><span class="box"></span> вільно</span>
        <span><span class="box sel"></span> вибрано</span>
        <span><span class="box dis"></span> зайнято</span>
      </div>

      <form id="order-form" class="order-form">
        <h2 style="margin-top:18px">Дані покупця</h2>

        <div class="form-row">
          <label>Ім’я та прізвище</label>
          <input type="text" name="name" required placeholder="Ваше ім’я та прізвище" autocomplete="name" />
        </div>

        <div class="form-row">
          <label>Телефон</label>
          <input type="tel" name="phone" required placeholder="+380..." inputmode="tel" autocomplete="tel" />
        </div>

        <div class="form-row">
          <label>Електронна пошта (куди надійде PDF-квиток)</label>
          <input type="email" name="email" required placeholder="you@example.com" inputmode="email" autocomplete="email" />
        </div>

        <p id="summary">Вибрано місць: 0 • Сума: 0 грн</p>
        <button type="submit" class="btn primary">Перейти до оплати</button>
      </form>
    </section>
  </main>

  <div id="site-footer"></div>

  <script src="/site-081125/scripts/include.js"></script>
  <script>
(async () => {
  const url = new URL(location.href);
  const showSlug = url.searchParams.get('show') || '';
  const theatre = showSlug.split('/')[0];        // shevchenko | academy
  const scene   = 'velyka';                      // фиксированная сцена для обоих
  const hallUrl = `/site-081125/data/hall/${theatre}/${theatre === 'academy' ? 'academy' : scene}.json`;

  const hallBox = document.getElementById('hall');
  const totalBox = document.getElementById('total');
  const nameEl = document.getElementById('show-name'); // опционально
  const picked = new Map(); // key: "r-s"

  function priceTitle(p) { return p != null ? `${p} грн` : ''; }

  function seatBtn(row, seat, price, disabled=false) {
    const b = document.createElement('button');
    b.className = 'seat';
    b.textContent = seat;
    b.type = 'button';
    if (disabled) b.disabled = true;
    b.dataset.row = row;
    b.dataset.seat = seat;
    b.dataset.price = price ?? '';
    if (price != null) b.title = priceTitle(price);

    b.addEventListener('click', () => {
      const key = `${row}-${seat}`;
      if (picked.has(key)) {
        picked.delete(key);
        b.classList.remove('picked');
      } else {
        picked.set(key, price ?? 0);
        b.classList.add('picked');
      }
      renderTotal();
    });
    return b;
  }

  function gap(widthPx) {
    const g = document.createElement('div');
    g.className = 'aisle';
    g.style.width = (widthPx ?? 28) + 'px';
    return g;
  }

  function pad(widthSeats) {
    const g = document.createElement('div');
    g.className = 'aisle';
    g.style.width = (widthSeats * 34) + 'px'; // 34px ~ ширина места + зазор
    return g;
  }

  function renderTotal() {
    const n = picked.size;
    let sum = 0;
    picked.forEach(v => { sum += (Number(v) || 0); });
    totalBox.textContent = `Вибрано місць: ${n} • Сума: ${sum} грн`;
  }

  function renderHall(hall) {
    hallBox.innerHTML = '';
    const flat = hall.flat_price != null ? Number(hall.flat_price) : null;

    (hall.rows || []).forEach(r => {
      const rowWrap = document.createElement('div');
      rowWrap.className = 'row';

      const label = document.createElement('div');
      label.className = 'row-label';
      label.textContent = `Ряд ${r.row}`;
      rowWrap.appendChild(label);

      const seatsWrap = document.createElement('div');
      seatsWrap.className = 'seats';

      // слева «пэддинг» для центрирования
      if (r.left_pad) seatsWrap.appendChild(pad(r.left_pad));

      const aislesSet = new Set(r.aisles || []);
      const seatsCount = Number(r.seats) || 0;

      for (let s = 1; s <= seatsCount; s++) {
        if (aislesSet.has(s)) seatsWrap.appendChild(gap(28)); // проход

        // цена: глобальная flat_price > (если понадобятся зоны — можно вернуть)
        const price = flat != null ? flat : null;

        const btn = seatBtn(r.row, s, price, false);
        seatsWrap.appendChild(btn);
      }

      // справа «пэддинг» для центрирования
      if (r.right_pad) seatsWrap.appendChild(pad(r.right_pad));

      rowWrap.appendChild(seatsWrap);
      hallBox.appendChild(rowWrap);

      // дополнительный «проход» после ряда
      if (r.row_break_after) {
        const br = document.createElement('div');
        br.style.height = '18px';
        hallBox.appendChild(br);
      }
    });

    renderTotal();
  }

  try {
    const hall = await fetch(hallUrl, {cache:'no-store'}).then(r => r.json());
    renderHall(hall);
  } catch (e) {
    console.error(e);
    hallBox.innerHTML = `<div class="error">Не вдалося завантажити схему залу: ${hallUrl}</div>`;
  }
})();
</script>


</body>
</html>
