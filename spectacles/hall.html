<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <title>Вибір місць</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="../styles.css" />
</head>
<body>
  <header class="site-header">
    <div class="container header-inner">
      <a href="../index.html" class="logo">Ваш Адмін</a>
      <nav class="nav">
        <a href="../index.html">Афіша</a>
        <a href="../theatres.html">Театри</a>
        <a href="../contacts.html">Контакти</a>
      </nav>
    </div>
  </header>

  <main class="container" style="padding-top:24px;padding-bottom:40px;">
    <h1>Вибір місць</h1>

    <!-- Легенда -->
    <div style="margin:12px 0 18px;">
      <label><input type="radio" checked disabled /> вільно</label>
      <label style="margin-left:12px;"><input type="radio" checked disabled style="accent-color:#2563eb;" /> вибрано</label>
      <label style="margin-left:12px;"><input type="radio" checked disabled style="accent-color:#9ca3af;" /> недоступно</label>
    </div>

    <!-- Карточка зало + форма -->
    <div class="card">
      <div id="show-title" style="font-size:18px;font-weight:600;margin-bottom:10px;"></div>

      <div class="hall-wrapper">
        <div class="hall-stage">Сцена</div>
        <div id="hall-root"></div>
      </div>

      <!-- Сводка по местам -->
      <div id="summary" style="margin:16px 0;font-size:15px;">
        Обрано місць: <b id="summary-count">0</b> • Сума: <b id="summary-total">0 грн</b>
      </div>

      <!-- Форма покупця -->
      <section style="margin-top:18px;">
        <h2 style="font-size:18px;margin-bottom:8px;">Дані покупця</h2>

        <div class="form-row">
          <input id="customer-name" class="form-control" placeholder="Ваше ім&#39;я та прізвище" />
        </div>
        <div class="form-row">
          <input id="customer-phone" class="form-control" placeholder="+380..." />
        </div>
        <div class="form-row">
          <input id="customer-email" class="form-control" placeholder="Email для PDF-квитків" />
        </div>

        <button id="pay-btn" class="button-primary" disabled>Перейти до оплати</button>

        <div id="error-box" class="error-box" style="display:none;"></div>
      </section>
    </div>
  </main>

  <footer class="site-footer">
    <div class="container footer-grid">
      <div>
        <h3>Контакти</h3>
        <p>ФОП Рябов Олександр Германович</p>
        <p>Телефон: +380 (98) 126-16-95</p>
        <p>Email: alexandrryabov@ukr.net</p>
      </div>
      <div>
        <h3>Офіційно</h3>
        <p>Реєстраційний номер: 2002240000000166615</p>
        <p>Без комісій. Без переплат.</p>
      </div>
    </div>
    <div class="footer-bottom">
      © 2025 Ваш Адмін — театральні квитки
    </div>
  </footer>

  <!-- Supabase SDK -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <script>
    /***********************
     * 1. НАСТРОЙКИ ПРОЕКТА
     ***********************/

    // ⚠️ СЮДА ВСТАВЬ СВОИ ЗНАЧЕНИЯ
    const SUPABASE_URL = 'https://yqhzekifwxotizsmaeaf.supabase.co';          // Project URL
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlxaHpla2lmd3hvdGl6c21hZWFmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEyMzQyNjgsImV4cCI6MjA3NjgxMDI2OH0.lUoppCppKZisZdyOrreCov_-xEOCvGuwxd28XZY4O_k';                         // anon public key
    const LIQPAY_FN_URL = 'https://yqhzekifwxotizsmaeaf.supabase.co/functions/v1/liqpay-create-index-ts';

    // таблицы
    const BOOKINGS_TABLE = 'bookings';
    const ORDERS_TABLE   = 'tickets_orders';

    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /***********************
     * 2. ОПИСАНИЕ ЗАЛОВ
     ***********************/
    // простая модель: ряды с количеством мест + проходы
    const HALLS = {
      'shevchenko/za-dvoma-zaytsyamy': {
        title: 'Театр ім. Шевченка • «За двома зайцями»',
        rows: 18,
        seatsPerRow: 20,
        aisleAfter: 10,           // проход между 10 и 11
        priceByRow(row) {
          if (row <= 4) return 160;
          if (row <= 8) return 170;
          if (row <= 12) return 140;
          if (row <= 16) return 120;
          return 70;
        }
      },
      'academy/chorni-doshky': {
        title: 'Академія руху • «Чорні дощки»',
        rows: 18,
        seatsPerRow: 23,
        aisleAfter: 17,           // большой проход между 17 и 18
        priceByRow(row) {
          if (row === 1) return 220;
          if (row <= 6) return 200;
          if (row <= 7) return 190;
          if (row <= 13) return 180;
          if (row <= 16) return 130;
          if (row === 17) return 120;
          return 110;
        }
      }
    };

    function getShowSlugFromUrl() {
      const params = new URLSearchParams(window.location.search);
      const slug = params.get('show');
      return slug || 'shevchenko/za-dvoma-zaytsyamy';
    }

    /***********************
     * 3. РЕНДЕР ЗАЛА
     ***********************/
    const hallRoot = document.getElementById('hall-root');
    const summaryCountEl = document.getElementById('summary-count');
    const summaryTotalEl = document.getElementById('summary-total');
    const errorBox = document.getElementById('error-box');
    const payBtn = document.getElementById('pay-btn');

    let currentShowSlug = null;
    let currentHallConfig = null;
    const selectedSeats = new Map();   // seatKey -> { row, seat, price }
    const takenSeats = new Set();      // seatKey занятые в bookings

    function seatKey(row, seat) {
      return `R${row}-S${seat}`;
    }

    function renderHall() {
      hallRoot.innerHTML = '';

      for (let r = 1; r <= currentHallConfig.rows; r++) {
        const rowDiv = document.createElement('div');
        rowDiv.className = 'hall-row';

        const label = document.createElement('div');
        label.className = 'hall-row-label';
        label.textContent = `Ряд ${r}`;
        rowDiv.appendChild(label);

        const seatsWrap = document.createElement('div');
        seatsWrap.className = 'hall-row-seats';

        for (let s = 1; s <= currentHallConfig.seatsPerRow; s++) {
          if (currentHallConfig.aisleAfter && s === currentHallConfig.aisleAfter + 1) {
            const ais = document.createElement('div');
            ais.className = 'hall-aisle';
            seatsWrap.appendChild(ais);
          }

          const key = seatKey(r, s);
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'hall-seat';
          btn.textContent = s;

          if (takenSeats.has(key)) {
            btn.classList.add('taken');
            btn.disabled = true;
          }

          btn.addEventListener('click', () => toggleSeat(r, s, key, btn));
          seatsWrap.appendChild(btn);
        }

        rowDiv.appendChild(seatsWrap);
        hallRoot.appendChild(rowDiv);

        // дополнительный вертикальный проход после 6 и 16 рядов у Академії
        if (currentShowSlug.startsWith('academy') && (r === 6 || r === 16)) {
          const gap = document.createElement('div');
          gap.className = 'hall-row-gap';
          hallRoot.appendChild(gap);
        }
      }
    }

    function toggleSeat(row, seat, key, btn) {
      if (selectedSeats.has(key)) {
        selectedSeats.delete(key);
        btn.classList.remove('selected');
      } else {
        const price = currentHallConfig.priceByRow(row);
        selectedSeats.set(key, { row, seat, price });
        btn.classList.add('selected');
      }
      updateSummary();
    }

    function updateSummary() {
      const count = selectedSeats.size;
      let total = 0;
      for (const info of selectedSeats.values()) total += info.price;
      summaryCountEl.textContent = count;
      summaryTotalEl.textContent = `${total} грн`;
      payBtn.disabled = count === 0;
    }

    /***********************
     * 4. ЗАГРУЗКА ЗАНЯТЫХ МЕСТ
     ***********************/
    async function loadTakenSeats(showSlug) {
      const { data, error } = await supabaseClient
        .from(BOOKINGS_TABLE)
        .select('seat,status')
        .eq('show_slug', showSlug)
        .in('status', ['booked', 'paid']);

      if (error) {
        console.error('loadTakenSeats error', error);
        showError('Помилка завантаження зайнятих місць. Спробуйте оновити сторінку.');
        return;
      }

      takenSeats.clear();
      (data || []).forEach(row => takenSeats.add(row.seat));
    }

    /***********************
     * 5. СОХРАНЕНИЕ ЗАКАЗА В SUPABASE
     ***********************/
    async function saveOrderToSupabase(payload) {
      const { data, error } = await supabaseClient
        .from(ORDERS_TABLE)
        .insert(payload)
        .select()
        .single();

      if (error) {
        console.error('saveOrderToSupabase error', error);
        throw new Error('Помилка збереження замовлення в базі.');
      }
      return data;
    }

    async function saveBookings(showSlug, seats, orderId) {
      const rows = seats.map(code => ({
        show_slug: showSlug,
        seat: code,
        status: 'booked',
        order_id: orderId
      }));

      const { error } = await supabaseClient.from(BOOKINGS_TABLE).insert(rows);
      if (error) {
        console.error('saveBookings error', error);
        throw new Error('Не вдалося забронювати місця.');
      }
    }

    /***********************
     * 6. ВЫЗОВ LIQPAY EDGE FUNCTION
     ***********************/
    async function createLiqpayInvoice(order) {
      const resp = await fetch(LIQPAY_FN_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'apikey': SUPABASE_ANON_KEY
        },
        body: JSON.stringify(order)
      });

      if (!resp.ok) {
        const text = await resp.text().catch(() => '');
        console.error('LiqPay function error', resp.status, text);
        throw new Error('Помилка створення рахунку LiqPay.');
      }

      const json = await resp.json();
      // ожидаем, что функция вернёт ссылку на оплату
      if (!json || !json.checkout_url) {
        console.error('Unexpected LiqPay response', json);
        throw new Error('Неправильна відповідь від LiqPay.');
      }
      return json.checkout_url;
    }

    /***********************
     * 7. ОБРАБОТКА КНОПКИ "ПЕРЕЙТИ ДО ОПЛАТИ"
     ***********************/
    function showError(msg) {
      errorBox.textContent = msg;
      errorBox.style.display = 'block';
    }
    function clearError() {
      errorBox.textContent = '';
      errorBox.style.display = 'none';
    }

    payBtn.addEventListener('click', async () => {
      clearError();

      const customerName = document.getElementById('customer-name').value.trim();
      const customerPhone = document.getElementById('customer-phone').value.trim();
      const customerEmail = document.getElementById('customer-email').value.trim();

      if (!customerName || !customerPhone || !customerEmail) {
        showError('Будь ласка, заповніть усі поля покупця.');
        return;
      }
      if (selectedSeats.size === 0) {
        showError('Виберіть хоча б одне місце.');
        return;
      }

      payBtn.disabled = true;
      payBtn.textContent = 'Створення рахунку...';

      try {
        // собираем данные по местам
        const seatsArray = Array.from(selectedSeats.entries()).map(([code, info]) => ({
          code,
          row: info.row,
          seat: info.seat,
          price: info.price
        }));
        const seatCodes = seatsArray.map(s => s.code);
        const total = seatsArray.reduce((sum, s) => sum + s.price, 0);

        const orderId = `${Date.now()}-${Math.floor(Math.random() * 1e6)}`;

        const orderPayload = {
          order_id: orderId,
          show_slug: currentShowSlug,
          seats: seatCodes,
          total_amount: total,
          customer_name: customerName,
          customer_phone: customerPhone,
          customer_email: customerEmail,
          status: 'pending'
        };

        // 1) пишем заказ в Supabase
        await saveOrderToSupabase(orderPayload);

        // 2) отмечаем места как забронированные
        await saveBookings(currentShowSlug, seatCodes, orderId);

        // 3) создаём счёт в LiqPay
        const checkoutUrl = await createLiqpayInvoice({
          orderId,
          amount: total,
          description: `Квитки • ${currentHallConfig.title || ''}`,
          customerName,
          customerPhone,
          customerEmail,
          seats: seatCodes,
          showSlug: currentShowSlug
        });

        // 4) переадресация на LiqPay
        window.location.href = checkoutUrl;
      } catch (err) {
        console.error(err);
        showError(err.message || 'Сталася помилка. Спробуйте ще раз.');
        payBtn.disabled = false;
        payBtn.textContent = 'Перейти до оплати';
      }
    });

    /***********************
     * 8. ИНИЦИАЛИЗАЦИЯ
     ***********************/
    (async function init() {
      currentShowSlug = getShowSlugFromUrl();
      currentHallConfig = HALLS[currentShowSlug];

      if (!currentHallConfig) {
        currentHallConfig = HALLS['shevchenko/za-dvoma-zaytsyamy'];
        currentShowSlug = 'shevchenko/za-dvoma-zaytsyamy';
      }

      document.getElementById('show-title').textContent = currentHallConfig.title;

      await loadTakenSeats(currentShowSlug);
      renderHall();
      updateSummary();
    })();
  </script>
</body>
</html>
