<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <title>Вибір місць</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="../styles.css" />
</head>
<body>
  <header class="site-header">
    <div class="container header-inner">
      <a href="../index.html" class="logo">Ваш Адмін</a>
      <nav class="nav">
        <a href="../index.html">Афіша</a>
        <a href="../theatres.html">Театри</a>
        <a href="../contacts.html">Контакти</a>
      </nav>
    </div>
  </header>

  <main class="container" style="padding-top:24px;padding-bottom:40px;">
    <h1>Вибір місць</h1>

    <!-- Легенда -->
    <div style="margin:12px 0 18px;">
      <label><input type="radio" checked disabled /> вільно</label>
      <label style="margin-left:12px;"><input type="radio" checked disabled style="accent-color:#2563eb;" /> вибрано</label>
      <label style="margin-left:12px;"><input type="radio" checked disabled style="accent-color:#9ca3af;" /> недоступно</label>
    </div>

    <!-- Карточка зало + форма -->
    <div class="card">
      <div id="show-title" style="font-size:18px;font-weight:600;margin-bottom:10px;"></div>

      <div class="hall-wrapper">
        <div class="hall-stage">Сцена</div>
        <div id="hall-root"></div>
      </div>

      <!-- Сводка по местам -->
      <div id="summary" style="margin:16px 0;font-size:15px;">
        Обрано місць: <b id="summary-count">0</b> • Сума: <b id="summary-total">0 грн</b>
      </div>

      <!-- Форма покупця -->
      <section style="margin-top:18px;">
        <h2 style="font-size:18px;margin-bottom:8px;">Дані покупця</h2>

        <div class="form-row">
          <input id="customer-name" class="form-control" placeholder="Ваше ім&#39;я та прізвище" />
        </div>
        <div class="form-row">
          <input id="customer-phone" class="form-control" placeholder="+380..." />
        </div>
        <div class="form-row">
          <input id="customer-email" class="form-control" placeholder="Email для PDF-квитків" />
        </div>

        <button id="pay-btn" class="button-primary" disabled>Перейти до оплати</button>

        <div id="error-box" class="error-box" style="display:none;"></div>
      </section>
    </div>
  </main>

  <footer class="site-footer">
    <div class="container footer-grid">
      <div>
        <h3>Контакти</h3>
        <p>ФОП Рябов Олександр Германович</p>
        <p>Телефон: +380 (98) 126-16-95</p>
        <p>Email: alexandrryabov@ukr.net</p>
      </div>
      <div>
        <h3>Офіційно</h3>
        <p>Реєстраційний номер: 2002240000000166615</p>
        <p>Без комісій. Без переплат.</p>
      </div>
    </div>
    <div class="footer-bottom">
      © 2025 Ваш Адмін — театральні квитки
    </div>
  </footer>

  <!-- Supabase SDK -->
  <!-- Supabase + логика зала + LiqPay -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
/***********************
 * 1. НАСТРОЙКИ ПРОЕКТА
 ***********************/

// ВАЖНО: здесь должны быть именно Supabase-значения
const SUPABASE_URL = 'https://yqhzekifwxotizsmaeaf.supabase.co';       // как в Project URL
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlxaHpla2lmd3hvdGl6c21hZWFmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEyMzQyNjgsImV4cCI6MjA3NjgxMDI2OH0.lUoppCppKZisZdyOrreCov_-xEOCvGuwxd28XZY4O_k'; // твой anon key
const LIQPAY_FN_URL =
  'https://yqhzekifwxotizsmaeaf.supabase.co/functions/v1/liqpay-create-index-ts';

const supabaseClient = window.supabase.createClient(
  SUPABASE_URL,
  SUPABASE_ANON_KEY
);

// какой спектакль открыт из ?show=...
const urlParams = new URLSearchParams(window.location.search);
const showSlug = urlParams.get('show') || 'shevchenko/za-dvoma-zaytsyamy';

/**********************************************
 * 2. ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ ДЛЯ РАБОТЫ С БД
 **********************************************/

// загрузить занятые места для текущего спектакля
async function loadTakenSeats() {
  const { data, error } = await supabaseClient
    .from('bookings')
    .select('seat_id')
    .eq('show_slug', showSlug);

  if (error) {
    console.error('loadTakenSeats error', error);
    return new Set();
  }

  const taken = new Set((data || []).map((row) => row.seat_id));
  return taken;
}

// записать заказ в таблицу orders + занять места в bookings
async function saveOrderToSupabase(orderId, selectedSeats, totalAmount, customer) {
  // 1) пишем заказ
  const { error: orderError } = await supabaseClient.from('orders').insert({
    order_id: orderId,
    show_slug: showSlug,
    seats: selectedSeats,          // массив ID мест
    total_amount: totalAmount,
    customer_name: customer.name,
    customer_phone: customer.phone,
    customer_email: customer.email,
    status: 'pending'
  });

  if (orderError) {
    console.error('saveOrderToSupabase[orders] error', orderError);
    throw orderError;
  }

  // 2) отмечаем каждое место в bookings
  const bookingRows = selectedSeats.map((seatId) => ({
    show_slug: showSlug,
    seat_id: seatId,
    buyer_name: customer.name
  }));

  const { error: bookingError } = await supabaseClient
    .from('bookings')
    .insert(bookingRows);

  if (bookingError) {
    console.error('saveOrderToSupabase[bookings] error', bookingError);
    throw bookingError;
  }
}

/**********************************************
 * 3. РАБОТА С ЛИЧПЕЕМ (Edge Function)
 **********************************************/

async function createLiqpayInvoice(orderId, totalAmount, customer) {
  try {
    const response = await fetch(LIQPAY_FN_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        orderId,
        amount: totalAmount,
        customerName: customer.name,
        customerPhone: customer.phone,
        customerEmail: customer.email,
        showSlug
      })
    });

    if (!response.ok) {
      const text = await response.text();
      console.error('LiqPay function error', text);
      throw new Error('Помилка LiqPay');
    }

    const data = await response.json();
    // предполагаем, что функция возвращает URL оплаты
    if (data && data.payUrl) {
      window.location.href = data.payUrl;
    } else {
      console.error('Unexpected LiqPay response', data);
      alert('Не вдалося отримати посилання на оплату.');
    }
  } catch (err) {
    console.error('createLiqpayInvoice error', err);
    alert('Помилка при створенні рахунку. Спробуйте ще раз пізніше.');
  }
}

/**********************************************
 * 4. ИНИЦИАЛИЗАЦИЯ СХЕМЫ И ОБРАБОТКА КНОПКИ
 **********************************************/

// здесь предполагается, что у тебя уже есть логика
// отрисовки зала и массив selectedSeatsIds

let takenSeatsSet = new Set();
let selectedSeatsIds = [];

// пример инициализации: грузим занятые места и перерисовываем зал
document.addEventListener('DOMContentLoaded', async () => {
  takenSeatsSet = await loadTakenSeats();
  // TODO: здесь вызвать твою функцию отрисовки зала,
  // которая учитывает takenSeatsSet
});

// обработчик кнопки "Перейти до оплати"
const payBtn = document.getElementById('pay-btn');
if (payBtn) {
  payBtn.addEventListener('click', async () => {
    const nameInput = document.querySelector('input[name="customer-name"]');
    const phoneInput = document.querySelector('input[name="customer-phone"]');
    const emailInput = document.querySelector('input[name="customer-email"]');

    const customer = {
      name: (nameInput?.value || '').trim(),
      phone: (phoneInput?.value || '').trim(),
      email: (emailInput?.value || '').trim()
    };

    if (!customer.name || !customer.phone || !customer.email) {
      alert('Будь ласка, заповніть усі поля покупця.');
      return;
    }

    if (!selectedSeatsIds.length) {
      alert('Будь ласка, оберіть хоча б одне місце.');
      return;
    }

    const totalAmount = window.currentTotalAmount || 0; // бери сумму из твоєї логіки
    const orderId = `${showSlug}-${Date.now()}`;

    try {
      // 1) сохраняем заказ и бронирование в Supabase
      await saveOrderToSupabase(orderId, selectedSeatsIds, totalAmount, customer);

      // 2) создаём инвойс в LiqPay и редиректим
      await createLiqpayInvoice(orderId, totalAmount, customer);
    } catch (err) {
      console.error('pay flow error', err);
      alert('Помилка під час створення рахунку. Спробуйте ще раз або зверніться до адміністратора.');
    }
  });
}
</script>

</body>
</html>
