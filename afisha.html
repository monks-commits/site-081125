<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ê—Ñ—ñ—à–∞ ‚Äî –í–∞—à –ê–¥–º—ñ–Ω</title>
  <link rel="icon" href="data:,">
  <link rel="stylesheet" href="./styles.css" />
</head>
<body>
  <div id="site-header"></div>

  <main class="main">
    <section class="section">
      <h1>–ê—Ñ—ñ—à–∞</h1>

      <!-- –ö–Ω–æ–ø–∫–∏ —Ñ—ñ–ª—å—Ç—Ä—ñ–≤ -->
      <div class="filters" style="margin:12px 0"></div>

      <!-- –°–ø–∏—Å–æ–∫ –ø–æ–¥—ñ–π -->
      <div id="afisha-root" class="grid"></div>
      <p id="afisha-empty" style="display:none">–ü–æ–¥—ñ–π –∑–∞ –≤–∏–±—Ä–∞–Ω–∏–º —Ñ—ñ–ª—å—Ç—Ä–æ–º –ø–æ–∫–∏ –Ω–µ–º–∞—î.</p>
    </section>
  </main>

  <div id="site-footer"></div>
  <script src="/scripts/include.js"></script>

  <script>
    // üîπ –®–ª—è—Ö –¥–æ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ñ–∞–π–ª—É –∑ –∞—Ñ—ñ—à–µ—é
    const DATA_URL = '/data/schedule/afisha.json';

    // üîπ –ù–∞–∑–≤–∏ —Ç–µ–∞—Ç—Ä—ñ–≤ (–∫–ª—é—á—ñ –ø–æ–≤–∏–Ω–Ω—ñ –∑–±—ñ–≥–∞—Ç–∏—Å—è –∑ "theatre" —É JSON)
    const THEATRE_LABELS = {
      shevchenko: '–¢–µ–∞—Ç—Ä —ñ–º. –®–µ–≤—á–µ–Ω–∫–∞',
      academy: '–ê–∫–∞–¥–µ–º—ñ—è —Ä—É—Ö—É',
    };

    const root  = document.getElementById('afisha-root');
    const empty = document.getElementById('afisha-empty');
    const filtersBox = document.querySelector('.filters');

    // –§–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è –¥–∞—Ç–∏
    function fmtDate(iso){
      const d = new Date(iso);
      const fmt = new Intl.DateTimeFormat('uk-UA', { dateStyle:'medium', timeStyle:'short' });
      return isNaN(d) ? '' : fmt.format(d);
    }

    // –°–æ—Ä—Ç—É—î–º–æ –ª–∏—à–µ –º–∞–π–±—É—Ç–Ω—ñ –ø–æ–¥—ñ—ó (–Ω–∞–π–±–ª–∏–∂—á—ñ –ø–µ—Ä—à–∏–º–∏)
    function upcoming(items){
      const now = Date.now() - 5*60*1000; // –Ω–µ–≤–µ–ª–∏–∫–∏–π –±—É—Ñ–µ—Ä —É 5 —Ö–≤–∏–ª–∏–Ω
      return items
        .filter(x => x.date && Date.parse(x.date) >= now)
        .sort((a,b) => Date.parse(a.date) - Date.parse(b.date));
    }

    // –°—Ç–≤–æ—Ä—é—î–º–æ –∫–∞—Ä—Ç–∫—É –ø–æ–¥—ñ—ó
    function card(ev){
  const href = './show.html?slug=' + encodeURIComponent(ev.slug || '');
  const meta = [fmtDate(ev.date), ev.city, ev.hall, THEATRE_LABELS[ev.theatre] || ev.theatre]
    .filter(Boolean)
    .join(' ‚Ä¢ ');

  return `
    <a class="card" href="${href}">
      ${ev.poster ? `<img class="card-poster" loading="lazy" src="${ev.poster}" alt="${ev.title}">` : ''}
      <div class="card-body">
        <h3 class="card-title">${ev.title || ''}</h3>
        <p class="card-meta">${meta}</p>
      </div>
    </a>
  `;
}


    // –§—ñ–ª—å—Ç—Ä–∏ —Ç–µ–∞—Ç—Ä—ñ–≤ (–∫–Ω–æ–ø–∫–∏)
    function renderFilters(theatreKeys, current){
      filtersBox.innerHTML = '';

      const mkBtn = (label, key, isPrimary=false) => {
        const btn = document.createElement('button');
        btn.className = 'btn' + (isPrimary ? '' : ' secondary') + (current === key ? ' active' : '');
        btn.textContent = label;
        btn.addEventListener('click', () => {
          currentFilter = key;
          applyFilter();
          renderFilters(theatreKeys, currentFilter);
          history.replaceState(null, '', '?theatre=' + encodeURIComponent(currentFilter));
        });
        return btn;
      };

      filtersBox.appendChild(mkBtn('–í—Å—ñ –º–∞–π–¥–∞–Ω—á–∏–∫–∏', 'all', true));
      theatreKeys.forEach(k => filtersBox.appendChild(mkBtn(THEATRE_LABELS[k] || k, k)));
    }

    // –û—Å–Ω–æ–≤–Ω–∞ –ª–æ–≥—ñ–∫–∞ —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—ó
    let ALL = [];
    const urlp = new URLSearchParams(location.search);
    let currentFilter = urlp.get('theatre') || 'all';

    function applyFilter(){
      const list = currentFilter === 'all'
        ? ALL
        : ALL.filter(ev => ev.theatre === currentFilter);

      if (!list.length){
        root.innerHTML = '';
        empty.style.display = 'block';
      } else {
        empty.style.display = 'none';
        root.innerHTML = list.map(card).join('');
      }
    }

    // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö –∞—Ñ—ñ—à—ñ
    fetch(DATA_URL, { cache:'no-store' })
      .then(r => { if (!r.ok) throw new Error('Not found: ' + DATA_URL); return r.json(); })
      .then(items => {
        ALL = upcoming(items || []);
        const theatreKeys = Array.from(new Set(ALL.map(x => x.theatre))).filter(Boolean);
        if (!theatreKeys.includes(currentFilter) && currentFilter !== 'all') currentFilter = 'all';
        renderFilters(theatreKeys, currentFilter);
        applyFilter();
      })
      .catch(e => {
        console.error(e);
        empty.textContent = '–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∞—Ñ—ñ—à—É.';
        empty.style.display = 'block';
      });
  </script>
</body>
</html>
