<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Афіша — Ваш Адмін</title>
  <link rel="icon" href="data:,">
  <link rel="stylesheet" href="./styles.css" />
</head>
<body>
  <div id="site-header"></div>

  <main class="main">
    <section class="section">
      <h1>Афіша</h1>
      <div class="filters" style="margin:12px 0"></div>
      <div id="afisha-root" class="grid"></div>
      <p id="afisha-empty" style="display:none">Подій за вибраним фільтром поки немає.</p>
    </section>
  </main>

  <div id="site-footer"></div>
  <script src="/site-081125/scripts/include.js"></script>
  <script>
    const DATA_URL = '/site-081125/data/schedule/afisha.json';

    const THEATRE_LABELS = {
      shevchenko: 'Театр ім. Шевченка',
      akademia: 'Академія руху',
    };

    const root  = document.getElementById('afisha-root');
    const empty = document.getElementById('afisha-empty');
    const filtersBox = document.querySelector('.filters');

    function fmtDate(iso){
      const d = new Date(iso);
      const fmt = new Intl.DateTimeFormat('uk-UA', { dateStyle:'medium', timeStyle:'short' });
      return isNaN(d) ? '' : fmt.format(d);
    }

    function upcoming(items){
      const now = Date.now() - 5*60*1000;
      return items
        .filter(x => x.date && Date.parse(x.date) >= now)
        .sort((a,b) => Date.parse(a.date) - Date.parse(b.date));
    }

    function card(ev){
      const href = './show.html?slug=' + encodeURIComponent(ev.slug || '');
      const meta = [fmtDate(ev.date), ev.city, ev.hall, THEATRE_LABELS[ev.theatre] || ev.theatre].filter(Boolean).join(' • ');
      return `
        <a class="card" href="${href}">
          ${ev.poster ? `<img class="card-poster" loading="lazy" src="${ev.poster}" alt="${ev.title}">` : ''}
          <div class="card-body">
            <h3 class="card-title">${ev.title || ''}</h3>
            <p class="card-meta">${meta}</p>
          </div>
        </a>
      `;
    }

    function renderFilters(theatreKeys, current){
      filtersBox.innerHTML = '';
      const mkBtn = (label, key, isPrimary=false) => {
        const btn = document.createElement('button');
        btn.className = 'btn' + (isPrimary ? '' : ' secondary') + (current === key ? ' active' : '');
        btn.textContent = label;
        btn.addEventListener('click', () => {
          currentFilter = key;
          applyFilter();
          renderFilters(theatreKeys, currentFilter);
          history.replaceState(null,'','?theatre=' + encodeURIComponent(currentFilter));
        });
        return btn;
      };
      filtersBox.appendChild(mkBtn('Всі майданчики','all',true));
      theatreKeys.forEach(k => filtersBox.appendChild(mkBtn(THEATRE_LABELS[k] || k, k)));
    }

    let ALL = [];
    const urlp = new URLSearchParams(location.search);
    let currentFilter = urlp.get('theatre') || 'all';

    function applyFilter(){
      const list = currentFilter === 'all' ? ALL : ALL.filter(ev => ev.theatre === currentFilter);
      if (!list.length){
        root.innerHTML = '';
        empty.style.display = 'block';
      } else {
        empty.style.display = 'none';
        root.innerHTML = list.map(card).join('');
      }
    }

    fetch(DATA_URL, { cache:'no-store' })
      .then(r => { if(!r.ok) throw new Error('Not found: ' + DATA_URL); return r.json(); })
      .then(items => {
        ALL = upcoming(items || []);
        const theatreKeys = Array.from(new Set(ALL.map(x => x.theatre))).filter(Boolean);
        if (!theatreKeys.includes(currentFilter) && currentFilter !== 'all') currentFilter = 'all';
        renderFilters(theatreKeys, currentFilter);
        applyFilter();
      })
      .catch(e => {
        console.error(e);
        empty.textContent = 'Не вдалося завантажити афішу.';
        empty.style.display = 'block';
      });
  </script>
</body>
</html>
