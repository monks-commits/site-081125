<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Афіша — Ваш Адмін</title>

  <!-- прибираємо 404 favicon -->
  <link rel="icon" href="data:,">

  <link rel="stylesheet" href="./styles.css" />
</head>
<body>
  <div id="site-header"></div>
  <script type="module" src="./scripts/include.js"></script>

  <main class="main">
    <section class="section">
      <h1>Афіша</h1>

      <!-- Кнопки фільтра з'являться тут динамічно -->
      <div class="filters" style="margin:12px 0"></div>

      <!-- Список подій -->
      <div id="afisha-root" class="grid"></div>
      <p id="afisha-empty" style="display:none">Подій за вибраним фільтром поки немає.</p>
    </section>
  </main>

  <div id="site-footer"></div>

  <!-- ЄДИНА АФІША ДЛЯ ВСІХ МАЙДАНЧИКІВ + ФІЛЬТР -->
  <script>
    // Джерело даних — один спільний файл з найближчими подіями
    const DATA_URL = './data/schedule/afisha.json';

    // Людські назви майданчиків для кнопок
    const THEATRE_LABELS = {
      shevchenko: 'Театр ім. Шевченка',
      akademia: 'Академія руху'
      // opera: 'Опера', filarmonia: 'Філармонія', ... — додамо пізніше
    };

    const root  = document.getElementById('afisha-root');
    const empty = document.getElementById('afisha-empty');
    const filtersBox = document.querySelector('.filters');

    function fmtDate(iso) {
      const d = new Date(iso);
      const fmt = new Intl.DateTimeFormat('uk-UA', { dateStyle: 'medium', timeStyle: 'short' });
      return fmt.format(d);
    }

    // Тільки майбутнє, від ближчих до дальших
    function upcoming(items) {
      const now = Date.now() - 5 * 60 * 1000; // буфер 5 хв
      return items
        .filter(x => x.date && Date.parse(x.date) >= now)
        .sort((a,b) => Date.parse(a.date) - Date.parse(b.date));
    }

    function card(ev) {
      const href = './show.html' + (ev.slug ? ('?slug=' + encodeURIComponent(ev.slug)) : '');
      const meta = [fmtDate(ev.date), ev.city, ev.hall, THEATRE_LABELS[ev.theatre] || ev.theatre]
        .filter(Boolean).join(' • ');
      return `
        <a class="card" href="${href}">
          ${ev.poster ? `<img class="card-poster" loading="lazy" src="${ev.poster}" alt="${ev.title}">` : ''}
          <div class="card-body">
            <h3 class="card-title">${ev.title || ''}</h3>
            <p class="card-meta">${meta}</p>
          </div>
        </a>
      `;
    }

    // Кнопки фільтра за майданчиками
    function renderFilters(theatreKeys, current) {
      filtersBox.innerHTML = '';

      const mkBtn = (label, key, isPrimary=false) => {
        const btn = document.createElement('button');
        btn.className = 'btn' + (isPrimary ? '' : ' secondary') + (current === key ? ' active' : '');
        btn.textContent = label;
        btn.addEventListener('click', () => {
          currentFilter = key;
          applyFilter();
          renderFilters(theatreKeys, currentFilter);
        });
        return btn;
      };

      filtersBox.appendChild(mkBtn('Всі майданчики', 'all', true));
      theatreKeys.forEach(k => filtersBox.appendChild(mkBtn(THEATRE_LABELS[k] || k, k)));
    }

    let ALL = [];
    let currentFilter = 'all';
// Якщо в URL задано ?theatre=..., встановимо фільтр одразу
const urlTheatre = new URLSearchParams(location.search).get('theatre');
if (urlTheatre) currentFilter = urlTheatre;

    
    function applyFilter() {
      const list = currentFilter === 'all' ? ALL : ALL.filter(ev => ev.theatre === currentFilter);
      if (!list.length) {
        root.innerHTML = '';
        empty.style.display = 'block';
      } else {
        empty.style.display = 'none';
        root.innerHTML = list.map(card).join('');
      }
    }

    fetch(DATA_URL)
      .then(r => { if (!r.ok) throw new Error('Not found: ' + DATA_URL); return r.json(); })
      .then(items => {
        ALL = upcoming(items);
        const theatreKeys = Array.from(new Set(ALL.map(x => x.theatre))).filter(Boolean);
        renderFilters(theatreKeys, currentFilter);
        applyFilter();
      })
      .catch(err => {
        console.error(err);
        empty.textContent = 'Не вдалося завантажити афішу.';
        empty.style.display = 'block';
      });
  </script>
</body>
</html>
