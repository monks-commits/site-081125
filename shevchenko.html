<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Театр ім. Шевченка — афіша</title>
  <link rel="icon" href="data:,">
  <link rel="stylesheet" href="./styles.css" />
  <style>
    .show-header{display:flex;gap:20px;align-items:flex-start;margin:12px 0 24px}
    .show-header img{width:180px;height:auto;border-radius:12px;display:block}
    .show-header h1{margin:0}
    .muted{color:#6b7280}
    .hall-wrap{display:flex;gap:24px;align-items:flex-start}
    .legend{min-width:200px}
    .legend .badge{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px;margin-right:8px}
    .badge.free{background:#e0f2fe;border:1px solid #93c5fd}
    .badge.busy{background:#ffe4e6;border:1px solid #fb7185}
    .badge.sel{background:#dcfce7;border:1px solid #86efac}
    .screen{background:#e5e7eb;border:1px dashed #9ca3af;padding:6px 10px;border-radius:8px;display:inline-block;margin-bottom:8px}
    .rows{display:flex;flex-direction:column;gap:8px}
    .row{display:flex;align-items:center;gap:8px}
    .row-label{width:56px;text-align:right;color:#6b7280}
    .seat{min-width:36px;min-height:36px;border-radius:8px;border:1px solid #cbd5e1;display:flex;align-items:center;justify-content:center;cursor:pointer;user-select:none;background:#fff}
    .seat.free:hover{box-shadow:0 0 0 2px #93c5fd}
    .seat.busy{background:#fee2e2;border-color:#fca5a5;color:#9ca3af;cursor:not-allowed}
    .seat.sel{background:#dcfce7;border-color:#86efac}
    .panel{margin-top:16px;padding:12px;border:1px solid #e5e7eb;border-radius:12px;background:#fafafa}
    .grid-2{display:grid;grid-template-columns:1fr auto;gap:12px;align-items:center}
    .btn.secondary{background:#f3f4f6;color:#111827}
  </style>
</head>
<body>
  <div id="site-header"></div>
  <script type="module" src="./scripts/include.js"></script>

  <main class="main">
    <section class="section">
      <div class="show-header">
        <img id="poster" alt="" style="display:none">
        <div>
          <div class="muted">Кривий Ріг • Театр ім. Шевченка</div>
          <h1 id="title">Афіша</h1>
          <div id="subtitle" class="muted" style="margin:6px 0 10px"></div>
          <div id="meta" class="muted"></div>
        </div>
      </div>

      <div class="hall-wrap">
        <aside class="legend">
          <div class="screen">Сцена</div>
          <div style="margin:10px 0 4px">Легенда:</div>
          <div style="display:flex;flex-direction:column;gap:6px">
            <span><span class="badge free">Вільно</span> можна обирати</span>
            <span><span class="badge busy">Зайнято</span> недоступно</span>
            <span><span class="badge sel">Моє місце</span> у виборі</span>
          </div>

          <div class="panel" id="summary">
            <div class="grid-2">
              <div>Кількість квитків</div><div id="cnt"><b>0</b></div>
              <div>Сума до оплати</div><div id="sum"><b>0</b> грн</div>
            </div>
            <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
              <button id="clearBtn" class="btn secondary" type="button">Скинути вибір</button>
              <button id="goBtn" class="btn" type="button">Оформити замовлення</button>
            </div>
          </div>
        </aside>

        <div style="flex:1">
          <div id="rows" class="rows" aria-live="polite"></div>
          <p id="err" style="display:none;color:#b00020;margin-top:10px">Не вдалося завантажити схему зали.</p>
        </div>
      </div>
    </section>
  </main>

  <div id="site-footer"></div>

  <script>
    const qs = new URLSearchParams(location.search);
    const showSlug = qs.get('show');               // shevchenko/za-dvoma-zaytsiamy
    const SHOW_DATA = showSlug ? `./data/shows/${showSlug}.json` : null;
    const HALL_DATA_URL = './data/shevchenko.json';

    const $poster = document.getElementById('poster');
    const $title = document.getElementById('title');
    const $subtitle = document.getElementById('subtitle');
    const $meta = document.getElementById('meta');
    const $rows = document.getElementById('rows');
    const $err = document.getElementById('err');
    const $cnt = document.getElementById('cnt');
    const $sum = document.getElementById('sum');
    const $clear = document.getElementById('clearBtn');
    const $go = document.getElementById('goBtn');

    let selection = new Map();
    function refreshPanel(){
      const items = [...selection.values()];
      const count = items.length;
      const total = items.reduce((a,b)=>a + (Number(b.price)||0), 0);
      $cnt.innerHTML = '<b>'+count+'</b>';
      $sum.innerHTML = '<b>'+total.toLocaleString('uk-UA')+'</b> грн';
    }

    (function loadShow(){
      if (!SHOW_DATA) return;
      fetch(SHOW_DATA)
        .then(r=>{ if(!r.ok) throw new Error('no show'); return r.json(); })
        .then(s=>{
          if (s.poster) { $poster.src = s.poster; $poster.alt = s.title || ''; $poster.style.display='block'; }
          if (s.title) $title.textContent = s.title;
          if (s.subtitle) $subtitle.textContent = s.subtitle;
          const bits = [];
          if (s.director) bits.push(`Режисер: ${s.director}`);
          if (s.duration) bits.push(`Тривалість: ${s.duration}`);
          if (s.stage) bits.push(`Сцена: ${s.stage}`);
          $meta.textContent = bits.join(' • ');
        })
        .catch(()=>{});
    })();

    // ====== УНІВЕРСАЛЬНЕ ПРИВЕДЕННЯ ФОРМАТУ СХЕМИ ======
    function coerceSeatsArray(r){
      // Можливі варіанти: r.seats / r.places / r.items / r.list
      let arr = r.seats || r.places || r.items || r.list || [];
      // Якщо масив чисел: [1,2,3] -> об'єкти
      if (Array.isArray(arr) && arr.length && typeof arr[0] === 'number'){
        arr = arr.map(n => ({ seat: n, price: Number(r.price||0) }));
      }
      return arr;
    }

    function normalizeRows(data){
      // 1) масив рядків
      if (Array.isArray(data)) {
        return data.map(r => ({
          row: r.row ?? r.name ?? r.number ?? r.index ?? '',
          seats: coerceSeatsArray(r)
        }));
      }
      // 2) об'єкт з rows
      if (data && Array.isArray(data.rows)) {
        return data.rows.map(r => ({
          row: r.row ?? r.name ?? r.number ?? r.index ?? '',
          seats: coerceSeatsArray(r)
        }));
      }
      // 3) інші екзотичні формати (наприклад, об'єкт { '1':[...], '2':[...]} )
      if (data && typeof data === 'object'){
        const maybeRows = [];
        for (const [k,v] of Object.entries(data)){
          if (Array.isArray(v)) {
            maybeRows.push({
              row: isNaN(+k) ? k : Number(k),
              seats: Array.isArray(v) && typeof v[0] === 'number'
                ? v.map(n => ({ seat:n, price:0 }))
                : v
            });
          }
        }
        if (maybeRows.length) return maybeRows;
      }
      throw new Error('unknown hall shape');
    }

    function renderHall(rows){
      $rows.innerHTML = '';
      rows.forEach(r=>{
        const rowEl = document.createElement('div');
        rowEl.className = 'row';

        const lab = document.createElement('div');
        lab.className = 'row-label';
        lab.textContent = `Ряд ${r.row ?? ''}`;
        rowEl.appendChild(lab);

        const seats = r.seats || [];
        seats.forEach(s=>{
          const num = s.seat ?? s.number ?? s.n ?? s.place ?? '';
          const price = Number(s.price || s.cost || s.p || 0);
          const key = s.id || `${r.row}-${num}`;
          const status = (s.status || s.state || '').toLowerCase();

          const seatEl = document.createElement('div');
          seatEl.className = 'seat ' + (status === 'busy' || status === 'taken' ? 'busy' : 'free');
          seatEl.textContent = num;
          seatEl.title = `${key}${price ? ' • ' + price + ' грн' : ''}`;

          const payload = { id:key, row:r.row ?? '', seat:num, price, raw:s };

          if (selection.has(key)) seatEl.classList.add('sel');

          seatEl.addEventListener('click', ()=>{
            if (seatEl.classList.contains('busy')) return;
            if (seatEl.classList.contains('sel')) {
              seatEl.classList.remove('sel');
              selection.delete(key);
            } else {
              seatEl.classList.add('sel');
              selection.set(key, payload);
            }
            refreshPanel();
          });

          rowEl.appendChild(seatEl);
        });

        $rows.appendChild(rowEl);
      });

      refreshPanel();
    }

    fetch(HALL_DATA_URL)
      .then(r=>{ if(!r.ok) throw new Error('no hall'); return r.json(); })
      .then(data=>{
        const rows = normalizeRows(data);
        console.log('Shevchenko hall data loaded (normalized):', rows);
        renderHall(rows);
      })
      .catch(err=>{
        console.error(err);
        $err.style.display = 'block';
      });

    $clear.addEventListener('click', ()=>{
      selection.clear();
      document.querySelectorAll('.seat.sel').forEach(el=>el.classList.remove('sel'));
      refreshPanel();
    });

    $go.addEventListener('click', ()=>{
      if (selection.size === 0) {
        alert('Будь ласка, оберіть хоча б одне місце.');
        return;
      }
      const items = [...selection.values()];
      const total = items.reduce((a,b)=>a + (Number(b.price)||0), 0);
      sessionStorage.setItem('order_draft', JSON.stringify({
        show: showSlug || 'shevchenko/unknown',
        theatre: 'shevchenko',
        items,
        total
      }));
      location.href = './order.html';
    });
  </script>
</body>
</html>
