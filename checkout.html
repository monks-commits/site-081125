<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Підтвердження та оплата — Ваш Адмін</title>
  <link rel="stylesheet" href="/styles.css" />
  <style>
    body{background:#f4f4f6}
    .page{max-width:1100px;margin:0 auto;padding:24px 16px 60px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:18px 18px 20px;margin-bottom:18px}
    .title{font-weight:700;font-size:18px;margin:0 0 8px}
    .meta{color:#64748b}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media(max-width:768px){.grid2{grid-template-columns:1fr}}
    label{display:flex;flex-direction:column;gap:6px;font-weight:600}
    input{height:44px;border:1px solid #d1d5db;border-radius:10px;padding:0 12px;font-size:15px}
    .btn{background:#155EEF;color:#fff;border:none;border-radius:999px;padding:11px 22px;font-weight:600;cursor:pointer}
    .btn:disabled{background:#95b5ff;cursor:not-allowed}
    .error{display:none;background:#fee2e2;border:1px solid #ef4444;border-radius:10px;color:#7f1d1d;padding:10px 12px;margin-bottom:10px}
  </style>
  <!-- supabase-js -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
  <div id="site-header"></div>

  <main class="page">
    <h1 style="margin-bottom:16px">Підтвердження та оплата</h1>

    <!-- Резюме замовлення -->
    <section class="card">
      <p class="title">Вистава</p>
      <p id="order-show" class="meta">—</p>
      <p id="order-seats" class="meta" style="margin-top:4px">Місця: —</p>
      <p id="order-amount" class="meta" style="margin-top:4px">Сума до сплати: — грн</p>
      <p class="meta" style="margin-top:6px">Номер замовлення: <span id="order-id">—</span></p>
    </section>

    <!-- Дані покупця -->
    <section class="card">
      <p class="title">Дані покупця</p>
      <div class="grid2">
        <label>Ім’я та прізвище
          <input id="f-name" placeholder="Ваше ім’я" />
        </label>
        <label>Телефон
          <input id="f-phone" placeholder="+380..." />
        </label>
      </div>
      <div style="margin-top:12px">
        <label>Електронна пошта (сюди прийде квиток)
          <input id="f-email" type="email" placeholder="you@example.com" />
        </label>
      </div>
    </section>

    <!-- Оплата -->
    <section class="card">
      <p class="title">Оплата онлайн</p>
      <p class="meta" style="margin-bottom:10px">Після оплати ви повернетеся на сайт. Ми зафіксуємо оплату та надішлемо ваші квитки.</p>
      <div id="err" class="error"></div>
      <button id="pay-btn" class="btn">Оплатити через LiqPay</button>
    </section>
  </main>

  <div id="site-footer"></div>
  <script type="module" src="/scripts/include.js"></script>

  <script>
    // --- Константы проекта (без секретов) ---
    const SUPABASE_URL     = "https://yqhzekifwxotizsmaeaf.supabase.co";
    const SUPABASE_ANON    = "sb_publishable_z1h_G-7K7HGCjOUtRZpI9Q_o1m9inZM";
    const LIQPAY_SIGN_URL  = "https://yqhzekifwxotizsmaeaf.functions.supabase.co/liqpay-sign";

    const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

    // --- Параметры из адресной строки ---
    const qs = new URLSearchParams(location.search);
    const show     = qs.get("show") || "";
    const seats    = (qs.get("seats") || "").split(",").filter(Boolean);
    const amount   = Number(qs.get("amount") || 0);
    const order_id = qs.get("order_id") || ("ORD-" + Date.now());

    // Подставляем
    document.getElementById("order-show").textContent   = show.replace("/", " — ");
    document.getElementById("order-seats").textContent  = "Місця: " + (seats.length ? seats.join(", ") : "—");
    document.getElementById("order-amount").textContent = "Сума до сплати: " + amount + " грн";
    document.getElementById("order-id").textContent     = order_id;

    // Автоподстановка ПІБ/тел/емейл (без encodeURIComponent!)
    const fName  = document.getElementById("f-name");
    const fPhone = document.getElementById("f-phone");
    const fEmail = document.getElementById("f-email");
    if (qs.get("name"))  fName.value  = qs.get("name");
    if (qs.get("phone")) fPhone.value = qs.get("phone");
    if (qs.get("email")) fEmail.value = qs.get("email");

    // UI
    const errBox = document.getElementById("err");
    const payBtn = document.getElementById("pay-btn");

    function showErr(msg){
      errBox.textContent = msg;
      errBox.style.display = "block";
    }
    function hideErr(){ errBox.style.display = "none"; }

    function validateBuyer(){
      const n = fName.value.trim();
      const p = fPhone.value.trim();
      const e = fEmail.value.trim();
      if (!n || !p || !e) return "Будь ласка, заповніть ПІБ, телефон та email.";
      // очень базовая проверка email
      if (!/@/.test(e)) return "Перевірте email.";
      return "";
    }

    async function saveOrder(){
      const buyer_name  = fName.value.trim();
      const buyer_phone = fPhone.value.trim();
      const buyer_email = fEmail.value.trim();

      const { error } = await supa
        .from("orders")
        .insert([{
          order_id,
          show_slug: show,
          seats,
          amount,
          buyer_name,
          buyer_phone,
          buyer_email,
          status: "pending"
        }]);

      if (error){
        console.error(error);
        throw new Error("Не вдалося зберегти замовлення. Спробуйте ще раз.");
      }
    }

    async function goLiqpay(){
      const payload = {
        order_id,
        description: `Квитки ${show}`,
        amount: amount,
        sender_phone: fPhone.value.trim(),
        email: fEmail.value.trim(),
      };

      const r = await fetch(LIQPAY_SIGN_URL, {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });
      if (!r.ok){
        const txt = await r.text();
        console.error("liqpay-sign:", txt);
        throw new Error("Не вдалося підготувати оплату (LiqPay).");
      }
      const { data, signature } = await r.json();

      const form = document.createElement("form");
      form.method = "POST";
      form.action = "https://www.liqpay.ua/api/3/checkout";

      const f1 = document.createElement("input");
      f1.type = "hidden"; f1.name = "data"; f1.value = data;

      const f2 = document.createElement("input");
      f2.type = "hidden"; f2.name = "signature"; f2.value = signature;

      form.appendChild(f1); form.appendChild(f2);
      document.body.appendChild(form);
      form.submit();
    }

    payBtn.addEventListener("click", async ()=>{
      hideErr();
      const v = validateBuyer();
      if (v){ showErr(v); return; }

      try{
        payBtn.disabled = true;
        await saveOrder();
        await goLiqpay();
      }catch(e){
        showErr(e.message || "Сталася помилка.");
        payBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
