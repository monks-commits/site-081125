<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Підтвердження та оплата — Ваш Адмін</title>
  <link rel="icon" href="data:,">
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <div id="site-header"></div>

  <main class="main" style="max-width:1000px;margin:0 auto;padding:16px">
    <nav style="margin:8px 0 16px;">
      <a href="/afisha.html">Афіша</a> ·
      <a href="/theatres.html">Театри</a> ·
      <a href="/contacts.html">Контакти</a>
    </nav>

    <section class="section" style="background:#fff;border-radius:14px;padding:18px;margin-bottom:18px">
      <h1 style="margin:0 0 14px">Підтвердження та оплата</h1>
      <div id="order-summary"></div>
    </section>

    <section class="section" style="background:#fff;border-radius:14px;padding:18px">
      <h2 style="margin:0 0 12px">Дані покупця</h2>

      <div class="form-row" style="display:flex;gap:12px;flex-wrap:wrap">
        <input
          id="name"
          class="input"
          placeholder="Ім’я та прізвище"
          style="flex:1 1 280px;height:44px;padding:0 12px;border:1px solid #d0d5dd;border-radius:10px"
        >
        <input
          id="phone"
          class="input"
          placeholder="+380..."
          inputmode="tel"
          style="flex:1 1 220px;height:44px;padding:0 12px;border:1px solid #d0d5dd;border-radius:10px"
        >
      </div>

      <input
        id="email"
        class="input"
        placeholder="Електронна пошта (куди прийде квиток)"
        inputmode="email"
        style="margin-top:12px;width:100%;height:44px;padding:0 12px;border:1px solid #d0d5dd;border-radius:10px"
      >

      <p id="pay-error" style="color:#b91c1c;margin:12px 0 0;display:none"></p>

      <button id="pay" class="btn primary" style="margin-top:14px">Оплатити через LiqPay</button>
      <p class="muted" style="margin-top:10px">
        Після оплати ви повернетеся на сайт, а ми зафіксуємо оплату та надішлемо ваші квитки.
      </p>
    </section>
  </main>

  <div id="site-footer"></div>

  <script src="/scripts/include.js"></script>
  <script>
    // ---------- читання параметрів з URL ----------
    const qp = new URLSearchParams(location.search);
    const showSlug = qp.get("show") || "";
    const seats    = (qp.get("seats") || "").split(",").filter(Boolean);
    const amount   = Number(qp.get("amount") || "0");
    const orderId  = qp.get("order_id") || ("SHEV-" + Date.now());

    // попередньо заповнимо поля покупця (якщо передані)
    const nameInitial  = qp.get("name")  || "";
    const phoneInitial = qp.get("phone") || "";
    const emailInitial = qp.get("email") || "";

    // показ підсумку
    const summary = document.getElementById("order-summary");
    const niceSeats = seats.length ? seats.join(", ") : "—";
    summary.innerHTML = `
      <div class="card" style="border:1px solid #e5e7eb;border-radius:12px;padding:14px">
        <p><b>Вистава:</b> ${showSlug || "—"}</p>
        <p><b>Місця:</b> ${niceSeats}</p>
        <p><b>Сума до сплати:</b> ${amount} грн</p>
        <p><b>Номер замовлення:</b> ${orderId}</p>
      </div>
    `;

    // встановимо значення полів
    document.getElementById("name").value  = nameInitial;
    document.getElementById("phone").value = phoneInitial;
    document.getElementById("email").value = emailInitial;

    // ---------- параметри Supabase: ТОТ ПРОЄКТ, ДЕ ЛЕЖИТЬ liqpay-init ----------
    const SUPABASE_URL = "https://yqhzekifwxotizsmaeaf.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlxaHpla2lmd3hvdGl6c21hZWFmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEyMzQyNjgsImV4cCI6MjA3NjgxMDI2OH0.lUoppCppKZisZdyOrreCov_-xEOCvGuwxd28XZY4O_k";

    async function initPayment(payload) {
      const res = await fetch(`${SUPABASE_URL}/functions/v1/liqpay-init`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${SUPABASE_ANON_KEY}`,
          "apikey": SUPABASE_ANON_KEY,
        },
        body: JSON.stringify(payload),
      });

      let data = null;
      try { data = await res.json(); } catch (_) {}

      if (!res.ok) {
        const msg = (data && (data.message || data.error)) || `HTTP ${res.status}`;
        throw new Error(msg);
      }
      return data;
    }

    // ---------- сабміт ----------
    const btn = document.getElementById("pay");
    const err = document.getElementById("pay-error");

    btn.addEventListener("click", async () => {
      err.style.display = "none";
      err.textContent = "";
      btn.disabled = true;

      // мінімальна валідація
      if (!amount || !seats.length || !showSlug) {
        err.textContent = "Некоректні параметри замовлення.";
        err.style.display = "block";
        btn.disabled = false;
        return;
      }

      const payload = {
  order_id: orderId,
  amount,
  currency: "UAH",
  show_slug: showSlug,
  seats,
  buyer: {
    name:  document.getElementById("name").value.trim(),
    phone: document.getElementById("phone").value.trim(),
    email: document.getElementById("email").value.trim(),
  },
  // Новое:
  result_url: `${location.origin}/thanks.html`,
  // Серверний callback — Edge-функція (її код ми поправимо окремо)
  server_url: `https://yqhzekifwxotizsmaeaf.supabase.co/functions/v1/liqpay-callback`,
};


      try {
        const resp = await initPayment(payload);

        // варіант 1: backend віддає готовий редірект
        if (resp.redirect) {
          location.href = resp.redirect;
          return;
        }

        // варіант 2: класичний LiqPay (data + signature)
        if (resp.data && resp.signature) {
          const form = document.createElement("form");
          form.method = "POST";
          form.action = "https://www.liqpay.ua/api/3/checkout";
          form.style.display = "none";

          const f1 = document.createElement("input");
          f1.name = "data";
          f1.value = resp.data;
          form.appendChild(f1);

          const f2 = document.createElement("input");
          f2.name = "signature";
          f2.value = resp.signature;
          form.appendChild(f2);

          document.body.appendChild(form);
          form.submit();
          return;
        }

        throw new Error("Невідомий формат відповіді від liqpay-init");
      } catch (e) {
        err.textContent = "Помилка ініціалізації оплати: " + e.message;
        err.style.display = "block";
        btn.disabled = false;
      }
    });
  </script>
</body>
</html>
