<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Підтвердження та оплата — Ваш Адмін</title>
  <link rel="stylesheet" href="/site-081125/styles.css" />
  <style>
    body { background:#f4f4f6; }
    main { max-width:1100px; margin:0 auto; padding:24px 16px 60px; }
    .card { background:#fff; border-radius:14px; padding:22px; margin-bottom:20px; }
    .primary-btn{background:#155EEF;color:#fff;border:none;border-radius:999px;padding:12px 24px;font-weight:600;cursor:pointer}
    .primary-btn:disabled{background:#95b5ff;cursor:not-allowed}
    .muted{color:#64748b}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .field{flex:1 1 280px;display:flex;flex-direction:column;gap:6px}
    .field input{height:44px;border:1px solid #d0d5dd;border-radius:10px;padding:0 12px;font-size:15px}
    #err{color:#b91c1c;margin-top:10px}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div id="site-header"></div>

  <main>
    <h1>Підтвердження та оплата</h1>

    <div class="card">
      <div id="summary"></div>
    </div>

    <div class="card">
      <h2>Дані покупця</h2>
      <div class="row">
        <div class="field">
          <label for="name">Ім’я та прізвище</label>
          <input id="name" />
        </div>
        <div class="field">
          <label for="phone">Телефон</label>
          <input id="phone" inputmode="tel" />
        </div>
      </div>
      <div class="field" style="margin-top:10px">
        <label for="email">Електронна пошта (куди прийде квиток)</label>
        <input id="email" inputmode="email" />
      </div>

      <p id="err"></p>

      <button id="pay" class="primary-btn" style="margin-top:14px;">Оплатити через LiqPay</button>
      <p class="muted" style="margin-top:8px">Після оплати ви повернетесь на сайт, а ми зафіксуємо оплату та надішлемо ваші квитки.</p>
    </div>
  </main>

  <div id="site-footer"></div>
  <script src="/site-081125/scripts/include.js"></script>
  <script>
    // ---------- Параметри замовлення з URL ----------
    const p = new URLSearchParams(location.search);
    const show      = p.get('show') || '';
    const seats     = (p.get('seats') || '').split(',').filter(Boolean);
    const amount    = Number(p.get('amount') || '0');
    const orderId   = p.get('order_id') || ('ORD-' + Date.now());
    const name      = p.get('name')  || '';
    const phone     = p.get('phone') || '';
    const email     = p.get('email') || '';

    // Підставимо у форму
    document.getElementById('name').value  = name;
    document.getElementById('phone').value = phone;
    document.getElementById('email').value = email;

    // Рендер підсумку
    document.getElementById('summary').innerHTML = `
      <p><strong>Вистава:</strong> ${show || '—'}</p>
      <p><strong>Місця:</strong> ${seats.length ? seats.join(', ') : '—'}</p>
      <p><strong>Сума до сплати:</strong> ${amount} грн</p>
      <p><strong>Номер замовлення:</strong> ${orderId}</p>
    `;

    // ---------- Оплата через Edge Function liqpay-init ----------
    const SUPABASE_URL = "https://yqhzekifwxotizsmaeaf.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_z1h_G-7K7HGCjOUtRZpI9Q_o1m9inZM";
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const errEl = document.getElementById('err');
    document.getElementById('pay').addEventListener('click', async () => {
      errEl.textContent = '';
      try {
        const payload = {
          order_id: orderId,
          amount: amount,
          currency: "UAH",
          description: `Квитки: ${show} — ${seats.join(', ')}`,
          customer: { name: document.getElementById('name').value.trim(),
                      phone: document.getElementById('phone').value.trim(),
                      email: document.getElementById('email').value.trim() },
          result_url: location.origin + "/site-081125/thankyou.html"
        };

        const res = await fetch(SUPABASE_URL + "/functions/v1/liqpay-init", {
          method: "POST",
          headers: { "Content-Type": "application/json", "apikey": SUPABASE_ANON_KEY },
          body: JSON.stringify(payload)
        });

        if (!res.ok) throw new Error("liqpay-init " + res.status);
        const data = await res.json(); // { action, data, signature }
        if (!data || !data.action || !data.data || !data.signature) {
          throw new Error("Некоректна відповідь liqpay-init");
        }

        // Збираємо та відправляємо форму на LiqPay
        const form = document.createElement('form');
        form.action = data.action;
        form.method = 'POST';
        form.style.display = 'none';

        const f1 = document.createElement('input');
        f1.name = 'data';      f1.value = data.data;
        const f2 = document.createElement('input');
        f2.name = 'signature'; f2.value = data.signature;

        form.appendChild(f1); form.appendChild(f2);
        document.body.appendChild(form);
        form.submit();
      } catch (e) {
        errEl.textContent = 'Помилка ініціалізації оплати: ' + e.message;
      }
    });
  </script>
</body>
</html>
